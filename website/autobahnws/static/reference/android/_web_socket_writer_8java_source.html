<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>

<title>src/de/tavendo/autobahn/WebSocketWriter.java Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

<script>    $(document).ready(function() {       var frame = $('#thisframe', window.parent.document);       frame.height(document.body.offsetHeight + 100);    }); </script> </head>
<body>
<div id="top"><!-- do not remove this div! -->


<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">src/de/tavendo/autobahn/WebSocketWriter.java</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/******************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> *  Copyright 2011-2012 Tavendo GmbH</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00006"></a>00006 <span class="comment"> *  you may not use this file except in compliance with the License.</span>
<a name="l00007"></a>00007 <span class="comment"> *  You may obtain a copy of the License at</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> *  Unless required by applicable law or agreed to in writing, software</span>
<a name="l00012"></a>00012 <span class="comment"> *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00013"></a>00013 <span class="comment"> *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00014"></a>00014 <span class="comment"> *  See the License for the specific language governing permissions and</span>
<a name="l00015"></a>00015 <span class="comment"> *  limitations under the License.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> ******************************************************************************/</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="keyword">package </span>de.tavendo.autobahn;
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="keyword">import</span> java.io.IOException;
<a name="l00022"></a>00022 <span class="keyword">import</span> java.nio.channels.SocketChannel;
<a name="l00023"></a>00023 <span class="keyword">import</span> java.util.Random;
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="keyword">import</span> android.os.Handler;
<a name="l00026"></a>00026 <span class="keyword">import</span> android.os.Looper;
<a name="l00027"></a>00027 <span class="keyword">import</span> android.os.Message;
<a name="l00028"></a>00028 <span class="keyword">import</span> android.util.Base64;
<a name="l00029"></a>00029 <span class="keyword">import</span> android.util.Log;
<a name="l00030"></a>00030 
<a name="l00039"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html">00039</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html" title="WebSocket writer, the sending leg of a WebSockets connection.">WebSocketWriter</a> <span class="keyword">extends</span> Handler {
<a name="l00040"></a>00040 
<a name="l00041"></a>00041    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">boolean</span> DEBUG = <span class="keyword">true</span>;
<a name="l00042"></a>00042    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html" title="WebSocket writer, the sending leg of a WebSockets connection.">WebSocketWriter</a>.class.getName();
<a name="l00043"></a>00043 
<a name="l00045"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9d54d55b5fcc178a6dcb1614bde71600">00045</a>    <span class="keyword">private</span> <span class="keyword">final</span> Random <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9d54d55b5fcc178a6dcb1614bde71600" title="Random number generator for handshake key and frame mask generation.">mRng</a> = <span class="keyword">new</span> Random();
<a name="l00046"></a>00046 
<a name="l00048"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#abe189259b7812c7ae5aa9ef18f1090f6">00048</a>    <span class="keyword">private</span> <span class="keyword">final</span> Handler <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#abe189259b7812c7ae5aa9ef18f1090f6" title="Connection master.">mMaster</a>;
<a name="l00049"></a>00049 
<a name="l00051"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ab4c9be3a28d3cff500f958523e3f0547">00051</a>    <span class="keyword">private</span> <span class="keyword">final</span> Looper <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ab4c9be3a28d3cff500f958523e3f0547" title="Message looper this object is running on.">mLooper</a>;
<a name="l00052"></a>00052 
<a name="l00054"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9cf3886736afe363dc171afd7936baf7">00054</a>    <span class="keyword">private</span> <span class="keyword">final</span> SocketChannel <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9cf3886736afe363dc171afd7936baf7" title="The NIO socket channel created on foreground thread.">mSocket</a>;
<a name="l00055"></a>00055 
<a name="l00057"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ae1cdc80e31f3c49f282bdb021e58a4a3">00057</a>    <span class="keyword">private</span> <span class="keyword">final</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_options.html" title="WebSockets connection options.">WebSocketOptions</a> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ae1cdc80e31f3c49f282bdb021e58a4a3" title="WebSockets options.">mOptions</a>;
<a name="l00058"></a>00058 
<a name="l00060"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903">00060</a>    <span class="keyword">private</span> <span class="keyword">final</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html" title="OutputStream wrapping a ByteBuffer.">ByteBufferOutputStream</a> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>;
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 
<a name="l00072"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#af906016eebc55692a7fb7db8ec8f7f91">00072</a>    <span class="keyword">public</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#af906016eebc55692a7fb7db8ec8f7f91" title="Create new WebSockets background writer.">WebSocketWriter</a>(Looper looper, Handler master, SocketChannel socket, <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_options.html" title="WebSockets connection options.">WebSocketOptions</a> options) {
<a name="l00073"></a>00073 
<a name="l00074"></a>00074       super(looper);
<a name="l00075"></a>00075 
<a name="l00076"></a>00076       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ab4c9be3a28d3cff500f958523e3f0547" title="Message looper this object is running on.">mLooper</a> = looper;
<a name="l00077"></a>00077       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#abe189259b7812c7ae5aa9ef18f1090f6" title="Connection master.">mMaster</a> = master;
<a name="l00078"></a>00078       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9cf3886736afe363dc171afd7936baf7" title="The NIO socket channel created on foreground thread.">mSocket</a> = socket;
<a name="l00079"></a>00079       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ae1cdc80e31f3c49f282bdb021e58a4a3" title="WebSockets options.">mOptions</a> = options;
<a name="l00080"></a>00080       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a> = <span class="keyword">new</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html" title="OutputStream wrapping a ByteBuffer.">ByteBufferOutputStream</a>(options.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_options.html#a4265d7e6a38d41c019a9226dc88c1062" title="Get maxium frame payload size that will be accepted when receiving.">getMaxFramePayloadSize</a>() + 14, 4*64*1024);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082       <span class="keywordflow">if</span> (DEBUG) Log.d(TAG, <span class="stringliteral">&quot;created&quot;</span>);
<a name="l00083"></a>00083    }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 
<a name="l00096"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac0feb6c35559c75e4e68dd0e2c3ca865">00096</a>    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac0feb6c35559c75e4e68dd0e2c3ca865" title="Call this from the foreground (UI) thread to make the writer (running on background thread) send a We...">forward</a>(Object message) {
<a name="l00097"></a>00097 
<a name="l00098"></a>00098       Message msg = obtainMessage();
<a name="l00099"></a>00099       msg.obj = message;
<a name="l00100"></a>00100       sendMessage(msg);
<a name="l00101"></a>00101    }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 
<a name="l00109"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a8418b21dc31459fb15164d69e0374f32">00109</a>    <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a8418b21dc31459fb15164d69e0374f32" title="Notify the master (foreground thread).">notify</a>(Object message) {
<a name="l00110"></a>00110 
<a name="l00111"></a>00111       Message msg = <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#abe189259b7812c7ae5aa9ef18f1090f6" title="Connection master.">mMaster</a>.obtainMessage();
<a name="l00112"></a>00112       msg.obj = message;
<a name="l00113"></a>00113       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#abe189259b7812c7ae5aa9ef18f1090f6" title="Connection master.">mMaster</a>.sendMessage(msg);
<a name="l00114"></a>00114    }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 
<a name="l00122"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a86b8534da0c5d4fb2db8fe88ecbe2c88">00122</a>    <span class="keyword">private</span> String <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a86b8534da0c5d4fb2db8fe88ecbe2c88" title="Create new key for WebSockets handshake.">newHandshakeKey</a>() {
<a name="l00123"></a>00123       <span class="keyword">final</span> byte[] ba = <span class="keyword">new</span> byte[16];
<a name="l00124"></a>00124       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9d54d55b5fcc178a6dcb1614bde71600" title="Random number generator for handshake key and frame mask generation.">mRng</a>.nextBytes(ba);
<a name="l00125"></a>00125       <span class="keywordflow">return</span> Base64.encodeToString(ba, Base64.NO_WRAP);
<a name="l00126"></a>00126    }
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 
<a name="l00134"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a3445be2f49ca87a855778a975e2de81f">00134</a>    <span class="keyword">private</span> byte[] <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a3445be2f49ca87a855778a975e2de81f" title="Create new (random) frame mask.">newFrameMask</a>() {
<a name="l00135"></a>00135       <span class="keyword">final</span> byte[] ba = <span class="keyword">new</span> byte[4];
<a name="l00136"></a>00136       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9d54d55b5fcc178a6dcb1614bde71600" title="Random number generator for handshake key and frame mask generation.">mRng</a>.nextBytes(ba);
<a name="l00137"></a>00137       <span class="keywordflow">return</span> ba;
<a name="l00138"></a>00138    }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 
<a name="l00144"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a69d926ecd1ce810d4227fa08882c0501">00144</a>    <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a69d926ecd1ce810d4227fa08882c0501" title="Send WebSocket client handshake.">sendClientHandshake</a>(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.ClientHandshake message) throws IOException {
<a name="l00145"></a>00145 
<a name="l00146"></a>00146       <span class="comment">// write HTTP header with handshake</span>
<a name="l00147"></a>00147       String path;
<a name="l00148"></a>00148       <span class="keywordflow">if</span> (message.mQuery != null) {
<a name="l00149"></a>00149          path = message.mPath + <span class="stringliteral">&quot;?&quot;</span> + message.mQuery;
<a name="l00150"></a>00150       } <span class="keywordflow">else</span> {
<a name="l00151"></a>00151          path = message.mPath;
<a name="l00152"></a>00152       }
<a name="l00153"></a>00153       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(<span class="stringliteral">&quot;GET &quot;</span> + path + <span class="stringliteral">&quot; HTTP/1.1&quot;</span>);
<a name="l00154"></a>00154       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a9c28400ef4763de07a17cb02643ea0f9" title="Write CR-LF.">crlf</a>();
<a name="l00155"></a>00155       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(<span class="stringliteral">&quot;Host: &quot;</span> + message.mHost);
<a name="l00156"></a>00156       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a9c28400ef4763de07a17cb02643ea0f9" title="Write CR-LF.">crlf</a>();
<a name="l00157"></a>00157       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(<span class="stringliteral">&quot;Upgrade: WebSocket&quot;</span>);
<a name="l00158"></a>00158       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a9c28400ef4763de07a17cb02643ea0f9" title="Write CR-LF.">crlf</a>();
<a name="l00159"></a>00159       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(<span class="stringliteral">&quot;Connection: Upgrade&quot;</span>);
<a name="l00160"></a>00160       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a9c28400ef4763de07a17cb02643ea0f9" title="Write CR-LF.">crlf</a>();
<a name="l00161"></a>00161 
<a name="l00162"></a>00162       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(<span class="stringliteral">&quot;Sec-WebSocket-Key: &quot;</span> + <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a86b8534da0c5d4fb2db8fe88ecbe2c88" title="Create new key for WebSockets handshake.">newHandshakeKey</a>());
<a name="l00163"></a>00163       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a9c28400ef4763de07a17cb02643ea0f9" title="Write CR-LF.">crlf</a>();
<a name="l00164"></a>00164 
<a name="l00165"></a>00165       <span class="keywordflow">if</span> (message.mOrigin != null &amp;&amp; !message.mOrigin.equals(<span class="stringliteral">&quot;&quot;</span>)) {
<a name="l00166"></a>00166          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(<span class="stringliteral">&quot;Origin: &quot;</span> + message.mOrigin);
<a name="l00167"></a>00167          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a9c28400ef4763de07a17cb02643ea0f9" title="Write CR-LF.">crlf</a>();
<a name="l00168"></a>00168       }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170       <span class="keywordflow">if</span> (message.mSubprotocols != null &amp;&amp; message.mSubprotocols.length &gt; 0) {
<a name="l00171"></a>00171          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(<span class="stringliteral">&quot;Sec-WebSocket-Protocol: &quot;</span>);
<a name="l00172"></a>00172          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; message.mSubprotocols.length; ++i) {
<a name="l00173"></a>00173             <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(message.mSubprotocols[i]);
<a name="l00174"></a>00174             <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(<span class="stringliteral">&quot;, &quot;</span>);
<a name="l00175"></a>00175          }
<a name="l00176"></a>00176          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a9c28400ef4763de07a17cb02643ea0f9" title="Write CR-LF.">crlf</a>();
<a name="l00177"></a>00177       }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(<span class="stringliteral">&quot;Sec-WebSocket-Version: 13&quot;</span>);
<a name="l00180"></a>00180       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a9c28400ef4763de07a17cb02643ea0f9" title="Write CR-LF.">crlf</a>();
<a name="l00181"></a>00181 
<a name="l00182"></a>00182       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a9c28400ef4763de07a17cb02643ea0f9" title="Write CR-LF.">crlf</a>();
<a name="l00183"></a>00183    }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 
<a name="l00189"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a62a92d1c85f557b2137c1df8b8178bc2">00189</a>    <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a62a92d1c85f557b2137c1df8b8178bc2" title="Send WebSockets close.">sendClose</a>(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.Close message) throws IOException, <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a> {
<a name="l00190"></a>00190 
<a name="l00191"></a>00191       <span class="keywordflow">if</span> (message.mCode &gt; 0) {
<a name="l00192"></a>00192 
<a name="l00193"></a>00193          byte[] payload = null;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195          <span class="keywordflow">if</span> (message.mReason != null &amp;&amp; !message.mReason.equals(<span class="stringliteral">&quot;&quot;</span>)) {
<a name="l00196"></a>00196             byte[] pReason = message.mReason.getBytes(<span class="stringliteral">&quot;UTF-8&quot;</span>);
<a name="l00197"></a>00197             payload = <span class="keyword">new</span> byte[2 + pReason.length];
<a name="l00198"></a>00198             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; pReason.length; ++i) {
<a name="l00199"></a>00199                payload[i + 2] = pReason[i];
<a name="l00200"></a>00200             }
<a name="l00201"></a>00201          } <span class="keywordflow">else</span> {
<a name="l00202"></a>00202             payload = <span class="keyword">new</span> byte[2];
<a name="l00203"></a>00203          }
<a name="l00204"></a>00204 
<a name="l00205"></a>00205          <span class="keywordflow">if</span> (payload != null &amp;&amp; payload.length &gt; 125) {
<a name="l00206"></a>00206             <span class="keywordflow">throw</span> <span class="keyword">new</span> WebSocketException(<span class="stringliteral">&quot;close payload exceeds 125 octets&quot;</span>);
<a name="l00207"></a>00207          }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209          payload[0] = (byte)((message.mCode &gt;&gt; 8) &amp; 0xff);
<a name="l00210"></a>00210          payload[1] = (byte)(message.mCode &amp; 0xff);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061" title="Sends a WebSockets frame.">sendFrame</a>(8, <span class="keyword">true</span>, payload);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214       } <span class="keywordflow">else</span> {
<a name="l00215"></a>00215 
<a name="l00216"></a>00216          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061" title="Sends a WebSockets frame.">sendFrame</a>(8, <span class="keyword">true</span>, null);
<a name="l00217"></a>00217       }
<a name="l00218"></a>00218    }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 
<a name="l00224"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a2883eab5123a2aa4cfff3c7acf382217">00224</a>    <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a2883eab5123a2aa4cfff3c7acf382217" title="Send WebSockets ping.">sendPing</a>(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.Ping message) throws IOException, <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a> {
<a name="l00225"></a>00225       <span class="keywordflow">if</span> (message.mPayload != null &amp;&amp; message.mPayload.length &gt; 125) {
<a name="l00226"></a>00226          <span class="keywordflow">throw</span> <span class="keyword">new</span> WebSocketException(<span class="stringliteral">&quot;ping payload exceeds 125 octets&quot;</span>);
<a name="l00227"></a>00227       }
<a name="l00228"></a>00228       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061" title="Sends a WebSockets frame.">sendFrame</a>(9, <span class="keyword">true</span>, message.mPayload);
<a name="l00229"></a>00229    }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 
<a name="l00236"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac92c201e6dbcf04d230078def92233ce">00236</a>    <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac92c201e6dbcf04d230078def92233ce" title="Send WebSockets pong.">sendPong</a>(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.Pong message) throws IOException, <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a> {
<a name="l00237"></a>00237       <span class="keywordflow">if</span> (message.mPayload != null &amp;&amp; message.mPayload.length &gt; 125) {
<a name="l00238"></a>00238          <span class="keywordflow">throw</span> <span class="keyword">new</span> WebSocketException(<span class="stringliteral">&quot;pong payload exceeds 125 octets&quot;</span>);
<a name="l00239"></a>00239       }
<a name="l00240"></a>00240       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061" title="Sends a WebSockets frame.">sendFrame</a>(10, <span class="keyword">true</span>, message.mPayload);
<a name="l00241"></a>00241    }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 
<a name="l00247"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#adbcb985c5cedaeab3de877716f6ad3c4">00247</a>    <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#adbcb985c5cedaeab3de877716f6ad3c4" title="Send WebSockets binary message.">sendBinaryMessage</a>(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.BinaryMessage message) throws IOException, <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a> {
<a name="l00248"></a>00248       <span class="keywordflow">if</span> (message.mPayload.length &gt; <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ae1cdc80e31f3c49f282bdb021e58a4a3" title="WebSockets options.">mOptions</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_options.html#ab05f1c677159e61f27e621c62324ba0b" title="Get maximum message payload size (after reassembly of fragmented messages) that will be accepted when...">getMaxMessagePayloadSize</a>()) {
<a name="l00249"></a>00249          <span class="keywordflow">throw</span> <span class="keyword">new</span> WebSocketException(<span class="stringliteral">&quot;message payload exceeds payload limit&quot;</span>);
<a name="l00250"></a>00250       }
<a name="l00251"></a>00251       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061" title="Sends a WebSockets frame.">sendFrame</a>(2, <span class="keyword">true</span>, message.mPayload);
<a name="l00252"></a>00252    }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 
<a name="l00258"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#aa84cc815ff21ee1a21c0564482b8f886">00258</a>    <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#aa84cc815ff21ee1a21c0564482b8f886" title="Send WebSockets text message.">sendTextMessage</a>(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.TextMessage message) throws IOException, <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a> {
<a name="l00259"></a>00259       byte[] payload = message.mPayload.getBytes(<span class="stringliteral">&quot;UTF-8&quot;</span>);
<a name="l00260"></a>00260       <span class="keywordflow">if</span> (payload.length &gt; <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ae1cdc80e31f3c49f282bdb021e58a4a3" title="WebSockets options.">mOptions</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_options.html#ab05f1c677159e61f27e621c62324ba0b" title="Get maximum message payload size (after reassembly of fragmented messages) that will be accepted when...">getMaxMessagePayloadSize</a>()) {
<a name="l00261"></a>00261          <span class="keywordflow">throw</span> <span class="keyword">new</span> WebSocketException(<span class="stringliteral">&quot;message payload exceeds payload limit&quot;</span>);
<a name="l00262"></a>00262       }
<a name="l00263"></a>00263       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061" title="Sends a WebSockets frame.">sendFrame</a>(1, <span class="keyword">true</span>, payload);
<a name="l00264"></a>00264    }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 
<a name="l00270"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac3b80e38b9a905b5a8dc359aa6b627d6">00270</a>    <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac3b80e38b9a905b5a8dc359aa6b627d6" title="Send WebSockets binary message.">sendRawTextMessage</a>(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.RawTextMessage message) throws IOException, <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a> {
<a name="l00271"></a>00271       <span class="keywordflow">if</span> (message.mPayload.length &gt; <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ae1cdc80e31f3c49f282bdb021e58a4a3" title="WebSockets options.">mOptions</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_options.html#ab05f1c677159e61f27e621c62324ba0b" title="Get maximum message payload size (after reassembly of fragmented messages) that will be accepted when...">getMaxMessagePayloadSize</a>()) {
<a name="l00272"></a>00272          <span class="keywordflow">throw</span> <span class="keyword">new</span> WebSocketException(<span class="stringliteral">&quot;message payload exceeds payload limit&quot;</span>);
<a name="l00273"></a>00273       }
<a name="l00274"></a>00274       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061" title="Sends a WebSockets frame.">sendFrame</a>(1, <span class="keyword">true</span>, message.mPayload);
<a name="l00275"></a>00275    }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 
<a name="l00286"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061">00286</a>    <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061" title="Sends a WebSockets frame.">sendFrame</a>(<span class="keywordtype">int</span> opcode, <span class="keywordtype">boolean</span> fin, byte[] payload) <span class="keywordflow">throws</span> IOException {
<a name="l00287"></a>00287       <span class="keywordflow">if</span> (payload != null) {
<a name="l00288"></a>00288          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061" title="Sends a WebSockets frame.">sendFrame</a>(opcode, fin, payload, 0, payload.length);
<a name="l00289"></a>00289       } <span class="keywordflow">else</span> {
<a name="l00290"></a>00290          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061" title="Sends a WebSockets frame.">sendFrame</a>(opcode, fin, null, 0, 0);
<a name="l00291"></a>00291       }
<a name="l00292"></a>00292    }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 
<a name="l00305"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac1a594151730e890a5f926ee0c6853f9">00305</a>    <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac1a594151730e890a5f926ee0c6853f9" title="Sends a WebSockets frame.">sendFrame</a>(<span class="keywordtype">int</span> opcode, <span class="keywordtype">boolean</span> fin, byte[] payload, <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> length) <span class="keywordflow">throws</span> IOException {
<a name="l00306"></a>00306 
<a name="l00307"></a>00307       <span class="comment">// first octet</span>
<a name="l00308"></a>00308       byte b0 = 0;
<a name="l00309"></a>00309       <span class="keywordflow">if</span> (fin) {
<a name="l00310"></a>00310          b0 |= (byte) (1 &lt;&lt; 7);
<a name="l00311"></a>00311       }
<a name="l00312"></a>00312       b0 |= (byte) opcode;
<a name="l00313"></a>00313       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(b0);
<a name="l00314"></a>00314 
<a name="l00315"></a>00315       <span class="comment">// second octet</span>
<a name="l00316"></a>00316       byte b1 = 0;
<a name="l00317"></a>00317       <span class="keywordflow">if</span> (<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ae1cdc80e31f3c49f282bdb021e58a4a3" title="WebSockets options.">mOptions</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_options.html#a084735c4d1cdec683b7a0cb8d0a7a97e" title="Get mask client frames option.">getMaskClientFrames</a>()) {
<a name="l00318"></a>00318          b1 = (byte) (1 &lt;&lt; 7);
<a name="l00319"></a>00319       }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321       <span class="keywordtype">long</span> len = length;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323       <span class="comment">// extended payload length</span>
<a name="l00324"></a>00324       <span class="keywordflow">if</span> (len &lt;= 125) {
<a name="l00325"></a>00325          b1 |= (byte) len;
<a name="l00326"></a>00326          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(b1);
<a name="l00327"></a>00327       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt;= 0xffff) {
<a name="l00328"></a>00328          b1 |= (byte) (126 &amp; 0xff);
<a name="l00329"></a>00329          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(b1);
<a name="l00330"></a>00330          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(<span class="keyword">new</span> byte[] {(byte)((len &gt;&gt; 8) &amp; 0xff),
<a name="l00331"></a>00331                                    (byte)(len &amp; 0xff)});
<a name="l00332"></a>00332       } <span class="keywordflow">else</span> {
<a name="l00333"></a>00333          b1 |= (byte) (127 &amp; 0xff);
<a name="l00334"></a>00334          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(b1);
<a name="l00335"></a>00335          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(<span class="keyword">new</span> byte[] {(byte)((len &gt;&gt; 56) &amp; 0xff),
<a name="l00336"></a>00336                                    (byte)((len &gt;&gt; 48) &amp; 0xff),
<a name="l00337"></a>00337                                    (byte)((len &gt;&gt; 40) &amp; 0xff),
<a name="l00338"></a>00338                                    (byte)((len &gt;&gt; 32) &amp; 0xff),
<a name="l00339"></a>00339                                    (byte)((len &gt;&gt; 24) &amp; 0xff),
<a name="l00340"></a>00340                                    (byte)((len &gt;&gt; 16) &amp; 0xff),
<a name="l00341"></a>00341                                    (byte)((len &gt;&gt; 8)  &amp; 0xff),
<a name="l00342"></a>00342                                    (byte)(len         &amp; 0xff)});
<a name="l00343"></a>00343       }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345       byte mask[] = null;
<a name="l00346"></a>00346       <span class="keywordflow">if</span> (<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ae1cdc80e31f3c49f282bdb021e58a4a3" title="WebSockets options.">mOptions</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_options.html#a084735c4d1cdec683b7a0cb8d0a7a97e" title="Get mask client frames option.">getMaskClientFrames</a>()) {
<a name="l00347"></a>00347          <span class="comment">// a mask is always needed, even without payload</span>
<a name="l00348"></a>00348          mask = <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a3445be2f49ca87a855778a975e2de81f" title="Create new (random) frame mask.">newFrameMask</a>();
<a name="l00349"></a>00349          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(mask[0]);
<a name="l00350"></a>00350          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(mask[1]);
<a name="l00351"></a>00351          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(mask[2]);
<a name="l00352"></a>00352          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(mask[3]);
<a name="l00353"></a>00353       }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355       <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l00356"></a>00356          <span class="keywordflow">if</span> (<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ae1cdc80e31f3c49f282bdb021e58a4a3" title="WebSockets options.">mOptions</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_options.html#a084735c4d1cdec683b7a0cb8d0a7a97e" title="Get mask client frames option.">getMaskClientFrames</a>()) {
<a name="l00359"></a>00359             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; len; ++i) {
<a name="l00360"></a>00360                payload[i + offset] ^= mask[i % 4];
<a name="l00361"></a>00361             }
<a name="l00362"></a>00362          }
<a name="l00363"></a>00363          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a95789cf14ea69a6f52cb51266dbe1034" title="Write one byte to the underlying ByteBuffer via this OutputStream.">write</a>(payload, offset, length);
<a name="l00364"></a>00364       }
<a name="l00365"></a>00365    }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 
<a name="l00374"></a>00374    @Override
<a name="l00375"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#aced915c177a76c40087f0cd29bcd9114">00375</a>    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#aced915c177a76c40087f0cd29bcd9114" title="Process message received from foreground thread.">handleMessage</a>(Message msg) {
<a name="l00376"></a>00376 
<a name="l00377"></a>00377       <span class="keywordflow">try</span> {
<a name="l00378"></a>00378 
<a name="l00379"></a>00379          <span class="comment">// clear send buffer</span>
<a name="l00380"></a>00380          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#afb78c13ac44eb5abc25c2f60bbe4c74c" title="Calls clear on the underlying ByteBuffer.">clear</a>();
<a name="l00381"></a>00381 
<a name="l00382"></a>00382          <span class="comment">// process message from master</span>
<a name="l00383"></a>00383          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9204737d5b5e2ac5fe1d4495a7438269" title="Process WebSockets or control message from master.">processMessage</a>(msg.obj);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385          <span class="comment">// send out buffered data</span>
<a name="l00386"></a>00386          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a2388b97e8a14938c4e748480dd1edc43" title="Calls flip on the underyling ByteBuffer.">flip</a>();
<a name="l00387"></a>00387          <span class="keywordflow">while</span> (<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#a3e45d370c57ed1e0f74ba8e5f8ebaaef" title="Calls remaining() on underlying ByteBuffer.">remaining</a>() &gt; 0) {
<a name="l00388"></a>00388             <span class="comment">// this can block on socket write</span>
<a name="l00389"></a>00389             @SuppressWarnings(<span class="stringliteral">&quot;unused&quot;</span>)
<a name="l00390"></a>00390             <span class="keywordtype">int</span> written = <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9cf3886736afe363dc171afd7936baf7" title="The NIO socket channel created on foreground thread.">mSocket</a>.write(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9caf6fab626701a5f5e34ed806ad3903" title="The send buffer that holds data to send on socket.">mBuffer</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_byte_buffer_output_stream.html#ae9b1bc66c165ef0e5586aebb2a6df2e9" title="Get the underlying ByteBuffer.">getBuffer</a>());
<a name="l00391"></a>00391          }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393       } <span class="keywordflow">catch</span> (Exception e) {
<a name="l00394"></a>00394 
<a name="l00395"></a>00395          <span class="keywordflow">if</span> (DEBUG) e.printStackTrace();
<a name="l00396"></a>00396 
<a name="l00397"></a>00397          <span class="comment">// wrap the exception and notify master</span>
<a name="l00398"></a>00398          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a8418b21dc31459fb15164d69e0374f32" title="Notify the master (foreground thread).">notify</a>(<span class="keyword">new</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.Error(e));
<a name="l00399"></a>00399       }
<a name="l00400"></a>00400    }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 
<a name="l00411"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9204737d5b5e2ac5fe1d4495a7438269">00411</a>    <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a9204737d5b5e2ac5fe1d4495a7438269" title="Process WebSockets or control message from master.">processMessage</a>(Object msg) <span class="keywordflow">throws</span> IOException, <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a> {
<a name="l00412"></a>00412 
<a name="l00413"></a>00413       <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.TextMessage) {
<a name="l00414"></a>00414 
<a name="l00415"></a>00415          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#aa84cc815ff21ee1a21c0564482b8f886" title="Send WebSockets text message.">sendTextMessage</a>((<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.TextMessage) msg);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.RawTextMessage) {
<a name="l00418"></a>00418 
<a name="l00419"></a>00419          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac3b80e38b9a905b5a8dc359aa6b627d6" title="Send WebSockets binary message.">sendRawTextMessage</a>((<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.RawTextMessage) msg);
<a name="l00420"></a>00420 
<a name="l00421"></a>00421       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.BinaryMessage) {
<a name="l00422"></a>00422 
<a name="l00423"></a>00423          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#adbcb985c5cedaeab3de877716f6ad3c4" title="Send WebSockets binary message.">sendBinaryMessage</a>((<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.BinaryMessage) msg);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.Ping) {
<a name="l00426"></a>00426 
<a name="l00427"></a>00427          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a2883eab5123a2aa4cfff3c7acf382217" title="Send WebSockets ping.">sendPing</a>((<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.Ping) msg);
<a name="l00428"></a>00428 
<a name="l00429"></a>00429       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.Pong) {
<a name="l00430"></a>00430 
<a name="l00431"></a>00431          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac92c201e6dbcf04d230078def92233ce" title="Send WebSockets pong.">sendPong</a>((<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.Pong) msg);
<a name="l00432"></a>00432 
<a name="l00433"></a>00433       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.Close) {
<a name="l00434"></a>00434 
<a name="l00435"></a>00435          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a62a92d1c85f557b2137c1df8b8178bc2" title="Send WebSockets close.">sendClose</a>((<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.Close) msg);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.ClientHandshake) {
<a name="l00438"></a>00438 
<a name="l00439"></a>00439          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a69d926ecd1ce810d4227fa08882c0501" title="Send WebSocket client handshake.">sendClientHandshake</a>((<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.ClientHandshake) msg);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_message.html" title="WebSockets message classes.">WebSocketMessage</a>.Quit) {
<a name="l00442"></a>00442 
<a name="l00443"></a>00443          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ab4c9be3a28d3cff500f958523e3f0547" title="Message looper this object is running on.">mLooper</a>.quit();
<a name="l00444"></a>00444 
<a name="l00445"></a>00445          <span class="keywordflow">if</span>  (DEBUG) Log.d(TAG, <span class="stringliteral">&quot;ended&quot;</span>);
<a name="l00446"></a>00446 
<a name="l00447"></a>00447          <span class="keywordflow">return</span>;
<a name="l00448"></a>00448 
<a name="l00449"></a>00449       } <span class="keywordflow">else</span> {
<a name="l00450"></a>00450 
<a name="l00451"></a>00451          <span class="comment">// call hook which may be overridden in derived class to process</span>
<a name="l00452"></a>00452          <span class="comment">// messages we don&#39;t understand in this class</span>
<a name="l00453"></a>00453          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a56e9494db545ffd85e163cf43c46f5b6" title="Process message other than plain WebSockets or control message.">processAppMessage</a>(msg);
<a name="l00454"></a>00454       }
<a name="l00455"></a>00455    }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 
<a name="l00464"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a56e9494db545ffd85e163cf43c46f5b6">00464</a>    <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#a56e9494db545ffd85e163cf43c46f5b6" title="Process message other than plain WebSockets or control message.">processAppMessage</a>(Object msg) <span class="keywordflow">throws</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a>, IOException {
<a name="l00465"></a>00465 
<a name="l00466"></a>00466       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a>(<span class="stringliteral">&quot;unknown message received by WebSocketWriter&quot;</span>);
<a name="l00467"></a>00467    }
<a name="l00468"></a>00468 }
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Fri Jun 22 2012 18:12:08 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
