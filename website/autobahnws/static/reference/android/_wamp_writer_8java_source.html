<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>

<title>src/de/tavendo/autobahn/WampWriter.java Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

<script>    $(document).ready(function() {       var frame = $('#thisframe', window.parent.document);       frame.height(document.body.offsetHeight + 100);    }); </script> </head>
<body>
<div id="top"><!-- do not remove this div! -->


<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">src/de/tavendo/autobahn/WampWriter.java</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/******************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> *  Copyright 2011-2012 Tavendo GmbH</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00006"></a>00006 <span class="comment"> *  you may not use this file except in compliance with the License.</span>
<a name="l00007"></a>00007 <span class="comment"> *  You may obtain a copy of the License at</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> *  Unless required by applicable law or agreed to in writing, software</span>
<a name="l00012"></a>00012 <span class="comment"> *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00013"></a>00013 <span class="comment"> *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00014"></a>00014 <span class="comment"> *  See the License for the specific language governing permissions and</span>
<a name="l00015"></a>00015 <span class="comment"> *  limitations under the License.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> ******************************************************************************/</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="keyword">package </span>de.tavendo.autobahn;
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="keyword">import</span> java.io.IOException;
<a name="l00022"></a>00022 <span class="keyword">import</span> java.nio.channels.SocketChannel;
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="keyword">import</span> org.codehaus.jackson.JsonFactory;
<a name="l00025"></a>00025 <span class="keyword">import</span> org.codehaus.jackson.JsonGenerationException;
<a name="l00026"></a>00026 <span class="keyword">import</span> org.codehaus.jackson.JsonGenerator;
<a name="l00027"></a>00027 <span class="keyword">import</span> org.codehaus.jackson.map.JsonMappingException;
<a name="l00028"></a>00028 <span class="keyword">import</span> org.codehaus.jackson.map.MappingJsonFactory;
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="keyword">import</span> android.os.Handler;
<a name="l00031"></a>00031 <span class="keyword">import</span> android.os.Looper;
<a name="l00032"></a>00032 <span class="keyword">import</span> android.util.Log;
<a name="l00033"></a>00033 
<a name="l00040"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html">00040</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html" title="Autobahn WAMP writer, the transmitting leg of a WAMP connection.">WampWriter</a> <span class="keyword">extends</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html" title="WebSocket writer, the sending leg of a WebSockets connection.">WebSocketWriter</a> {
<a name="l00041"></a>00041 
<a name="l00042"></a>00042    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">boolean</span> DEBUG = <span class="keyword">true</span>;
<a name="l00043"></a>00043    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html" title="Autobahn WAMP writer, the transmitting leg of a WAMP connection.">WampWriter</a>.class.getName();
<a name="l00044"></a>00044 
<a name="l00048"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#a605dccb75fc4e6a57d9d2239c8f32f60">00048</a>    <span class="keyword">private</span> <span class="keyword">final</span> JsonFactory <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#a605dccb75fc4e6a57d9d2239c8f32f60" title="This is the Jackson JSON factory we use to create JSON generators.">mJsonFactory</a>;
<a name="l00049"></a>00049 
<a name="l00053"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#aae36a174376e95e1f4c62bbc4e0d6ed6">00053</a>    <span class="keyword">private</span> <span class="keyword">final</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_no_copy_byte_array_output_stream.html" title="OutputStream backed by a byte array.">NoCopyByteArrayOutputStream</a> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#aae36a174376e95e1f4c62bbc4e0d6ed6" title="This is where we buffer the JSON serialization of WAMP messages.">mPayload</a>;
<a name="l00054"></a>00054 
<a name="l00063"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#aa27c59b2b2bd3456a6af820da61fffd5">00063</a>    <span class="keyword">public</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#aa27c59b2b2bd3456a6af820da61fffd5" title="A writer object is created in AutobahnConnection.">WampWriter</a>(Looper looper, Handler master, SocketChannel socket,
<a name="l00064"></a>00064          <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_options.html" title="WebSockets connection options.">WebSocketOptions</a> options) {
<a name="l00065"></a>00065 
<a name="l00066"></a>00066       super(looper, master, socket, options);
<a name="l00067"></a>00067 
<a name="l00068"></a>00068       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#a605dccb75fc4e6a57d9d2239c8f32f60" title="This is the Jackson JSON factory we use to create JSON generators.">mJsonFactory</a> = <span class="keyword">new</span> MappingJsonFactory();
<a name="l00069"></a>00069       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#aae36a174376e95e1f4c62bbc4e0d6ed6" title="This is where we buffer the JSON serialization of WAMP messages.">mPayload</a> = <span class="keyword">new</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_no_copy_byte_array_output_stream.html" title="OutputStream backed by a byte array.">NoCopyByteArrayOutputStream</a>();
<a name="l00070"></a>00070 
<a name="l00071"></a>00071       <span class="keywordflow">if</span> (DEBUG) Log.d(TAG, <span class="stringliteral">&quot;created&quot;</span>);
<a name="l00072"></a>00072    }
<a name="l00073"></a>00073 
<a name="l00078"></a><a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#a13684fb1f30f8b76e17cb4f1e660d3c1">00078</a>    <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#a13684fb1f30f8b76e17cb4f1e660d3c1" title="Called from WebSocketWriter when it receives a message in it&#39;s message loop it does not recognize...">processAppMessage</a>(Object msg) <span class="keywordflow">throws</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a>, IOException {
<a name="l00079"></a>00079 
<a name="l00080"></a>00080       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#aae36a174376e95e1f4c62bbc4e0d6ed6" title="This is where we buffer the JSON serialization of WAMP messages.">mPayload</a>.reset();
<a name="l00081"></a>00081 
<a name="l00082"></a>00082       <span class="comment">// creating a JSON generator is supposed to be a light-weight operation</span>
<a name="l00083"></a>00083       JsonGenerator generator = <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#a605dccb75fc4e6a57d9d2239c8f32f60" title="This is the Jackson JSON factory we use to create JSON generators.">mJsonFactory</a>.createJsonGenerator(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#aae36a174376e95e1f4c62bbc4e0d6ed6" title="This is where we buffer the JSON serialization of WAMP messages.">mPayload</a>);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085       <span class="keywordflow">try</span> {
<a name="l00086"></a>00086 
<a name="l00087"></a>00087          <span class="comment">// serialize WAMP messages to JSON: the code here needs to understand</span>
<a name="l00088"></a>00088          <span class="comment">// any client-to-server WAMP messages forward from the foreground thread</span>
<a name="l00089"></a>00089 
<a name="l00090"></a>00090          <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Call) {
<a name="l00091"></a>00091 
<a name="l00092"></a>00092             <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Call call = (<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Call) msg;
<a name="l00093"></a>00093 
<a name="l00094"></a>00094             generator.writeStartArray();
<a name="l00095"></a>00095             generator.writeNumber(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.MESSAGE_TYPE_CALL);
<a name="l00096"></a>00096             generator.writeString(call.mCallId);
<a name="l00097"></a>00097             generator.writeString(call.mProcUri);
<a name="l00098"></a>00098             <span class="keywordflow">for</span> (Object arg : call.mArgs) {
<a name="l00099"></a>00099                generator.writeObject(arg);
<a name="l00100"></a>00100             }
<a name="l00101"></a>00101             generator.writeEndArray();
<a name="l00102"></a>00102 
<a name="l00103"></a>00103          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Prefix) {
<a name="l00104"></a>00104 
<a name="l00105"></a>00105             <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Prefix prefix = (<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Prefix) msg;
<a name="l00106"></a>00106 
<a name="l00107"></a>00107             generator.writeStartArray();
<a name="l00108"></a>00108             generator.writeNumber(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.MESSAGE_TYPE_PREFIX);
<a name="l00109"></a>00109             generator.writeString(prefix.mPrefix);
<a name="l00110"></a>00110             generator.writeString(prefix.mUri);
<a name="l00111"></a>00111             generator.writeEndArray();
<a name="l00112"></a>00112 
<a name="l00113"></a>00113          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Subscribe) {
<a name="l00114"></a>00114 
<a name="l00115"></a>00115             <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Subscribe subscribe = (<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Subscribe) msg;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117             generator.writeStartArray();
<a name="l00118"></a>00118             generator.writeNumber(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.MESSAGE_TYPE_SUBSCRIBE);
<a name="l00119"></a>00119             generator.writeString(subscribe.mTopicUri);
<a name="l00120"></a>00120             generator.writeEndArray();
<a name="l00121"></a>00121 
<a name="l00122"></a>00122          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Unsubscribe) {
<a name="l00123"></a>00123 
<a name="l00124"></a>00124             <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Unsubscribe unsubscribe = (<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Unsubscribe) msg;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126             generator.writeStartArray();
<a name="l00127"></a>00127             generator.writeNumber(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.MESSAGE_TYPE_UNSUBSCRIBE);
<a name="l00128"></a>00128             generator.writeString(unsubscribe.mTopicUri);
<a name="l00129"></a>00129             generator.writeEndArray();
<a name="l00130"></a>00130 
<a name="l00131"></a>00131          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg instanceof <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Publish) {
<a name="l00132"></a>00132 
<a name="l00133"></a>00133             <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Publish publish = (<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.Publish) msg;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135             generator.writeStartArray();
<a name="l00136"></a>00136             generator.writeNumber(<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_message.html" title="The master thread and the background reader/writer threads communicate using these messages for Autob...">WampMessage</a>.MESSAGE_TYPE_PUBLISH);
<a name="l00137"></a>00137             generator.writeString(publish.mTopicUri);
<a name="l00138"></a>00138             generator.writeObject(publish.mEvent);
<a name="l00139"></a>00139             generator.writeEndArray();
<a name="l00140"></a>00140 
<a name="l00141"></a>00141          } <span class="keywordflow">else</span> {
<a name="l00142"></a>00142 
<a name="l00143"></a>00143             <span class="comment">// this should not happen, but to be sure</span>
<a name="l00144"></a>00144             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a>(<span class="stringliteral">&quot;invalid message received by AutobahnWriter&quot;</span>);
<a name="l00145"></a>00145          }
<a name="l00146"></a>00146       } <span class="keywordflow">catch</span> (JsonGenerationException e) {
<a name="l00147"></a>00147 
<a name="l00148"></a>00148          <span class="comment">// this may happen, and we need to wrap the error</span>
<a name="l00149"></a>00149          <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a>(<span class="stringliteral">&quot;JSON serialization error (&quot;</span> + e.toString() + <span class="stringliteral">&quot;)&quot;</span>);
<a name="l00150"></a>00150 
<a name="l00151"></a>00151       } <span class="keywordflow">catch</span> (JsonMappingException e) {
<a name="l00152"></a>00152 
<a name="l00153"></a>00153          <span class="comment">// this may happen, and we need to wrap the error</span>
<a name="l00154"></a>00154          <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_exception.html">WebSocketException</a>(<span class="stringliteral">&quot;JSON serialization error (&quot;</span> + e.toString() + <span class="stringliteral">&quot;)&quot;</span>);
<a name="l00155"></a>00155       }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157       <span class="comment">// make sure the JSON generator has spit out everything</span>
<a name="l00158"></a>00158       generator.flush();
<a name="l00159"></a>00159 
<a name="l00160"></a>00160       <span class="comment">// Jackson&#39;s JSON generator produces UTF-8 directly, so we send</span>
<a name="l00161"></a>00161       <span class="comment">// a text message frame using the raw sendFrame() method</span>
<a name="l00162"></a>00162       <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_web_socket_writer.html#ac898c9e3f1be25c13664b34420dfa061" title="Sends a WebSockets frame.">sendFrame</a>(1, <span class="keyword">true</span>, <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#aae36a174376e95e1f4c62bbc4e0d6ed6" title="This is where we buffer the JSON serialization of WAMP messages.">mPayload</a>.<a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_no_copy_byte_array_output_stream.html#a7d0ec2a7e65e1599ec68ffb11d3ce2cd" title="Get byte array underlying this OutputStream.">getByteArray</a>(), 0, <a class="code" href="classde_1_1tavendo_1_1autobahn_1_1_wamp_writer.html#aae36a174376e95e1f4c62bbc4e0d6ed6" title="This is where we buffer the JSON serialization of WAMP messages.">mPayload</a>.size());
<a name="l00163"></a>00163 
<a name="l00164"></a>00164       <span class="comment">// cleanup generators resources</span>
<a name="l00165"></a>00165       generator.close();
<a name="l00166"></a>00166    }
<a name="l00167"></a>00167 }
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Fri Jun 22 2012 18:12:08 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
