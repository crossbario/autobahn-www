

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>autobahn.wamp1.protocol &mdash; Autobahn 0.8.5 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../../../',
        VERSION:'0.8.5',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
    <link rel="top" title="Autobahn 0.8.5 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="icon icon-home"> Autobahn</a>
        <form class="wy-form" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search docs" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../websockettoc.html">WebSocket</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketintro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketbase.html">WebSocket</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketclient.html">WebSocket Clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketserver.html">WebSocket Servers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketcompress.html">WebSocket Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketaux.html">WebSocket Auxiliary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../twistedintegration.html">Twisted Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../wamp1toc.html">WAMP v1</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp1base.html">Base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp1client.html">Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp1server.html">Server</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../wamp2.html">WAMP v2</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#sessions">Sessions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#callers">Callers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#callees">Callees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#subscribers">Subscribers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#publishers">Publishers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#decorators">Decorators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../wamp2all.html">WAMP v2</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2all.html#interfaces">Interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2all.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2all.html#router">Router</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2all.html#protocol">Protocol</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="/">Autobahn</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <ul class="wy-breadcrumbs">
  <li><a href="../../../index.html">Docs</a> &raquo;</li>
  <li><a href="">autobahn.wamp1.protocol</a></li>
  
</ul>
<hr/>

          
  <h1>Source code for autobahn.wamp1.protocol</h1><div class="highlight"><pre>
<span class="c">###############################################################################</span>
<span class="c">##</span>
<span class="c">##  Copyright (C) 2011-2013 Tavendo GmbH</span>
<span class="c">##</span>
<span class="c">##  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c">##  you may not use this file except in compliance with the License.</span>
<span class="c">##  You may obtain a copy of the License at</span>
<span class="c">##</span>
<span class="c">##      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">##</span>
<span class="c">##  Unless required by applicable law or agreed to in writing, software</span>
<span class="c">##  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c">##  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c">##  See the License for the specific language governing permissions and</span>
<span class="c">##  limitations under the License.</span>
<span class="c">##</span>
<span class="c">###############################################################################</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">PY3</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;WampProtocol&quot;</span><span class="p">,</span>
           <span class="s">&quot;WampFactory&quot;</span><span class="p">,</span>
           <span class="s">&quot;WampServerProtocol&quot;</span><span class="p">,</span>
           <span class="s">&quot;WampServerFactory&quot;</span><span class="p">,</span>
           <span class="s">&quot;WampClientProtocol&quot;</span><span class="p">,</span>
           <span class="s">&quot;WampClientFactory&quot;</span><span class="p">,</span>
           <span class="s">&quot;WampCraProtocol&quot;</span><span class="p">,</span>
           <span class="s">&quot;WampCraClientProtocol&quot;</span><span class="p">,</span>
           <span class="s">&quot;WampCraServerProtocol&quot;</span><span class="p">,</span>
           <span class="s">&quot;json_lib&quot;</span><span class="p">,</span>
           <span class="s">&quot;json_loads&quot;</span><span class="p">,</span>
           <span class="s">&quot;json_dumps&quot;</span><span class="p">,)</span>


<span class="kn">import</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
   <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="k">else</span><span class="p">:</span>
   <span class="kn">import</span> <span class="nn">StringIO</span>

<span class="kn">import</span> <span class="nn">hashlib</span><span class="o">,</span> <span class="nn">hmac</span><span class="o">,</span> <span class="nn">binascii</span><span class="o">,</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span><span class="p">,</span> \
                                   <span class="n">maybeDeferred</span>

<span class="kn">from</span> <span class="nn">autobahn</span> <span class="kn">import</span> <span class="n">__version__</span>

<span class="kn">from</span> <span class="nn">autobahn.websocket.protocol</span> <span class="kn">import</span> <span class="n">WebSocketProtocol</span><span class="p">,</span> \
                                        <span class="n">Timings</span>
<span class="kn">from</span> <span class="nn">autobahn.websocket</span> <span class="kn">import</span> <span class="n">http</span>
<span class="kn">from</span> <span class="nn">autobahn.twisted.websocket</span> <span class="kn">import</span> <span class="n">WebSocketClientProtocol</span><span class="p">,</span> \
                                       <span class="n">WebSocketClientFactory</span><span class="p">,</span> \
                                       <span class="n">WebSocketServerFactory</span><span class="p">,</span> \
                                       <span class="n">WebSocketServerProtocol</span>
<span class="kn">from</span> <span class="nn">autobahn.wamp1.pbkdf2</span> <span class="kn">import</span> <span class="n">pbkdf2_bin</span>
<span class="kn">from</span> <span class="nn">autobahn.wamp1.prefixmap</span> <span class="kn">import</span> <span class="n">PrefixMap</span>
<span class="kn">from</span> <span class="nn">autobahn.util</span> <span class="kn">import</span> <span class="n">utcnow</span><span class="p">,</span> <span class="n">newid</span>


<span class="k">def</span> <span class="nf">exportRpc</span><span class="p">(</span><span class="n">arg</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Decorator for RPC&#39;ed callables.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="c">## decorator without argument</span>
   <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">is</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">:</span>
      <span class="n">arg</span><span class="o">.</span><span class="n">_autobahn_rpc_id</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">__name__</span>
      <span class="k">return</span> <span class="n">arg</span>
   <span class="c">## decorator with argument</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
         <span class="n">f</span><span class="o">.</span><span class="n">_autobahn_rpc_id</span> <span class="o">=</span> <span class="n">arg</span>
         <span class="k">return</span> <span class="n">f</span>
      <span class="k">return</span> <span class="n">inner</span>

<span class="k">def</span> <span class="nf">exportSub</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">prefixMatch</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Decorator for subscription handlers.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
      <span class="n">f</span><span class="o">.</span><span class="n">_autobahn_sub_id</span> <span class="o">=</span> <span class="n">arg</span>
      <span class="n">f</span><span class="o">.</span><span class="n">_autobahn_sub_prefix_match</span> <span class="o">=</span> <span class="n">prefixMatch</span>
      <span class="k">return</span> <span class="n">f</span>
   <span class="k">return</span> <span class="n">inner</span>

<span class="k">def</span> <span class="nf">exportPub</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">prefixMatch</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Decorator for publication handlers.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
      <span class="n">f</span><span class="o">.</span><span class="n">_autobahn_pub_id</span> <span class="o">=</span> <span class="n">arg</span>
      <span class="n">f</span><span class="o">.</span><span class="n">_autobahn_pub_prefix_match</span> <span class="o">=</span> <span class="n">prefixMatch</span>
      <span class="k">return</span> <span class="n">f</span>
   <span class="k">return</span> <span class="n">inner</span>


<div class="viewcode-block" id="WampProtocol"><a class="viewcode-back" href="../../../wamp1base.html#autobahn.wamp1.protocol.WampProtocol">[docs]</a><span class="k">class</span> <span class="nc">WampProtocol</span><span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   WAMP protocol base class. Mixin for WampServerProtocol and WampClientProtocol.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">URI_WAMP_BASE</span> <span class="o">=</span> <span class="s">&quot;http://api.wamp.ws/&quot;</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   WAMP base URI for WAMP predefined things.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">URI_WAMP_ERROR</span> <span class="o">=</span> <span class="n">URI_WAMP_BASE</span> <span class="o">+</span> <span class="s">&quot;error#&quot;</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Prefix for WAMP errors.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">URI_WAMP_PROCEDURE</span> <span class="o">=</span> <span class="n">URI_WAMP_BASE</span> <span class="o">+</span> <span class="s">&quot;procedure#&quot;</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Prefix for WAMP predefined RPC endpoints.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">URI_WAMP_TOPIC</span> <span class="o">=</span> <span class="n">URI_WAMP_BASE</span> <span class="o">+</span> <span class="s">&quot;topic#&quot;</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Prefix for WAMP predefined PubSub topics.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">URI_WAMP_ERROR_GENERIC</span> <span class="o">=</span> <span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;generic&quot;</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   WAMP error URI for generic errors.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">DESC_WAMP_ERROR_GENERIC</span> <span class="o">=</span> <span class="s">&quot;generic error&quot;</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Description for WAMP generic errors.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">URI_WAMP_ERROR_INTERNAL</span> <span class="o">=</span> <span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;internal&quot;</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   WAMP error URI for internal errors.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">DESC_WAMP_ERROR_INTERNAL</span> <span class="o">=</span> <span class="s">&quot;internal error&quot;</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Description for WAMP internal errors.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">URI_WAMP_ERROR_NO_SUCH_RPC_ENDPOINT</span> <span class="o">=</span> <span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;NoSuchRPCEndpoint&quot;</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   WAMP error URI for RPC endpoint not found.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">WAMP_PROTOCOL_VERSION</span>         <span class="o">=</span> <span class="mi">1</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   WAMP version this server speaks. Versions are numbered consecutively</span>
<span class="sd">   (integers, no gaps).</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">MESSAGE_TYPEID_WELCOME</span>        <span class="o">=</span> <span class="mi">0</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Server-to-client welcome message containing session ID.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">MESSAGE_TYPEID_PREFIX</span>         <span class="o">=</span> <span class="mi">1</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Client-to-server message establishing a URI prefix to be used in CURIEs.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">MESSAGE_TYPEID_CALL</span>           <span class="o">=</span> <span class="mi">2</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Client-to-server message initiating an RPC.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">MESSAGE_TYPEID_CALL_RESULT</span>    <span class="o">=</span> <span class="mi">3</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Server-to-client message returning the result of a successful RPC.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">MESSAGE_TYPEID_CALL_ERROR</span>     <span class="o">=</span> <span class="mi">4</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Server-to-client message returning the error of a failed RPC.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">MESSAGE_TYPEID_SUBSCRIBE</span>      <span class="o">=</span> <span class="mi">5</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Client-to-server message subscribing to a topic.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">MESSAGE_TYPEID_UNSUBSCRIBE</span>    <span class="o">=</span> <span class="mi">6</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Client-to-server message unsubscribing from a topic.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">MESSAGE_TYPEID_PUBLISH</span>        <span class="o">=</span> <span class="mi">7</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Client-to-server message publishing an event to a topic.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">MESSAGE_TYPEID_EVENT</span>          <span class="o">=</span> <span class="mi">8</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Server-to-client message providing the event of a (subscribed) topic.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">debugWamp</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">debugApp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">debugApp</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span> <span class="o">=</span> <span class="n">PrefixMap</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">calls</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">=</span> <span class="p">{}</span>


   <span class="k">def</span> <span class="nf">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="k">pass</span>


   <span class="k">def</span> <span class="nf">_protocolError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Closing Wamp session on protocol violation : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">reason</span><span class="p">)</span>

      <span class="c">## FIXME: subprotocols are probably not supposed to close with CLOSE_STATUS_CODE_PROTOCOL_ERROR</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;Wamp RPC/PubSub protocol violation (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">reason</span><span class="p">)</span>


<div class="viewcode-block" id="WampProtocol.shrink"><a class="viewcode-back" href="../../../wamp1base.html#autobahn.wamp1.protocol.WampProtocol.shrink">[docs]</a>   <span class="k">def</span> <span class="nf">shrink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">passthrough</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Shrink given URI to CURIE according to current prefix mapping.</span>
<span class="sd">      If no appropriate prefix mapping is available, return original URI.</span>

<span class="sd">      :param uri: URI to shrink.</span>
<span class="sd">      :type uri: str</span>

<span class="sd">      :returns str -- CURIE or original URI.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WampProtocol.resolve"><a class="viewcode-back" href="../../../wamp1base.html#autobahn.wamp1.protocol.WampProtocol.resolve">[docs]</a>   <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curieOrUri</span><span class="p">,</span> <span class="n">passthrough</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Resolve given CURIE/URI according to current prefix mapping or return</span>
<span class="sd">      None if cannot be resolved.</span>

<span class="sd">      :param curieOrUri: CURIE or URI.</span>
<span class="sd">      :type curieOrUri: str</span>

<span class="sd">      :returns: str -- Full URI for CURIE or None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">curieOrUri</span><span class="p">)</span>

</div>
   <span class="k">def</span> <span class="nf">resolveOrPass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curieOrUri</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Resolve given CURIE/URI according to current prefix mapping or return</span>
<span class="sd">      string verbatim if cannot be resolved.</span>

<span class="sd">      :param curieOrUri: CURIE or URI.</span>
<span class="sd">      :type curieOrUri: str</span>

<span class="sd">      :returns: str -- Full URI for CURIE or original string.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">resolveOrPass</span><span class="p">(</span><span class="n">curieOrUri</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">serializeMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Delegate message serialization to the factory.</span>
<span class="sd">      :param msg: The message to be serialized.</span>
<span class="sd">      :type msg: str</span>
<span class="sd">      :return: The serialized message.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">registerForRpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">baseUri</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Register an service object for RPC. A service object has methods</span>
<span class="sd">      which are decorated using @exportRpc.</span>

<span class="sd">      :param obj: The object to be registered (in this WebSockets session) for RPC.</span>
<span class="sd">      :type obj: Object with methods decorated using @exportRpc.</span>
<span class="sd">      :param baseUri: Optional base URI which is prepended to method names for export.</span>
<span class="sd">      :type baseUri: String.</span>
<span class="sd">      :param methods: If not None, a list of unbound class methods corresponding to obj</span>
<span class="sd">                     which should be registered. This can be used to register only a subset</span>
<span class="sd">                     of the methods decorated with @exportRpc.</span>
<span class="sd">      :type methods: List of unbound class methods.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">):</span>
         <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;_autobahn_rpc_id&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">methods</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
               <span class="n">uri</span> <span class="o">=</span> <span class="n">baseUri</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&quot;_autobahn_rpc_id&quot;</span><span class="p">]</span>
               <span class="n">proc</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">registerMethodForRpc</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">registerMethodForRpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">proc</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Register a method of an object for RPC.</span>

<span class="sd">      :param uri: URI to register RPC method under.</span>
<span class="sd">      :type uri: str</span>
<span class="sd">      :param obj: The object on which to register a method for RPC.</span>
<span class="sd">      :type obj: object</span>
<span class="sd">      :param proc: Unbound object method to register RPC for.</span>
<span class="sd">      :type proc: unbound method</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;registered remote method on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">uri</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">registerProcedureForRpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">proc</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Register a (free standing) function/procedure for RPC.</span>

<span class="sd">      :param uri: URI to register RPC function/procedure under.</span>
<span class="sd">      :type uri: str</span>
<span class="sd">      :param proc: Free-standing function/procedure.</span>
<span class="sd">      :type proc: callable</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;registered remote procedure on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">uri</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">registerHandlerMethodForRpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">extra</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Register a handler on an object for RPC.</span>

<span class="sd">      :param uri: URI to register RPC method under.</span>
<span class="sd">      :type uri: str</span>
<span class="sd">      :param obj: The object on which to register the RPC handler</span>
<span class="sd">      :type obj: object</span>
<span class="sd">      :param proc: Unbound object method to register RPC for.</span>
<span class="sd">      :type proc: unbound method</span>
<span class="sd">      :param extra: Optional extra data that will be given to the handler at call time.</span>
<span class="sd">      :type extra: object</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;registered remote handler method on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">uri</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">registerHandlerProcedureForRpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">extra</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Register a (free standing) handler for RPC.</span>

<span class="sd">      :param uri: URI to register RPC handler under.</span>
<span class="sd">      :type uri: str</span>
<span class="sd">      :param proc: Free-standing handler</span>
<span class="sd">      :type proc: callable</span>
<span class="sd">      :param extra: Optional extra data that will be given to the handler at call time.</span>
<span class="sd">      :type extra: object</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;registered remote handler procedure on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">uri</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">procForUri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Returns the procedure specification for `uri` or None, if it does not exist.</span>

<span class="sd">      :param uri: URI to be checked.</span>
<span class="sd">      :type uri: str</span>
<span class="sd">      :returns: The procedure specification for `uri`, if it exists,</span>
<span class="sd">                `None` otherwise.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="k">if</span> <span class="n">uri</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="k">else</span> <span class="bp">None</span>


   <span class="k">def</span> <span class="nf">onBeforeCall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callid</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">isRegistered</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback fired before executing incoming RPC. This can be used for</span>
<span class="sd">      logging, statistics tracking or redirecting RPCs or argument mangling i.e.</span>

<span class="sd">      The default implementation just returns the incoming URI/args.</span>

<span class="sd">      :param uri: RPC endpoint URI (fully-qualified).</span>
<span class="sd">      :type uri: str</span>
<span class="sd">      :param args: RPC arguments array.</span>
<span class="sd">      :type args: list</span>
<span class="sd">      :param isRegistered: True, iff RPC endpoint URI is registered in this session.</span>
<span class="sd">      :type isRegistered: bool</span>
<span class="sd">      :returns pair -- Must return URI/Args pair.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="n">uri</span><span class="p">,</span> <span class="n">args</span>


   <span class="k">def</span> <span class="nf">onAfterCallSuccess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback fired after executing incoming RPC with success, but before</span>
<span class="sd">      sending the RPC success message.</span>

<span class="sd">      The default implementation will just return `result` to the client.</span>

<span class="sd">      :param result: Result returned for executing the incoming RPC.</span>
<span class="sd">      :type result: Anything returned by the user code for the endpoint.</span>
<span class="sd">      :param call: WAMP call object for incoming RPC.</span>
<span class="sd">      :type call: instance of Call</span>
<span class="sd">      :returns obj -- Result send back to client.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="n">result</span>


   <span class="k">def</span> <span class="nf">onAfterCallError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback fired after executing incoming RPC with failure, but before</span>
<span class="sd">      sending the RPC error message.</span>

<span class="sd">      The default implementation will just return `error` to the client.</span>

<span class="sd">      :param error: Error that occurred during incomnig RPC call execution.</span>
<span class="sd">      :type error: Instance of twisted.python.failure.Failure</span>
<span class="sd">      :param call: WAMP call object for incoming RPC.</span>
<span class="sd">      :type call: instance of Call</span>
<span class="sd">      :returns twisted.python.failure.Failure -- Error sent back to client.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="n">error</span>


   <span class="k">def</span> <span class="nf">onAfterSendCallSuccess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback fired after sending RPC success message.</span>

<span class="sd">      :param msg: Serialized WAMP message.</span>
<span class="sd">      :type msg: str</span>
<span class="sd">      :param call: WAMP call object for incoming RPC.</span>
<span class="sd">      :type call: instance of Call</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">pass</span>


   <span class="k">def</span> <span class="nf">onAfterSendCallError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback fired after sending RPC error message.</span>

<span class="sd">      :param msg: Serialized WAMP message.</span>
<span class="sd">      :type msg: str</span>
<span class="sd">      :param call: WAMP call object for incoming RPC.</span>
<span class="sd">      :type call: instance of Call</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">pass</span>


   <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Perform a remote-procedure call (RPC). The first argument is the procedure</span>
<span class="sd">      URI (mandatory). Subsequent positional arguments can be provided (must be</span>
<span class="sd">      JSON serializable). The return value is a Twisted Deferred.</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;missing procedure URI&quot;</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for procedure URI&quot;</span><span class="p">)</span>

      <span class="n">procuri</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
         <span class="n">callid</span> <span class="o">=</span> <span class="n">newid</span><span class="p">()</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calls</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">callid</span><span class="p">):</span>
            <span class="k">break</span>
      <span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">calls</span><span class="p">[</span><span class="n">callid</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL</span><span class="p">,</span> <span class="n">callid</span><span class="p">,</span> <span class="n">procuri</span><span class="p">]</span>
      <span class="n">msg</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

      <span class="k">try</span><span class="p">:</span>
         <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;call argument(s) not JSON serializable&quot;</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">d</span>



<span class="c">## use Ultrajson (https://github.com/esnme/ultrajson) if available</span>
<span class="c">##</span></div>
<span class="k">try</span><span class="p">:</span>
   <span class="kn">import</span> <span class="nn">ujson</span>
   <span class="n">json_lib</span> <span class="o">=</span> <span class="n">ujson</span>
   <span class="n">json_loads</span> <span class="o">=</span> <span class="n">ujson</span><span class="o">.</span><span class="n">loads</span>
   <span class="n">json_dumps</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ujson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ensure_ascii</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
   <span class="kn">import</span> <span class="nn">json</span>
   <span class="n">json_lib</span> <span class="o">=</span> <span class="n">json</span>
   <span class="n">json_loads</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span>
   <span class="n">json_dumps</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span>



<div class="viewcode-block" id="WampFactory"><a class="viewcode-back" href="../../../wamp1base.html#autobahn.wamp1.protocol.WampFactory">[docs]</a><span class="k">class</span> <span class="nc">WampFactory</span><span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   WAMP factory base class. Mixin for WampServerFactory and WampClientFactory.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Using JSON processor &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">json_lib</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Default object serializer.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="n">json_dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_unserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Default object deserializer.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="n">json_loads</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="WampServerProtocol"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerProtocol">[docs]</a><span class="k">class</span> <span class="nc">WampServerProtocol</span><span class="p">(</span><span class="n">WebSocketServerProtocol</span><span class="p">,</span> <span class="n">WampProtocol</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Server factory for Wamp RPC/PubSub.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">SUBSCRIBE</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="n">PUBLISH</span> <span class="o">=</span> <span class="mi">2</span>

<div class="viewcode-block" id="WampServerProtocol.onSessionOpen"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerProtocol.onSessionOpen">[docs]</a>   <span class="k">def</span> <span class="nf">onSessionOpen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback fired when WAMP session was fully established.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">pass</span>

</div>
   <span class="k">def</span> <span class="nf">onOpen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Default implementation for WAMP connection opened sends</span>
<span class="sd">      Welcome message containing session ID.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">newid</span><span class="p">()</span>

      <span class="c">## include traceback as error detail for RPC errors with</span>
      <span class="c">## no error URI - that is errors returned with URI_WAMP_ERROR_GENERIC</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">includeTraceback</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_WELCOME</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
             <span class="n">WampProtocol</span><span class="o">.</span><span class="n">WAMP_PROTOCOL_VERSION</span><span class="p">,</span>
             <span class="s">&quot;Autobahn/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">__version__</span><span class="p">]</span>
      <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_addSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">onSessionOpen</span><span class="p">()</span>


   <span class="k">def</span> <span class="nf">onConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connectionRequest</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Default implementation for WAMP connection acceptance:</span>
<span class="sd">      check if client announced WAMP subprotocol, and only accept connection</span>
<span class="sd">      if client did so.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">connectionRequest</span><span class="o">.</span><span class="n">protocols</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">protocols</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">{})</span> <span class="c"># return (protocol, headers)</span>
      <span class="k">raise</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpException</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;this server only speaks WAMP&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">WebSocketServerProtocol</span><span class="o">.</span><span class="n">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="n">WampProtocol</span><span class="o">.</span><span class="n">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

      <span class="c">## RPCs registered in this session (a URI map of (object, procedure)</span>
      <span class="c">## pairs for object methods or (None, procedure) for free standing procedures)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">=</span> <span class="p">{}</span>

      <span class="c">## Publication handlers registered in this session (a URI map of (object, pubHandler) pairs</span>
      <span class="c">## pairs for object methods (handlers) or (None, None) for topic without handler)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">pubHandlers</span> <span class="o">=</span> <span class="p">{}</span>

      <span class="c">## Subscription handlers registered in this session (a URI map of (object, subHandler) pairs</span>
      <span class="c">## pairs for object methods (handlers) or (None, None) for topic without handler)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subHandlers</span> <span class="o">=</span> <span class="p">{}</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">handlerMapping</span> <span class="o">=</span> <span class="p">{</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL</span><span class="p">:</span> <span class="n">CallHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="p">),</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_RESULT</span><span class="p">:</span> <span class="n">CallResultHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="p">),</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_ERROR</span><span class="p">:</span> <span class="n">CallErrorHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="p">)}</span>


   <span class="k">def</span> <span class="nf">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_unsubscribeClient</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_removeSession</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

      <span class="n">WampProtocol</span><span class="o">.</span><span class="n">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
      <span class="n">WebSocketServerProtocol</span><span class="o">.</span><span class="n">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">payload</span><span class="p">,</span>
                   <span class="n">binary</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="n">payload_frag_size</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                   <span class="n">sync</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="n">doNotCompress</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;TX WAMP: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
      <span class="n">WebSocketServerProtocol</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                          <span class="n">payload</span><span class="p">,</span>
                                          <span class="n">binary</span><span class="p">,</span>
                                          <span class="n">payload_frag_size</span><span class="p">,</span>
                                          <span class="n">sync</span><span class="p">,</span>
                                          <span class="n">doNotCompress</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_getPubHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">):</span>
      <span class="c">## Longest matching prefix based resolution of (full) topic URI to</span>
      <span class="c">## publication handler.</span>
      <span class="c">## Returns a 5-tuple (consumedUriPart, unconsumedUriPart, handlerObj, handlerProc, prefixMatch)</span>
      <span class="c">##</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">topicUri</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
         <span class="n">tt</span> <span class="o">=</span> <span class="n">topicUri</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubHandlers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">tt</span><span class="p">):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubHandlers</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
      <span class="k">return</span> <span class="bp">None</span>


   <span class="k">def</span> <span class="nf">_getSubHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">):</span>
      <span class="c">## Longest matching prefix based resolution of (full) topic URI to</span>
      <span class="c">## subscription handler.</span>
      <span class="c">## Returns a 5-tuple (consumedUriPart, unconsumedUriPart, handlerObj, handlerProc, prefixMatch)</span>
      <span class="c">##</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">topicUri</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
         <span class="n">tt</span> <span class="o">=</span> <span class="n">topicUri</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subHandlers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">tt</span><span class="p">):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subHandlers</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
      <span class="k">return</span> <span class="bp">None</span>


<div class="viewcode-block" id="WampServerProtocol.registerForPubSub"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerProtocol.registerForPubSub">[docs]</a>   <span class="k">def</span> <span class="nf">registerForPubSub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">,</span> <span class="n">prefixMatch</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">pubsub</span> <span class="o">=</span> <span class="n">PUBLISH</span> <span class="o">|</span> <span class="n">SUBSCRIBE</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Register a topic URI as publish/subscribe channel in this session.</span>

<span class="sd">      :param topicUri: Topic URI to be established as publish/subscribe channel.</span>
<span class="sd">      :type topicUri: str</span>
<span class="sd">      :param prefixMatch: Allow to match this topic URI by prefix.</span>
<span class="sd">      :type prefixMatch: bool</span>
<span class="sd">      :param pubsub: Allow publication and/or subscription.</span>
<span class="sd">      :type pubsub: WampServerProtocol.PUB, WampServerProtocol.SUB, WampServerProtocol.PUB | WampServerProtocol.SUB</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">pubsub</span> <span class="o">&amp;</span> <span class="n">WampServerProtocol</span><span class="o">.</span><span class="n">PUBLISH</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">pubHandlers</span><span class="p">[</span><span class="n">topicUri</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">prefixMatch</span><span class="p">)</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;registered topic </span><span class="si">%s</span><span class="s"> for publication (match by prefix = </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">topicUri</span><span class="p">,</span> <span class="n">prefixMatch</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">pubsub</span> <span class="o">&amp;</span> <span class="n">WampServerProtocol</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">subHandlers</span><span class="p">[</span><span class="n">topicUri</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">prefixMatch</span><span class="p">)</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;registered topic </span><span class="si">%s</span><span class="s"> for subscription (match by prefix = </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">topicUri</span><span class="p">,</span> <span class="n">prefixMatch</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="WampServerProtocol.registerHandlerForPubSub"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerProtocol.registerHandlerForPubSub">[docs]</a>   <span class="k">def</span> <span class="nf">registerHandlerForPubSub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">baseUri</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Register a handler object for PubSub. A handler object has methods</span>
<span class="sd">      which are decorated using @exportPub and @exportSub.</span>

<span class="sd">      :param obj: The object to be registered (in this WebSockets session) for PubSub.</span>
<span class="sd">      :type obj: Object with methods decorated using @exportPub and @exportSub.</span>
<span class="sd">      :param baseUri: Optional base URI which is prepended to topic names for export.</span>
<span class="sd">      :type baseUri: String.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">):</span>
         <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;_autobahn_pub_id&quot;</span><span class="p">):</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">baseUri</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&quot;_autobahn_pub_id&quot;</span><span class="p">]</span>
            <span class="n">prefixMatch</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&quot;_autobahn_pub_prefix_match&quot;</span><span class="p">]</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registerHandlerForPub</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">prefixMatch</span><span class="p">)</span>
         <span class="k">elif</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;_autobahn_sub_id&quot;</span><span class="p">):</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">baseUri</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&quot;_autobahn_sub_id&quot;</span><span class="p">]</span>
            <span class="n">prefixMatch</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&quot;_autobahn_sub_prefix_match&quot;</span><span class="p">]</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registerHandlerForSub</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">prefixMatch</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WampServerProtocol.registerHandlerForSub"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerProtocol.registerHandlerForSub">[docs]</a>   <span class="k">def</span> <span class="nf">registerHandlerForSub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">prefixMatch</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Register a method of an object as subscription handler.</span>

<span class="sd">      :param uri: Topic URI to register subscription handler for.</span>
<span class="sd">      :type uri: str</span>
<span class="sd">      :param obj: The object on which to register a method as subscription handler.</span>
<span class="sd">      :type obj: object</span>
<span class="sd">      :param proc: Unbound object method to register as subscription handler.</span>
<span class="sd">      :type proc: unbound method</span>
<span class="sd">      :param prefixMatch: Allow to match this topic URI by prefix.</span>
<span class="sd">      :type prefixMatch: bool</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subHandlers</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">prefixMatch</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubHandlers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">pubHandlers</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;registered subscription handler for topic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">uri</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WampServerProtocol.registerHandlerForPub"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerProtocol.registerHandlerForPub">[docs]</a>   <span class="k">def</span> <span class="nf">registerHandlerForPub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">prefixMatch</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Register a method of an object as publication handler.</span>

<span class="sd">      :param uri: Topic URI to register publication handler for.</span>
<span class="sd">      :type uri: str</span>
<span class="sd">      :param obj: The object on which to register a method as publication handler.</span>
<span class="sd">      :type obj: object</span>
<span class="sd">      :param proc: Unbound object method to register as publication handler.</span>
<span class="sd">      :type proc: unbound method</span>
<span class="sd">      :param prefixMatch: Allow to match this topic URI by prefix.</span>
<span class="sd">      :type prefixMatch: bool</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">pubHandlers</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">prefixMatch</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subHandlers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">subHandlers</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;registered publication handler for topic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">uri</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WampServerProtocol.dispatch"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerProtocol.dispatch">[docs]</a>   <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">exclude</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">eligible</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Dispatch an event for a topic to all clients subscribed to</span>
<span class="sd">      and authorized for that topic.</span>

<span class="sd">      Optionally, exclude list of clients and/or only consider clients</span>
<span class="sd">      from explicit eligibles. In other words, the event is delivered</span>
<span class="sd">      to the set</span>

<span class="sd">         (subscribers - excluded) &amp; eligible</span>

<span class="sd">      :param topicUri: URI of topic to publish event to.</span>
<span class="sd">      :type topicUri: str</span>
<span class="sd">      :param event: Event to dispatch.</span>
<span class="sd">      :type event: obj</span>
<span class="sd">      :param exclude: Optional list of clients (WampServerProtocol instances) to exclude.</span>
<span class="sd">      :type exclude: list of obj</span>
<span class="sd">      :param eligible: Optional list of clients (WampServerProtocol instances) eligible at all (or None for all).</span>
<span class="sd">      :type eligible: list of obj</span>

<span class="sd">      :returns twisted.internet.defer.Deferred -- Will be fired when event was</span>
<span class="sd">      dispatched to all subscribers. The return value provided to the deferred</span>
<span class="sd">      is a pair (delivered, requested), where delivered = number of actual</span>
<span class="sd">      receivers, and requested = number of (subscribers - excluded) &amp; eligible.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">topicUri</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">eligible</span><span class="p">)</span>

</div>
   <span class="k">def</span> <span class="nf">onMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">binary</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Handle WAMP messages received from WAMP client.</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;RX WAMP: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">binary</span><span class="p">:</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_unserialize</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>

               <span class="n">msgtype</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

               <span class="c">### XXX Replace check by try...except when all handlers</span>
               <span class="c">### XXX are in place. Exception handling should create</span>
               <span class="c">### XXX a protocolError message about unsupported</span>
               <span class="c">### XXX message type</span>
               <span class="k">if</span> <span class="n">msgtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL</span><span class="p">,</span>
                              <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_RESULT</span><span class="p">,</span>
                              <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_ERROR</span><span class="p">]:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">handlerMapping</span><span class="p">[</span><span class="n">msgtype</span><span class="p">]</span><span class="o">.</span><span class="n">handleMessage</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

               <span class="c">### XXX Move remaining code to appropriate handlers</span>

               <span class="c">## Subscribe Message</span>
               <span class="c">##</span>
               <span class="k">elif</span> <span class="n">msgtype</span> <span class="o">==</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_SUBSCRIBE</span><span class="p">:</span>
                  <span class="n">topicUri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">resolveOrPass</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c">### PFX - remove</span>
                  <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getSubHandler</span><span class="p">(</span><span class="n">topicUri</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">h</span><span class="p">:</span>
                     <span class="c">## either exact match or prefix match allowed</span>
                     <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="n">h</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>

                        <span class="c">## direct topic</span>
                        <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_subscribeClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">)</span>

                        <span class="c">## topic handled by subscription handler</span>
                        <span class="k">else</span><span class="p">:</span>
                           <span class="c">## handler is object method</span>
                           <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                              <span class="n">a</span> <span class="o">=</span> <span class="n">maybeDeferred</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                           <span class="c">## handler is free standing procedure</span>
                           <span class="k">else</span><span class="p">:</span>
                              <span class="n">a</span> <span class="o">=</span> <span class="n">maybeDeferred</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                           <span class="k">def</span> <span class="nf">fail</span><span class="p">(</span><span class="n">failure</span><span class="p">):</span>
                              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
                                 <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;exception during custom subscription handler: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">failure</span><span class="p">)</span>

                           <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                              <span class="c">## only subscribe client if handler did return True</span>
                              <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_subscribeClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">)</span>

                           <span class="n">a</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">done</span><span class="p">)</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span>
                     <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
                           <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;topic </span><span class="si">%s</span><span class="s"> matches only by prefix and prefix match disallowed&quot;</span> <span class="o">%</span> <span class="n">topicUri</span><span class="p">)</span>
                  <span class="k">else</span><span class="p">:</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;no topic / subscription handler registered for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">topicUri</span><span class="p">)</span>

               <span class="c">## Unsubscribe Message</span>
               <span class="c">##</span>
               <span class="k">elif</span> <span class="n">msgtype</span> <span class="o">==</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_UNSUBSCRIBE</span><span class="p">:</span>
                  <span class="n">topicUri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">resolveOrPass</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c">### PFX - remove</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_unsubscribeClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">)</span>

               <span class="c">## Publish Message</span>
               <span class="c">##</span>
               <span class="k">elif</span> <span class="n">msgtype</span> <span class="o">==</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_PUBLISH</span><span class="p">:</span>
                  <span class="n">topicUri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">resolveOrPass</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c">### PFX - remove</span>
                  <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPubHandler</span><span class="p">(</span><span class="n">topicUri</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">h</span><span class="p">:</span>
                     <span class="c">## either exact match or prefix match allowed</span>
                     <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="n">h</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>

                        <span class="c">## Event</span>
                        <span class="c">##</span>
                        <span class="n">event</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                        <span class="c">## Exclude Sessions List</span>
                        <span class="c">##</span>
                        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="c"># exclude publisher by default</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                           <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                              <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                                 <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
                           <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                              <span class="c">## map session IDs to protos</span>
                              <span class="n">exclude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">sessionIdsToProtos</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                           <span class="k">else</span><span class="p">:</span>
                              <span class="c">## FIXME: invalid type</span>
                              <span class="k">pass</span>

                        <span class="c">## Eligible Sessions List</span>
                        <span class="c">##</span>
                        <span class="n">eligible</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># all sessions are eligible by default</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                           <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                              <span class="c">## map session IDs to protos</span>
                              <span class="n">eligible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">sessionIdsToProtos</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                           <span class="k">else</span><span class="p">:</span>
                              <span class="c">## FIXME: invalid type</span>
                              <span class="k">pass</span>

                        <span class="c">## direct topic</span>
                        <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">topicUri</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">eligible</span><span class="p">)</span>

                        <span class="c">## topic handled by publication handler</span>
                        <span class="k">else</span><span class="p">:</span>
                           <span class="c">## handler is object method</span>
                           <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                              <span class="n">e</span> <span class="o">=</span> <span class="n">maybeDeferred</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">event</span><span class="p">)</span>

                           <span class="c">## handler is free standing procedure</span>
                           <span class="k">else</span><span class="p">:</span>
                              <span class="n">e</span> <span class="o">=</span> <span class="n">maybeDeferred</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">event</span><span class="p">)</span>

                           <span class="k">def</span> <span class="nf">fail</span><span class="p">(</span><span class="n">failure</span><span class="p">):</span>
                              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
                                 <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;exception during custom publication handler: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">failure</span><span class="p">)</span>

                           <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                              <span class="c">## only dispatch event if handler did return event</span>
                              <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">topicUri</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">eligible</span><span class="p">)</span>

                           <span class="n">e</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">done</span><span class="p">)</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span>
                     <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
                           <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;topic </span><span class="si">%s</span><span class="s"> matches only by prefix and prefix match disallowed&quot;</span> <span class="o">%</span> <span class="n">topicUri</span><span class="p">)</span>
                  <span class="k">else</span><span class="p">:</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;no topic / publication handler registered for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">topicUri</span><span class="p">)</span>

               <span class="c">## Define prefix to be used in CURIEs</span>
               <span class="c">##</span>
               <span class="k">elif</span> <span class="n">msgtype</span> <span class="o">==</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_PREFIX</span><span class="p">:</span>
                  <span class="n">prefix</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                  <span class="n">uri</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span> <span class="c">### PFX - remove whole block (this msg type won&#39;t survive)</span>

               <span class="k">else</span><span class="p">:</span>
                  <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;unknown message type&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;msg not a list&quot;</span><span class="p">)</span>
         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;binary message&quot;</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="WampServerFactory"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerFactory">[docs]</a><span class="k">class</span> <span class="nc">WampServerFactory</span><span class="p">(</span><span class="n">WebSocketServerFactory</span><span class="p">,</span> <span class="n">WampFactory</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Server factory for Wamp RPC/PubSub.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">protocol</span> <span class="o">=</span> <span class="n">WampServerProtocol</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Twisted protocol used by default for WAMP servers.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">debugCodePaths</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">debugWamp</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">debugApp</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">externalPort</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                <span class="n">reactor</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span> <span class="o">=</span> <span class="n">debugWamp</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">debugApp</span> <span class="o">=</span> <span class="n">debugApp</span>
      <span class="n">WebSocketServerFactory</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                      <span class="n">url</span><span class="p">,</span>
                                      <span class="n">protocols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;wamp&quot;</span><span class="p">],</span>
                                      <span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">,</span>
                                      <span class="n">debugCodePaths</span> <span class="o">=</span> <span class="n">debugCodePaths</span><span class="p">,</span>
                                      <span class="n">externalPort</span> <span class="o">=</span> <span class="n">externalPort</span><span class="p">,</span>
                                      <span class="n">reactor</span> <span class="o">=</span> <span class="n">reactor</span><span class="p">)</span>
      <span class="n">WampFactory</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">onClientSubscribed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback fired when peer was (successfully) subscribed on some topic.</span>

<span class="sd">      :param proto: Peer protocol instance subscribed.</span>
<span class="sd">      :type proto: Instance of WampServerProtocol.</span>
<span class="sd">      :param topicUri: Fully qualified, resolved URI of topic subscribed.</span>
<span class="sd">      :type topicUri: str</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">pass</span>


   <span class="k">def</span> <span class="nf">_subscribeClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Called from proto to subscribe client for topic.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">topicUri</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;subscriptions map created for topic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">topicUri</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">proto</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">]:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">proto</span><span class="p">)</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;subscribed peer </span><span class="si">%s</span><span class="s"> on topic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">))</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">onClientSubscribed</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;peer </span><span class="si">%s</span><span class="s"> already subscribed on topic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">))</span>


   <span class="k">def</span> <span class="nf">onClientUnsubscribed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback fired when peer was (successfully) unsubscribed from some topic.</span>

<span class="sd">      :param proto: Peer protocol instance unsubscribed.</span>
<span class="sd">      :type proto: Instance of WampServerProtocol.</span>
<span class="sd">      :param topicUri: Fully qualified, resolved URI of topic unsubscribed.</span>
<span class="sd">      :type topicUri: str</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">pass</span>


   <span class="k">def</span> <span class="nf">_unsubscribeClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">topicUri</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Called from proto to unsubscribe client from topic.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">topicUri</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">topicUri</span><span class="p">)</span> <span class="ow">and</span> <span class="n">proto</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">]</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">proto</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
               <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;unsubscribed peer </span><span class="si">%s</span><span class="s"> from topic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
               <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">]</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
                  <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;topic </span><span class="si">%s</span><span class="s"> removed from subscriptions map - no one subscribed anymore&quot;</span> <span class="o">%</span> <span class="n">topicUri</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onClientUnsubscribed</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
               <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;peer </span><span class="si">%s</span><span class="s"> not subscribed on topic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">topicUri</span><span class="p">,</span> <span class="n">subscribers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">proto</span> <span class="ow">in</span> <span class="n">subscribers</span><span class="p">:</span>
               <span class="n">subscribers</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">proto</span><span class="p">)</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
                  <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;unsubscribed peer </span><span class="si">%s</span><span class="s"> from topic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">))</span>
               <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subscribers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">]</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
                     <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;topic </span><span class="si">%s</span><span class="s"> removed from subscriptions map - no one subscribed anymore&quot;</span> <span class="o">%</span> <span class="n">topicUri</span><span class="p">)</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">onClientUnsubscribed</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">)</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;unsubscribed peer </span><span class="si">%s</span><span class="s"> from all topics&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">peer</span><span class="p">))</span>


<div class="viewcode-block" id="WampServerFactory.dispatch"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerFactory.dispatch">[docs]</a>   <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">exclude</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">eligible</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Dispatch an event to all peers subscribed to the event topic.</span>

<span class="sd">      :param topicUri: Topic to publish event to.</span>
<span class="sd">      :type topicUri: str</span>
<span class="sd">      :param event: Event to publish (must be JSON serializable).</span>
<span class="sd">      :type event: obj</span>
<span class="sd">      :param exclude: List of WampServerProtocol instances to exclude from receivers.</span>
<span class="sd">      :type exclude: List of obj</span>
<span class="sd">      :param eligible: List of WampServerProtocol instances eligible as receivers (or None for all).</span>
<span class="sd">      :type eligible: List of obj</span>

<span class="sd">      :returns twisted.internet.defer.Deferred -- Will be fired when event was</span>
<span class="sd">      dispatched to all subscribers. The return value provided to the deferred</span>
<span class="sd">      is a pair (delivered, requested), where delivered = number of actual</span>
<span class="sd">      receivers, and requested = number of (subscribers - excluded) &amp; eligible.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;publish event </span><span class="si">%s</span><span class="s"> for topicUri </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">),</span> <span class="n">topicUri</span><span class="p">))</span>

      <span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">topicUri</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

         <span class="c">## FIXME: this might break ordering of event delivery from a</span>
         <span class="c">## receiver perspective. We might need to have send queues</span>
         <span class="c">## per receiver OR do recvs = deque(sorted(..))</span>

         <span class="c">## However, see http://twistedmatrix.com/trac/ticket/1396</span>

         <span class="k">if</span> <span class="n">eligible</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">subscrbs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">eligible</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">]</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">subscrbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">]</span>

         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">recvs</span> <span class="o">=</span> <span class="n">subscrbs</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">recvs</span> <span class="o">=</span> <span class="n">subscrbs</span>

         <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">recvs</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c">## ok, at least 1 subscriber not excluded and eligible</span>
            <span class="c">## =&gt; prepare message for mass sending</span>
            <span class="c">##</span>
            <span class="n">o</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_EVENT</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">,</span> <span class="n">event</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
               <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
                  <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;serialized event msg: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for event - serialization failed [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

            <span class="n">preparedMsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepareMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c">## chunked sending of prepared message</span>
            <span class="c">##</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendEvents</span><span class="p">(</span><span class="n">preparedMsg</span><span class="p">,</span> <span class="n">recvs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

         <span class="k">else</span><span class="p">:</span>
            <span class="c">## receivers list empty after considering exlude and eligible sessions</span>
            <span class="c">##</span>
            <span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c">## no one subscribed on topic</span>
         <span class="c">##</span>
         <span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

      <span class="k">return</span> <span class="n">d</span>

</div>
   <span class="k">def</span> <span class="nf">_sendEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preparedMsg</span><span class="p">,</span> <span class="n">recvs</span><span class="p">,</span> <span class="n">delivered</span><span class="p">,</span> <span class="n">requested</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Delivers events to receivers in chunks and reenters the reactor</span>
<span class="sd">      in-between, so that other stuff can run.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">## deliver a batch of events</span>
      <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">proto</span> <span class="o">=</span> <span class="n">recvs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">proto</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
               <span class="k">try</span><span class="p">:</span>
                  <span class="n">proto</span><span class="o">.</span><span class="n">sendPreparedMessage</span><span class="p">(</span><span class="n">preparedMsg</span><span class="p">)</span>
               <span class="k">except</span><span class="p">:</span>
                  <span class="k">pass</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
                     <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;delivered event to peer </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">proto</span><span class="o">.</span><span class="n">peer</span><span class="p">)</span>
                  <span class="n">delivered</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c"># all receivers done</span>
            <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">break</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
         <span class="c">## if there are receivers left, redo</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sendEvents</span><span class="p">,</span> <span class="n">preparedMsg</span><span class="p">,</span> <span class="n">recvs</span><span class="p">,</span> <span class="n">delivered</span><span class="p">,</span> <span class="n">requested</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c">## else fire final result</span>
         <span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">((</span><span class="n">delivered</span><span class="p">,</span> <span class="n">requested</span><span class="p">))</span>


   <span class="k">def</span> <span class="nf">_addSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Add proto for session ID.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">protoToSessions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">proto</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">protoToSessions</span><span class="p">[</span><span class="n">proto</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_id</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;logic error - dublicate _addSession for protoToSessions&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessionsToProto</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">session_id</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sessionsToProto</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">proto</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;logic error - dublicate _addSession for sessionsToProto&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_removeSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Remove session by proto.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protoToSessions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">proto</span><span class="p">):</span>
         <span class="n">session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protoToSessions</span><span class="p">[</span><span class="n">proto</span><span class="p">]</span>
         <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">protoToSessions</span><span class="p">[</span><span class="n">proto</span><span class="p">]</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessionsToProto</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">session_id</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessionsToProto</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>


   <span class="k">def</span> <span class="nf">sessionIdToProto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessionId</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Map WAMP session ID to connected protocol instance (object of type WampServerProtocol).</span>

<span class="sd">      :param sessionId: WAMP session ID to be mapped.</span>
<span class="sd">      :type sessionId: str</span>

<span class="sd">      :returns obj -- WampServerProtocol instance or None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessionsToProto</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sessionId</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>


<div class="viewcode-block" id="WampServerFactory.sessionIdsToProtos"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerFactory.sessionIdsToProtos">[docs]</a>   <span class="k">def</span> <span class="nf">sessionIdsToProtos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessionIds</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Map WAMP session IDs to connected protocol instances (objects of type WampServerProtocol).</span>

<span class="sd">      :param sessionIds: List of session IDs to be mapped.</span>
<span class="sd">      :type sessionIds: list of str</span>

<span class="sd">      :returns list -- List of WampServerProtocol instances corresponding to the WAMP session IDs.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">protos</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sessionIds</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessionsToProto</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">protos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sessionsToProto</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">protos</span>

</div>
   <span class="k">def</span> <span class="nf">protoToSessionId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Map connected protocol instance (object of type WampServerProtocol) to WAMP session ID.</span>

<span class="sd">      :param proto: Instance of WampServerProtocol to be mapped.</span>
<span class="sd">      :type proto: obj of WampServerProtocol</span>

<span class="sd">      :returns str -- WAMP session ID or None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protoToSessions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>


<div class="viewcode-block" id="WampServerFactory.protosToSessionIds"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerFactory.protosToSessionIds">[docs]</a>   <span class="k">def</span> <span class="nf">protosToSessionIds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protos</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Map connected protocol instances (objects of type WampServerProtocol) to WAMP session IDs.</span>

<span class="sd">      :param protos: List of instances of WampServerProtocol to be mapped.</span>
<span class="sd">      :type protos: list of WampServerProtocol</span>

<span class="sd">      :returns list -- List of WAMP session IDs corresponding to the protos.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">sessionIds</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">protos</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protoToSessions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">sessionIds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protoToSessions</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">sessionIds</span>

</div>
<div class="viewcode-block" id="WampServerFactory.startFactory"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerFactory.startFactory">[docs]</a>   <span class="k">def</span> <span class="nf">startFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Called by Twisted when the factory starts up. When overriding, make</span>
<span class="sd">      sure to call the base method.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;WampServerFactory starting&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">protoToSessions</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sessionsToProto</span> <span class="o">=</span> <span class="p">{}</span>

</div>
<div class="viewcode-block" id="WampServerFactory.stopFactory"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampServerFactory.stopFactory">[docs]</a>   <span class="k">def</span> <span class="nf">stopFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Called by Twisted when the factory shuts down. When overriding, make</span>
<span class="sd">      sure to call the base method.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;WampServerFactory stopped&quot;</span><span class="p">)</span>


</div></div>
<div class="viewcode-block" id="WampClientProtocol"><a class="viewcode-back" href="../../../wamp1client.html#autobahn.wamp1.protocol.WampClientProtocol">[docs]</a><span class="k">class</span> <span class="nc">WampClientProtocol</span><span class="p">(</span><span class="n">WebSocketClientProtocol</span><span class="p">,</span> <span class="n">WampProtocol</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Twisted client protocol for WAMP.</span>
<span class="sd">   &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WampClientProtocol.onSessionOpen"><a class="viewcode-back" href="../../../wamp1client.html#autobahn.wamp1.protocol.WampClientProtocol.onSessionOpen">[docs]</a>   <span class="k">def</span> <span class="nf">onSessionOpen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback fired when WAMP session was fully established. Override</span>
<span class="sd">      in derived class.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">pass</span>

</div>
   <span class="k">def</span> <span class="nf">onOpen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c">## do nothing here .. onSessionOpen is only fired when welcome</span>
      <span class="c">## message was received (and thus session ID set)</span>
      <span class="k">pass</span>


   <span class="k">def</span> <span class="nf">onConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connectionResponse</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">connectionResponse</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">protocols</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;server does not speak WAMP&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">WebSocketClientProtocol</span><span class="o">.</span><span class="n">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="n">WampProtocol</span><span class="o">.</span><span class="n">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span> <span class="o">=</span> <span class="p">{}</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">handlerMapping</span> <span class="o">=</span> <span class="p">{</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL</span><span class="p">:</span> <span class="n">CallHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="p">),</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_RESULT</span><span class="p">:</span> <span class="n">CallResultHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="p">),</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_ERROR</span><span class="p">:</span> <span class="n">CallErrorHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="p">)}</span>


   <span class="k">def</span> <span class="nf">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="n">WampProtocol</span><span class="o">.</span><span class="n">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
      <span class="n">WebSocketClientProtocol</span><span class="o">.</span><span class="n">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;TX WAMP: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
      <span class="n">WebSocketClientProtocol</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">onMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">binary</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Internal method to handle WAMP messages received from WAMP server.&quot;&quot;&quot;</span>

      <span class="c">## WAMP is text message only</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;binary WebSocket message received&quot;</span><span class="p">)</span>
         <span class="k">return</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;RX WAMP: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

      <span class="c">## WAMP is proper JSON payload</span>
      <span class="c">##</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_unserialize</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;WAMP message payload could not be unserialized [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
         <span class="k">return</span>

      <span class="c">## Every WAMP message is a list</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;WAMP message payload not a list&quot;</span><span class="p">)</span>
         <span class="k">return</span>

      <span class="c">## Every WAMP message starts with an integer for message type</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;WAMP message without message type&quot;</span><span class="p">)</span>
         <span class="k">return</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;WAMP message type not an integer&quot;</span><span class="p">)</span>
         <span class="k">return</span>

      <span class="c">## WAMP message type</span>
      <span class="c">##</span>
      <span class="n">msgtype</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="c">## Valid WAMP message types received by WAMP clients</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">msgtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_WELCOME</span><span class="p">,</span>
                         <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL</span><span class="p">,</span>
                         <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_RESULT</span><span class="p">,</span>
                         <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_ERROR</span><span class="p">,</span>
                         <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_EVENT</span><span class="p">]:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;invalid WAMP message type </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">msgtype</span><span class="p">)</span>
         <span class="k">return</span>

      <span class="k">if</span> <span class="n">msgtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL</span><span class="p">,</span>
                     <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_RESULT</span><span class="p">,</span>
                     <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_ERROR</span><span class="p">]:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">handlerMapping</span><span class="p">[</span><span class="n">msgtype</span><span class="p">]</span><span class="o">.</span><span class="n">handleMessage</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

      <span class="c">## WAMP EVENT</span>
      <span class="c">##</span>
      <span class="k">elif</span> <span class="n">msgtype</span> <span class="o">==</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_EVENT</span><span class="p">:</span>
         <span class="c">## Topic</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;WAMP EVENT message invalid length </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
            <span class="k">return</span>
         <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;invalid type for &lt;topic&gt; in WAMP EVENT message&quot;</span><span class="p">)</span>
            <span class="k">return</span>
         <span class="n">unresolvedTopicUri</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
         <span class="n">topicUri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">resolveOrPass</span><span class="p">(</span><span class="n">unresolvedTopicUri</span><span class="p">)</span> <span class="c">### PFX - remove</span>

         <span class="c">## Fire PubSub Handler</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">topicUri</span><span class="p">):</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">topicUri</span><span class="p">](</span><span class="n">topicUri</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c">## event received for non-subscribed topic (could be because we</span>
            <span class="c">## just unsubscribed, and server already sent out event for</span>
            <span class="c">## previous subscription)</span>
            <span class="k">pass</span>

      <span class="c">## WAMP WELCOME</span>
      <span class="c">##</span>
      <span class="k">elif</span> <span class="n">msgtype</span> <span class="o">==</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_WELCOME</span><span class="p">:</span>
         <span class="c">## Session ID</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;WAMP WELCOME message invalid length </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
            <span class="k">return</span>
         <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;invalid type for &lt;sessionid&gt; in WAMP WELCOME message&quot;</span><span class="p">)</span>
            <span class="k">return</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

         <span class="c">## WAMP Protocol Version</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;invalid type for &lt;version&gt; in WAMP WELCOME message&quot;</span><span class="p">)</span>
               <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">session_protocol_version</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_protocol_version</span> <span class="o">=</span> <span class="bp">None</span>

         <span class="c">## Server Ident</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span><span class="s">&quot;invalid type for &lt;server&gt; in WAMP WELCOME message&quot;</span><span class="p">)</span>
               <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">session_server</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_server</span> <span class="o">=</span> <span class="bp">None</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">onSessionOpen</span><span class="p">()</span>

      <span class="k">else</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;logic error&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="WampClientProtocol.prefix"><a class="viewcode-back" href="../../../wamp1client.html#autobahn.wamp1.protocol.WampClientProtocol.prefix">[docs]</a>   <span class="k">def</span> <span class="nf">prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Establishes a prefix to be used in `CURIEs &lt;http://en.wikipedia.org/wiki/CURIE&gt;`_</span>
<span class="sd">      instead of URIs having that prefix for both client-to-server and</span>
<span class="sd">      server-to-client messages.</span>

<span class="sd">      :param prefix: Prefix to be used in CURIEs.</span>
<span class="sd">      :type prefix: str</span>
<span class="sd">      :param uri: URI that this prefix will resolve to.</span>
<span class="sd">      :type uri: str</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for prefix&quot;</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for URI&quot;</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>  <span class="c">### PFX - keep</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;prefix already defined&quot;</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span> <span class="c">### PFX - keep</span>

      <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_PREFIX</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">uri</span><span class="p">]</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="WampClientProtocol.publish"><a class="viewcode-back" href="../../../wamp1client.html#autobahn.wamp1.protocol.WampClientProtocol.publish">[docs]</a>   <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">excludeMe</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">exclude</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">eligible</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Publish an event under a topic URI. The latter may be abbreviated using a</span>
<span class="sd">      CURIE which has been previously defined using prefix(). The event must</span>
<span class="sd">      be JSON serializable.</span>

<span class="sd">      :param topicUri: The topic URI or CURIE.</span>
<span class="sd">      :type topicUri: str</span>
<span class="sd">      :param event: Event to be published (must be JSON serializable) or None.</span>
<span class="sd">      :type event: value</span>
<span class="sd">      :param excludeMe: When True, don&#39;t deliver the published event to myself (when I&#39;m subscribed).</span>
<span class="sd">      :type excludeMe: bool</span>
<span class="sd">      :param exclude: Optional list of session IDs to exclude from receivers.</span>
<span class="sd">      :type exclude: list of str</span>
<span class="sd">      :param eligible: Optional list of session IDs to that are eligible as receivers.</span>
<span class="sd">      :type eligible: list of str</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">topicUri</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for parameter &#39;topicUri&#39; - must be string (was </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">topicUri</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">excludeMe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">excludeMe</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for parameter &#39;excludeMe&#39; - must be bool (was </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">excludeMe</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for parameter &#39;exclude&#39; - must be list (was </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">exclude</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">eligible</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">eligible</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for parameter &#39;eligible&#39; - must be list (was </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">eligible</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">eligible</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">excludeMe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">excludeMe</span><span class="p">:</span>
                  <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">]</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">]</span>
         <span class="k">if</span> <span class="n">eligible</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_PUBLISH</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">eligible</span><span class="p">]</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_PUBLISH</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">exclude</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">excludeMe</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_PUBLISH</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">,</span> <span class="n">event</span><span class="p">]</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_PUBLISH</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">excludeMe</span><span class="p">]</span>

      <span class="k">try</span><span class="p">:</span>
         <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for parameter &#39;event&#39; - not JSON serializable&quot;</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WampClientProtocol.subscribe"><a class="viewcode-back" href="../../../wamp1client.html#autobahn.wamp1.protocol.WampClientProtocol.subscribe">[docs]</a>   <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Subscribe to topic. When already subscribed, will overwrite the handler.</span>

<span class="sd">      :param topicUri: URI or CURIE of topic to subscribe to.</span>
<span class="sd">      :type topicUri: str</span>
<span class="sd">      :param handler: Event handler to be invoked upon receiving events for topic.</span>
<span class="sd">      :type handler: Python callable, will be called as in &lt;callable&gt;(eventUri, event).</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">topicUri</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for parameter &#39;topicUri&#39; - must be string (was </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">topicUri</span><span class="p">))</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for parameter &#39;handler&#39; - must be a callable (was </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">handler</span><span class="p">))</span>

      <span class="n">turi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">resolveOrPass</span><span class="p">(</span><span class="n">topicUri</span><span class="p">)</span> <span class="c">### PFX - keep</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">turi</span><span class="p">):</span>
         <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_SUBSCRIBE</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">]</span>
         <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">turi</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>

</div>
<div class="viewcode-block" id="WampClientProtocol.unsubscribe"><a class="viewcode-back" href="../../../wamp1client.html#autobahn.wamp1.protocol.WampClientProtocol.unsubscribe">[docs]</a>   <span class="k">def</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Unsubscribe from topic. Will do nothing when currently not subscribed to the topic.</span>

<span class="sd">      :param topicUri: URI or CURIE of topic to unsubscribe from.</span>
<span class="sd">      :type topicUri: str</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">topicUri</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type for parameter &#39;topicUri&#39; - must be string (was </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">topicUri</span><span class="p">))</span>

      <span class="n">turi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">resolveOrPass</span><span class="p">(</span><span class="n">topicUri</span><span class="p">)</span> <span class="c">### PFX - keep</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">turi</span><span class="p">):</span>
         <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_UNSUBSCRIBE</span><span class="p">,</span> <span class="n">topicUri</span><span class="p">]</span>
         <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
         <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">turi</span><span class="p">]</span>


</div></div>
<div class="viewcode-block" id="WampClientFactory"><a class="viewcode-back" href="../../../wamp1client.html#autobahn.wamp1.protocol.WampClientFactory">[docs]</a><span class="k">class</span> <span class="nc">WampClientFactory</span><span class="p">(</span><span class="n">WebSocketClientFactory</span><span class="p">,</span> <span class="n">WampFactory</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Twisted client factory for WAMP.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">protocol</span> <span class="o">=</span> <span class="n">WampClientProtocol</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">debugCodePaths</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">debugWamp</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">debugApp</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">reactor</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span> <span class="o">=</span> <span class="n">debugWamp</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">debugApp</span> <span class="o">=</span> <span class="n">debugApp</span>
      <span class="n">WebSocketClientFactory</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                      <span class="n">url</span><span class="p">,</span>
                                      <span class="n">protocols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;wamp&quot;</span><span class="p">],</span>
                                      <span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">,</span>
                                      <span class="n">debugCodePaths</span> <span class="o">=</span> <span class="n">debugCodePaths</span><span class="p">,</span>
                                      <span class="n">reactor</span> <span class="o">=</span> <span class="n">reactor</span><span class="p">)</span>
      <span class="n">WampFactory</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<div class="viewcode-block" id="WampClientFactory.startFactory"><a class="viewcode-back" href="../../../wamp1client.html#autobahn.wamp1.protocol.WampClientFactory.startFactory">[docs]</a>   <span class="k">def</span> <span class="nf">startFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Called by Twisted when the factory starts up. When overriding, make</span>
<span class="sd">      sure to call the base method.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;WebSocketClientFactory starting&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WampClientFactory.stopFactory"><a class="viewcode-back" href="../../../wamp1client.html#autobahn.wamp1.protocol.WampClientFactory.stopFactory">[docs]</a>   <span class="k">def</span> <span class="nf">stopFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Called by Twisted when the factory shuts down. When overriding, make</span>
<span class="sd">      sure to call the base method.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;WebSocketClientFactory stopped&quot;</span><span class="p">)</span>


</div></div>
<div class="viewcode-block" id="WampCraProtocol"><a class="viewcode-back" href="../../../wamp1base.html#autobahn.wamp1.protocol.WampCraProtocol">[docs]</a><span class="k">class</span> <span class="nc">WampCraProtocol</span><span class="p">(</span><span class="n">WampProtocol</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Base class for WAMP Challenge-Response Authentication protocols (client and server).</span>

<span class="sd">   WAMP-CRA is a cryptographically strong challenge response authentication</span>
<span class="sd">   protocol based on HMAC-SHA256.</span>

<span class="sd">   The protocol performs in-band authentication of WAMP clients to WAMP servers.</span>

<span class="sd">   WAMP-CRA does not introduce any new WAMP protocol level message types, but</span>
<span class="sd">   implements the authentication handshake via standard WAMP RPCs with well-known</span>
<span class="sd">   procedure URIs and signatures.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="nf">deriveKey</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">extra</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Computes a derived cryptographic key from a password according to PBKDF2</span>
<span class="sd">      http://en.wikipedia.org/wiki/PBKDF2.</span>

<span class="sd">      The function will only return a derived key if at least &#39;salt&#39; is</span>
<span class="sd">      present in the &#39;extra&#39; dictionary. The complete set of attributes</span>
<span class="sd">      that can be set in &#39;extra&#39;:</span>

<span class="sd">         salt: The salt value to be used.</span>
<span class="sd">         iterations: Number of iterations of derivation algorithm to run.</span>
<span class="sd">         keylen: Key length to derive.</span>

<span class="sd">      :returns str -- The derived key or the original secret.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="n">extra</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;salt&#39;</span><span class="p">):</span>
         <span class="n">salt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">extra</span><span class="p">[</span><span class="s">&#39;salt&#39;</span><span class="p">])</span>
         <span class="n">iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;iterations&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>
         <span class="n">keylen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;keylen&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
         <span class="n">b</span> <span class="o">=</span> <span class="n">pbkdf2_bin</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">keylen</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_base64</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">secret</span>

   <span class="n">deriveKey</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">deriveKey</span><span class="p">)</span>


<div class="viewcode-block" id="WampCraProtocol.authSignature"><a class="viewcode-back" href="../../../wamp1base.html#autobahn.wamp1.protocol.WampCraProtocol.authSignature">[docs]</a>   <span class="k">def</span> <span class="nf">authSignature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authChallenge</span><span class="p">,</span> <span class="n">authSecret</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">authExtra</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Compute the authentication signature from an authentication challenge and a secret.</span>

<span class="sd">      :param authChallenge: The authentication challenge.</span>
<span class="sd">      :type authChallenge: str</span>
<span class="sd">      :param authSecret: The authentication secret.</span>
<span class="sd">      :type authSecret: str</span>
<span class="sd">      :authExtra: Extra authentication information for salting the secret. (salt, keylen,</span>
<span class="sd">              iterations)</span>
<span class="sd">      :type authExtra: dict</span>

<span class="sd">      :returns str -- The authentication signature.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">authSecret</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">authSecret</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">authSecret</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
         <span class="n">authSecret</span> <span class="o">=</span> <span class="n">authSecret</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
      <span class="n">authSecret</span> <span class="o">=</span> <span class="n">WampCraProtocol</span><span class="o">.</span><span class="n">deriveKey</span><span class="p">(</span><span class="n">authSecret</span><span class="p">,</span> <span class="n">authExtra</span><span class="p">)</span>
      <span class="n">h</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">authSecret</span><span class="p">,</span> <span class="n">authChallenge</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span>
      <span class="n">sig</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_base64</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">sig</span>


</div></div>
<div class="viewcode-block" id="WampCraClientProtocol"><a class="viewcode-back" href="../../../wamp1client.html#autobahn.wamp1.protocol.WampCraClientProtocol">[docs]</a><span class="k">class</span> <span class="nc">WampCraClientProtocol</span><span class="p">(</span><span class="n">WampClientProtocol</span><span class="p">,</span> <span class="n">WampCraProtocol</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Simple, authenticated WAMP client protocol.</span>

<span class="sd">   The client can perform WAMP-Challenge-Response-Authentication (&quot;WAMP-CRA&quot;) to authenticate</span>
<span class="sd">   itself to a WAMP server. The server needs to implement WAMP-CRA also of course.</span>
<span class="sd">   &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WampCraClientProtocol.authenticate"><a class="viewcode-back" href="../../../wamp1client.html#autobahn.wamp1.protocol.WampCraClientProtocol.authenticate">[docs]</a>   <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authKey</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">authExtra</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">authSecret</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Authenticate the WAMP session to server.</span>

<span class="sd">      :param authKey: The key of the authentication credentials, something like a user or application name.</span>
<span class="sd">      :type authKey: str</span>
<span class="sd">      :param authExtra: Any extra authentication information.</span>
<span class="sd">      :type authExtra: dict</span>
<span class="sd">      :param authSecret: The secret of the authentication credentials, something like the user password or application secret key.</span>
<span class="sd">      :type authsecret: str</span>

<span class="sd">      :returns Deferred -- Deferred that fires upon authentication success (with permissions) or failure.</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="k">def</span> <span class="nf">_onAuthChallenge</span><span class="p">(</span><span class="n">challenge</span><span class="p">):</span>
         <span class="k">if</span> <span class="n">authKey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">challengeObj</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_unserialize</span><span class="p">(</span><span class="n">challenge</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;authextra&#39;</span> <span class="ow">in</span> <span class="n">challengeObj</span><span class="p">:</span>
                <span class="n">authExtra</span> <span class="o">=</span> <span class="n">challengeObj</span><span class="p">[</span><span class="s">&#39;authextra&#39;</span><span class="p">]</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authSignature</span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="n">authSecret</span><span class="p">,</span> <span class="n">authExtra</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authSignature</span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="n">authSecret</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="bp">None</span>
         <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_PROCEDURE</span> <span class="o">+</span> <span class="s">&quot;auth&quot;</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">d</span>

      <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_PROCEDURE</span> <span class="o">+</span> <span class="s">&quot;authreq&quot;</span><span class="p">,</span> <span class="n">authKey</span><span class="p">,</span> <span class="n">authExtra</span><span class="p">)</span>
      <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">_onAuthChallenge</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">d</span>


</div></div>
<div class="viewcode-block" id="WampCraServerProtocol"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampCraServerProtocol">[docs]</a><span class="k">class</span> <span class="nc">WampCraServerProtocol</span><span class="p">(</span><span class="n">WampServerProtocol</span><span class="p">,</span> <span class="n">WampCraProtocol</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Simple, authenticating WAMP server protocol.</span>

<span class="sd">   The server lets clients perform WAMP-Challenge-Response-Authentication (&quot;WAMP-CRA&quot;)</span>
<span class="sd">   to authenticate. The clients need to implement WAMP-CRA also of course.</span>

<span class="sd">   To implement an authenticating server, override:</span>

<span class="sd">      * getAuthSecret</span>
<span class="sd">      * getAuthPermissions</span>
<span class="sd">      * onAuthenticated</span>

<span class="sd">   in your class deriving from this class.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">clientAuthTimeout</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Client authentication timeout in seconds or 0 for infinite. A client</span>
<span class="sd">   must perform authentication after the initial WebSocket handshake within</span>
<span class="sd">   this timeout or the connection is failed.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">clientAuthAllowAnonymous</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Allow anonymous client authentication. When this is set to True, a client</span>
<span class="sd">   may &quot;authenticate&quot; as anonymous.</span>
<span class="sd">   &quot;&quot;&quot;</span>


<div class="viewcode-block" id="WampCraServerProtocol.getAuthPermissions"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampCraServerProtocol.getAuthPermissions">[docs]</a>   <span class="k">def</span> <span class="nf">getAuthPermissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authKey</span><span class="p">,</span> <span class="n">authExtra</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Get the permissions the session is granted when the authentication succeeds</span>
<span class="sd">      for the given key / extra information.</span>

<span class="sd">      Override in derived class to implement your authentication.</span>

<span class="sd">      A permissions object is structured like this::</span>

<span class="sd">         {&#39;permissions&#39;: {&#39;rpc&#39;: [</span>
<span class="sd">                                    {&#39;uri&#39;:  / RPC Endpoint URI - String /,</span>
<span class="sd">                                     &#39;call&#39;: / Allow to call? - Boolean /}</span>
<span class="sd">                                 ],</span>
<span class="sd">                          &#39;pubsub&#39;: [</span>
<span class="sd">                                       {&#39;uri&#39;:    / PubSub Topic URI / URI prefix - String /,</span>
<span class="sd">                                        &#39;prefix&#39;: / URI matched by prefix? - Boolean /,</span>
<span class="sd">                                        &#39;pub&#39;:    / Allow to publish? - Boolean /,</span>
<span class="sd">                                        &#39;sub&#39;:    / Allow to subscribe? - Boolean /}</span>
<span class="sd">                                    ]</span>
<span class="sd">                          }</span>
<span class="sd">         }</span>

<span class="sd">      You can add custom information to this object. The object will be provided again</span>
<span class="sd">      when the client authentication succeeded in :meth:`onAuthenticated`.</span>

<span class="sd">      :param authKey: The authentication key.</span>
<span class="sd">      :type authKey: str</span>
<span class="sd">      :param authExtra: Authentication extra information.</span>
<span class="sd">      :type authExtra: dict</span>

<span class="sd">      :returns obj or Deferred -- Return a permissions object or None when no permissions granted.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="WampCraServerProtocol.getAuthSecret"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampCraServerProtocol.getAuthSecret">[docs]</a>   <span class="k">def</span> <span class="nf">getAuthSecret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authKey</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Get the authentication secret for an authentication key, i.e. the</span>
<span class="sd">      user password for the user name. Return None when the authentication</span>
<span class="sd">      key does not exist.</span>

<span class="sd">      Override in derived class to implement your authentication.</span>

<span class="sd">      :param authKey: The authentication key.</span>
<span class="sd">      :type authKey: str</span>

<span class="sd">      :returns str or Deferred -- The authentication secret for the key or None when the key does not exist.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="WampCraServerProtocol.onAuthTimeout"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampCraServerProtocol.onAuthTimeout">[docs]</a>   <span class="k">def</span> <span class="nf">onAuthTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Fired when the client does not authenticate itself in time. The default implementation</span>
<span class="sd">      will simply fail the connection.</span>

<span class="sd">      May be overridden in derived class.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clientAuthenticated</span><span class="p">:</span>
         <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;failing connection upon client authentication timeout [</span><span class="si">%s</span><span class="s"> secs]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">clientAuthTimeout</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">failConnection</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="WampCraServerProtocol.onAuthenticated"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampCraServerProtocol.onAuthenticated">[docs]</a>   <span class="k">def</span> <span class="nf">onAuthenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authKey</span><span class="p">,</span> <span class="n">permissions</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Fired when client authentication was successful.</span>

<span class="sd">      Override in derived class and register PubSub topics and/or RPC endpoints.</span>

<span class="sd">      :param authKey: The authentication key the session was authenticated for.</span>
<span class="sd">      :type authKey: str</span>
<span class="sd">      :param permissions: The permissions object returned from :meth:`getAuthPermissions`.</span>
<span class="sd">      :type permissions: obj</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">pass</span>

</div>
<div class="viewcode-block" id="WampCraServerProtocol.registerForPubSubFromPermissions"><a class="viewcode-back" href="../../../wamp1server.html#autobahn.wamp1.protocol.WampCraServerProtocol.registerForPubSubFromPermissions">[docs]</a>   <span class="k">def</span> <span class="nf">registerForPubSubFromPermissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permissions</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Register topics for PubSub from auth permissions.</span>

<span class="sd">      :param permissions: The permissions granted to the now authenticated client.</span>
<span class="sd">      :type permissions: list</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">permissions</span><span class="p">[</span><span class="s">&#39;pubsub&#39;</span><span class="p">]:</span>
         <span class="c">## register topics for the clients</span>
         <span class="c">##</span>
         <span class="n">pubsub</span> <span class="o">=</span> <span class="p">(</span><span class="n">WampServerProtocol</span><span class="o">.</span><span class="n">PUBLISH</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s">&#39;pub&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> \
                  <span class="p">(</span><span class="n">WampServerProtocol</span><span class="o">.</span><span class="n">SUBSCRIBE</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s">&#39;sub&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
         <span class="n">topic</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s">&#39;uri&#39;</span><span class="p">]</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubHandlers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subHandlers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">topic</span><span class="p">):</span>
            <span class="c">## FIXME: handle dups!</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;DUPLICATE TOPIC PERMISSION !!! &quot;</span> <span class="o">+</span> <span class="n">topic</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">registerForPubSub</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">],</span> <span class="n">pubsub</span><span class="p">)</span>

</div>
   <span class="k">def</span> <span class="nf">onSessionOpen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Called when WAMP session has been established, but not yet authenticated. The default</span>
<span class="sd">      implementation will prepare the session allowing the client to authenticate itself.</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="c">## register RPC endpoints for WAMP-CRA authentication</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">registerForRpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_PROCEDURE</span><span class="p">,</span> <span class="p">[</span><span class="n">WampCraServerProtocol</span><span class="o">.</span><span class="n">authRequest</span><span class="p">,</span>
                                                                  <span class="n">WampCraServerProtocol</span><span class="o">.</span><span class="n">auth</span><span class="p">])</span>

      <span class="c">## reset authentication state</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_clientAuthenticated</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_clientPendingAuth</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_clientAuthTimeoutCall</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c">## client authentication timeout</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clientAuthTimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_clientAuthTimeoutCall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clientAuthTimeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onAuthTimeout</span><span class="p">)</span>


   <span class="nd">@exportRpc</span><span class="p">(</span><span class="s">&quot;authreq&quot;</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">authRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authKey</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">extra</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      RPC endpoint for clients to initiate the authentication handshake.</span>

<span class="sd">      :param authKey: Authentication key, such as user name or application name.</span>
<span class="sd">      :type authKey: str</span>
<span class="sd">      :param extra: Authentication extra information.</span>
<span class="sd">      :type extra: dict</span>

<span class="sd">      :returns str -- Authentication challenge. The client will need to create an authentication signature from this.</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="c">## check authentication state</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clientAuthenticated</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;already-authenticated&quot;</span><span class="p">),</span> <span class="s">&quot;already authenticated&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clientPendingAuth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;authentication-already-requested&quot;</span><span class="p">),</span> <span class="s">&quot;authentication request already issues - authentication pending&quot;</span><span class="p">)</span>

      <span class="c">## check extra</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;invalid-argument&quot;</span><span class="p">),</span> <span class="s">&quot;extra not a dictionary (was </span><span class="si">%s</span><span class="s">).&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">extra</span><span class="p">)))</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">extra</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="c">#for k in extra:</span>
      <span class="c">#   if type(extra[k]) not in [str, unicode, int, long, float, bool, types.NoneType]:</span>
      <span class="c">#      raise Exception(self.shrink(WampProtocol.URI_WAMP_ERROR + &quot;invalid-argument&quot;), &quot;attribute &#39;%s&#39; in extra not a primitive type (was %s)&quot; % (k, str(type(extra[k]))))</span>

      <span class="c">## check authKey</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">authKey</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">clientAuthAllowAnonymous</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;anonymous-auth-forbidden&quot;</span><span class="p">),</span> <span class="s">&quot;authentication as anonymous forbidden&quot;</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">authKey</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">NoneType</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;invalid-argument&quot;</span><span class="p">),</span> <span class="s">&quot;authentication key must be a string (was </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">authKey</span><span class="p">)))</span>

      <span class="n">d</span> <span class="o">=</span> <span class="n">maybeDeferred</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getAuthSecret</span><span class="p">,</span> <span class="n">authKey</span><span class="p">)</span>

      <span class="k">def</span> <span class="nf">onGetAuthSecretOk</span><span class="p">(</span><span class="n">authSecret</span><span class="p">,</span> <span class="n">authKey</span><span class="p">,</span> <span class="n">extra</span><span class="p">):</span>
         <span class="k">if</span> <span class="n">authKey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">authSecret</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;no-such-authkey&quot;</span><span class="p">),</span> <span class="s">&quot;authentication key &#39;</span><span class="si">%s</span><span class="s">&#39; does not exist.&quot;</span> <span class="o">%</span> <span class="n">authKey</span><span class="p">)</span>

         <span class="c">## each authentication request gets a unique authid, which can only be used (later) once!</span>
         <span class="c">##</span>
         <span class="n">authid</span> <span class="o">=</span> <span class="n">newid</span><span class="p">()</span>

         <span class="c">## create authentication challenge</span>
         <span class="c">##</span>
         <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
         <span class="n">info</span><span class="p">[</span><span class="s">&#39;authid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">authid</span>
         <span class="n">info</span><span class="p">[</span><span class="s">&#39;authkey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">authKey</span>
         <span class="n">info</span><span class="p">[</span><span class="s">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utcnow</span><span class="p">()</span>
         <span class="n">info</span><span class="p">[</span><span class="s">&#39;sessionid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span>
         <span class="n">info</span><span class="p">[</span><span class="s">&#39;extra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra</span>

         <span class="n">pp</span> <span class="o">=</span> <span class="n">maybeDeferred</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getAuthPermissions</span><span class="p">,</span> <span class="n">authKey</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>

         <span class="k">def</span> <span class="nf">onAuthPermissionsOk</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
               <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;permissions&#39;</span><span class="p">:</span> <span class="p">{}}</span>
               <span class="n">res</span><span class="p">[</span><span class="s">&#39;permissions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;pubsub&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s">&#39;rpc&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="n">info</span><span class="p">[</span><span class="s">&#39;permissions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">&#39;permissions&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;authextra&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="s">&#39;authextra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">&#39;authextra&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">authKey</span><span class="p">:</span>
               <span class="c">## authenticated session</span>
               <span class="c">##</span>
               <span class="n">infoser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
               <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authSignature</span><span class="p">(</span><span class="n">infoser</span><span class="p">,</span> <span class="n">authSecret</span><span class="p">)</span>

               <span class="bp">self</span><span class="o">.</span><span class="n">_clientPendingAuth</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
               <span class="k">return</span> <span class="n">infoser</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="c">## anonymous session</span>
               <span class="c">##</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_clientPendingAuth</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
               <span class="k">return</span> <span class="bp">None</span>

         <span class="k">def</span> <span class="nf">onAuthPermissionsError</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;auth-permissions-error&quot;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

         <span class="n">pp</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">onAuthPermissionsOk</span><span class="p">,</span> <span class="n">onAuthPermissionsError</span><span class="p">)</span>

         <span class="k">return</span> <span class="n">pp</span>

      <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">onGetAuthSecretOk</span><span class="p">,</span> <span class="n">authKey</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">d</span>


   <span class="nd">@exportRpc</span><span class="p">(</span><span class="s">&quot;auth&quot;</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signature</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      RPC endpoint for clients to actually authenticate after requesting authentication and computing</span>
<span class="sd">      a signature from the authentication challenge.</span>

<span class="sd">      :param signature: Authentication signature computed by the client.</span>
<span class="sd">      :type signature: str</span>

<span class="sd">      :returns list -- A list of permissions the client is granted when authentication was successful.</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="c">## check authentication state</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clientAuthenticated</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;already-authenticated&quot;</span><span class="p">),</span> <span class="s">&quot;already authenticated&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clientPendingAuth</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;no-authentication-requested&quot;</span><span class="p">),</span> <span class="s">&quot;no authentication previously requested&quot;</span><span class="p">)</span>

      <span class="c">## check signature</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">NoneType</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;invalid-argument&quot;</span><span class="p">),</span> <span class="s">&quot;signature must be a string or None (was </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">signature</span><span class="p">)))</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clientPendingAuth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">signature</span><span class="p">:</span>
         <span class="c">## delete pending authentication, so that no retries are possible. authid is only valid for 1 try!!</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_clientPendingAuth</span> <span class="o">=</span> <span class="bp">None</span>

         <span class="c">## notify the client of failed authentication, but only after a random,</span>
         <span class="c">## exponentially distributed delay. this (further) protects against</span>
         <span class="c">## timing attacks</span>
         <span class="c">##</span>
         <span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>
         <span class="k">def</span> <span class="nf">fail</span><span class="p">():</span>
            <span class="c">## FIXME: (optionally) drop the connection instead of returning RPC error?</span>
            <span class="c">##</span>
            <span class="n">d</span><span class="o">.</span><span class="n">errback</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR</span> <span class="o">+</span> <span class="s">&quot;invalid-signature&quot;</span><span class="p">),</span> <span class="s">&quot;signature for authentication request is invalid&quot;</span><span class="p">))</span>
         <span class="n">failDelaySecs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">expovariate</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">0.8</span><span class="p">)</span> <span class="c"># mean = 0.8 secs</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="n">failDelaySecs</span><span class="p">,</span> <span class="n">fail</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">d</span>

      <span class="c">## at this point, the client has successfully authenticated!</span>

      <span class="c">## get the permissions we determined earlier</span>
      <span class="c">##</span>
      <span class="n">perms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clientPendingAuth</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

      <span class="c">## delete auth request and mark client as authenticated</span>
      <span class="c">##</span>
      <span class="n">authKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clientPendingAuth</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;authkey&#39;</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_clientAuthenticated</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_clientPendingAuth</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clientAuthTimeoutCall</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_clientAuthTimeoutCall</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_clientAuthTimeoutCall</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c">## fire authentication callback</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">onAuthenticated</span><span class="p">(</span><span class="n">authKey</span><span class="p">,</span> <span class="n">perms</span><span class="p">)</span>

      <span class="c">## return permissions to client</span>
      <span class="c">##</span>
      <span class="k">return</span> <span class="n">perms</span><span class="p">[</span><span class="s">&#39;permissions&#39;</span><span class="p">]</span>


</div>
<span class="k">class</span> <span class="nc">Call</span><span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Thin-wrapper for incoming RPCs provided to call handlers registered via</span>

<span class="sd">     - registerHandlerMethodForRpc</span>
<span class="sd">     - registerHandlerProcedureForRpc</span>
<span class="sd">   &quot;&quot;&quot;</span>


   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">proto</span><span class="p">,</span>
             <span class="n">callid</span><span class="p">,</span>
             <span class="n">uri</span><span class="p">,</span>
             <span class="n">args</span><span class="p">,</span>
             <span class="n">extra</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">proto</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">callid</span> <span class="o">=</span> <span class="n">callid</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">extra</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">timings</span> <span class="o">=</span> <span class="bp">None</span>



<span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   A handler for a certain class of messages.</span>
<span class="sd">   &quot;&quot;&quot;</span>


   <span class="n">typeid</span> <span class="o">=</span> <span class="bp">None</span>


   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Remember protocol and prefix map in instance variables.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">proto</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span> <span class="o">=</span> <span class="n">prefixes</span>


   <span class="k">def</span> <span class="nf">handleMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_parts</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Template method for handling a message.</span>

<span class="sd">      Check if the correct handler for the message type was</span>
<span class="sd">      called. Afterwards, assign all relevant parts of the message to</span>
<span class="sd">      instance variables and call the (overridden) method</span>
<span class="sd">      _handleMessage to actually handle the message.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">msgtype</span> <span class="o">=</span> <span class="n">msg_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeid</span><span class="p">:</span>
         <span class="k">assert</span> <span class="n">msgtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeid</span><span class="p">,</span> \
             <span class="s">&quot;Message type </span><span class="si">%s</span><span class="s"> does not match type id </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msgtype</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">typeid</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> \
             <span class="s">&quot;No typeid defined for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messageIsValid</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_parseMessageParts</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_handleMessage</span><span class="p">()</span>


   <span class="k">def</span> <span class="nf">_parseMessageParts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_parts</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Assign the message parts to instance variables.</span>
<span class="sd">      Has to be overridden in subclasses.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span>

   <span class="k">def</span> <span class="nf">_messageIsValid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_parts</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Check if the message parts have expected properties (type, etc.).</span>
<span class="sd">      Has to be overridden in subclasses.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span>


   <span class="k">def</span> <span class="nf">_handleMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Handle a specific kind of message.</span>
<span class="sd">      Has to be overridden in subclasses.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span>


   <span class="k">def</span> <span class="nf">maybeTrackTimings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Track timings, if desired.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">trackTimings</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">doTrack</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
         <span class="n">call</span><span class="o">.</span><span class="n">timings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">trackedTimings</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">trackedTimings</span> <span class="o">=</span> <span class="n">Timings</span><span class="p">()</span>



<span class="k">class</span> <span class="nc">CallHandler</span><span class="p">(</span><span class="n">Handler</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   A handler for incoming RPC calls.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">typeid</span> <span class="o">=</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL</span>


   <span class="k">def</span> <span class="nf">_messageIsValid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_parts</span><span class="p">):</span>
      <span class="n">callid</span><span class="p">,</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">msg_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">callid</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span>
            <span class="p">(</span><span class="s">&quot;WAMP CALL message with invalid type </span><span class="si">%s</span><span class="s"> for &quot;</span>
            <span class="s">&quot;&lt;callid&gt;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">callid</span><span class="p">))</span>
         <span class="k">return</span> <span class="bp">False</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span>
            <span class="p">(</span><span class="s">&quot;WAMP CALL message with invalid type </span><span class="si">%s</span><span class="s"> for &quot;</span>
            <span class="s">&quot;&lt;uri&gt;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>
         <span class="k">return</span> <span class="bp">False</span>

      <span class="k">return</span> <span class="bp">True</span>


   <span class="k">def</span> <span class="nf">_parseMessageParts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_parts</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Parse message and create call object.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">callid</span> <span class="o">=</span> <span class="n">msg_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">resolveOrPass</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c">### PFX - remove</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">msg_parts</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>


   <span class="k">def</span> <span class="nf">_handleMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Perform the RPC call and attach callbacks to its deferred object.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onBeforeCall</span><span class="p">()</span>

      <span class="c">## execute incoming RPC</span>
      <span class="n">d</span> <span class="o">=</span> <span class="n">maybeDeferred</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callProcedure</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>

      <span class="c">## register callback and errback with extra argument call</span>
      <span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onAfterCallSuccess</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_onAfterCallError</span><span class="p">,</span>
                     <span class="n">callbackArgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">call</span><span class="p">,),</span>
                     <span class="n">errbackArgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">call</span><span class="p">,))</span>


   <span class="k">def</span> <span class="nf">_onBeforeCall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Create call object to move around call data</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">uri</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">onBeforeCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">procForUri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">)))</span>

      <span class="n">call</span> <span class="o">=</span> <span class="n">Call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callid</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">maybeTrackTimings</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="s">&quot;onBeforeCall&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">call</span>


   <span class="k">def</span> <span class="nf">_callProcedure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Actually performs the call of a procedure invoked via RPC.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">procForUri</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR_NO_SUCH_RPC_ENDPOINT</span><span class="p">,</span> <span class="s">&quot;No RPC endpoint registered for </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">call</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>

      <span class="n">obj</span><span class="p">,</span> <span class="n">method_or_proc</span><span class="p">,</span> <span class="n">is_handler</span> <span class="o">=</span> <span class="n">m</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">is_handler</span><span class="p">:</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_performProcedureCall</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">method_or_proc</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">call</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegateToRpcHandler</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">method_or_proc</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_performProcedureCall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">method_or_proc</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Perform a RPC method / procedure call.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">cargs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
      <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
         <span class="c">## call object method</span>
         <span class="k">return</span> <span class="n">method_or_proc</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">cargs</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c">## call free-standing function/procedure</span>
         <span class="k">return</span> <span class="n">method_or_proc</span><span class="p">(</span><span class="o">*</span><span class="n">cargs</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_delegateToRpcHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">method_or_proc</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Delegate call to RPC handler.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
         <span class="c">## call RPC handler on object</span>
         <span class="k">return</span> <span class="n">method_or_proc</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c">## call free-standing RPC handler</span>
         <span class="k">return</span> <span class="n">method_or_proc</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_onAfterCallSuccess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Execute custom success handler and send call result.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">## track timing and fire user callback</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">maybeTrackTimings</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="s">&quot;onAfterCallSuccess&quot;</span><span class="p">)</span>
      <span class="n">call</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">onAfterCallSuccess</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>

      <span class="c">## send out WAMP message</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sendCallResult</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_onAfterCallError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Execute custom error handler and send call error.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">## track timing and fire user callback</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">maybeTrackTimings</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="s">&quot;onAfterCallError&quot;</span><span class="p">)</span>
      <span class="n">call</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">onAfterCallError</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>

      <span class="c">## send out WAMP message</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sendCallError</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_sendCallResult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Marshal and send a RPC success result.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_RESULT</span><span class="p">,</span> <span class="n">call</span><span class="o">.</span><span class="n">callid</span><span class="p">,</span> <span class="n">call</span><span class="o">.</span><span class="n">result</span><span class="p">]</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">rmsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">serializeMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;call result not JSON serializable&quot;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c">## now actually send WAMP message</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">rmsg</span><span class="p">)</span>

         <span class="c">## track timing and fire user callback</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">maybeTrackTimings</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="s">&quot;onAfterSendCallSuccess&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">onAfterSendCallSuccess</span><span class="p">(</span><span class="n">rmsg</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_sendCallError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Marshal and send a RPC error result.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">killsession</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="n">rmsg</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">error_info</span><span class="p">,</span> <span class="n">killsession</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extractErrorInfo</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>
         <span class="n">rmsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assembleErrorMessage</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="o">*</span><span class="n">error_info</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="n">rmsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleProcessingError</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
      <span class="k">finally</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">rmsg</span><span class="p">:</span>
            <span class="c">## now actually send WAMP message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">rmsg</span><span class="p">)</span>

            <span class="c">## track timing and fire user callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maybeTrackTimings</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="s">&quot;onAfterSendCallError&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">onAfterSendCallError</span><span class="p">(</span><span class="n">rmsg</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">killsession</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">sendClose</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="s">&quot;killing WAMP session upon request by application exception&quot;</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;fatal: internal error in CallHandler._sendCallError&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_extractErrorInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Extract error information from the call.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">## get error args and len</span>
      <span class="c">##</span>
      <span class="n">eargs</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">args</span>
      <span class="n">nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eargs</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">nargs</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid args length </span><span class="si">%d</span><span class="s"> for exception&quot;</span> <span class="o">%</span> <span class="n">nargs</span><span class="p">)</span>

      <span class="c">## erroruri &amp; errordesc</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">erroruri</span> <span class="o">=</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR_GENERIC</span>
         <span class="n">errordesc</span> <span class="o">=</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">DESC_WAMP_ERROR_GENERIC</span>
      <span class="k">elif</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
         <span class="n">erroruri</span> <span class="o">=</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR_GENERIC</span>
         <span class="n">errordesc</span> <span class="o">=</span> <span class="n">eargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">erroruri</span> <span class="o">=</span> <span class="n">eargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
         <span class="n">errordesc</span> <span class="o">=</span> <span class="n">eargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

      <span class="c">## errordetails</span>
      <span class="c">##</span>
      <span class="n">errordetails</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="n">nargs</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
         <span class="n">errordetails</span> <span class="o">=</span> <span class="n">eargs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">includeTraceback</span><span class="p">:</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="c">## we&#39;d like to do ..</span>
            <span class="c">#tb = call.error.getTraceback()</span>

            <span class="c">## .. but the implementation in Twisted</span>
            <span class="c">## http://twistedmatrix.com/trac/browser/tags/releases/twisted-13.1.0/twisted/python/failure.py#L529</span>
            <span class="c">## uses cStringIO which cannot handle Unicode string in tracebacks. Hence we do our own:</span>
            <span class="n">io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="n">call</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">printTraceback</span><span class="p">(</span><span class="nb">file</span> <span class="o">=</span> <span class="n">io</span><span class="p">)</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;INTERNAL ERROR [_extractErrorInfo / getTraceback()]: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ie</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_stack</span><span class="p">()</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">errordetails</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

      <span class="c">## killsession</span>
      <span class="c">##</span>
      <span class="n">killsession</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="k">if</span> <span class="n">nargs</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
         <span class="n">killsession</span> <span class="o">=</span> <span class="n">eargs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

      <span class="c">## recheck all error component types</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">erroruri</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type </span><span class="si">%s</span><span class="s"> for errorUri&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">erroruri</span><span class="p">))</span>

      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">errordesc</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type </span><span class="si">%s</span><span class="s"> for errorDesc&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">errordesc</span><span class="p">))</span>

      <span class="c">## errordetails must be JSON serializable. If not, we get exception later in sendMessage.</span>
      <span class="c">## We don&#39;t check here, since the only way would be to serialize to JSON and</span>
      <span class="c">## then we&#39;d serialize twice (here and in sendMessage)</span>

      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">killsession</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">NoneType</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type </span><span class="si">%s</span><span class="s"> for killSession&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">killsession</span><span class="p">))</span>

      <span class="k">return</span> <span class="p">(</span><span class="n">erroruri</span><span class="p">,</span> <span class="n">errordesc</span><span class="p">,</span> <span class="n">errordetails</span><span class="p">),</span> <span class="n">killsession</span>


   <span class="k">def</span> <span class="nf">_assembleErrorMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">erroruri</span><span class="p">,</span> <span class="n">errordesc</span><span class="p">,</span> <span class="n">errordetails</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Assemble a WAMP RPC error message.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">errordetails</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_ERROR</span><span class="p">,</span>
                <span class="n">call</span><span class="o">.</span><span class="n">callid</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">erroruri</span><span class="p">),</span> <span class="c">### PFX - remove</span>
                <span class="n">errordesc</span><span class="p">,</span>
                <span class="n">errordetails</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_ERROR</span><span class="p">,</span>
                <span class="n">call</span><span class="o">.</span><span class="n">callid</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">erroruri</span><span class="p">),</span> <span class="c">### PFX - remove</span>
                <span class="n">errordesc</span><span class="p">]</span>

      <span class="c">## serialize message. this can fail if errorDetails is not</span>
      <span class="c">## serializable</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">rmsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">serializeMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s">&quot;invalid object for errorDetails - not serializable (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

      <span class="k">return</span> <span class="n">rmsg</span>


   <span class="k">def</span> <span class="nf">_handleProcessingError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Create a message describing what went wrong during processing an</span>
<span class="sd">      exception.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_ERROR</span><span class="p">,</span>
             <span class="n">call</span><span class="o">.</span><span class="n">callid</span><span class="p">,</span>
              <span class="c">### PFX - remove</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">WampProtocol</span><span class="o">.</span><span class="n">URI_WAMP_ERROR_INTERNAL</span><span class="p">),</span>
             <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">includeTraceback</span><span class="p">:</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">getTraceback</span><span class="p">()</span>
         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
            <span class="c">## FIXME: find out why this can fail with</span>
            <span class="c">## &quot;&#39;unicode&#39; does not have the buffer interface&quot;</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;INTERNAL ERROR (getTraceback): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ie</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>

      <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">serializeMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">result</span>




<span class="k">class</span> <span class="nc">CallResultHandler</span><span class="p">(</span><span class="n">Handler</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   A handler for to RPC call results.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">typeid</span> <span class="o">=</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_RESULT</span>


   <span class="k">def</span> <span class="nf">_messageIsValid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_parts</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span>
            <span class="s">&quot;WAMP CALL_RESULT message without &lt;callid&gt;&quot;</span><span class="p">)</span>
         <span class="k">return</span> <span class="bp">False</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span>
            <span class="s">&quot;WAMP CALL_RESULT message with invalid length </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">))</span>
         <span class="k">return</span> <span class="bp">False</span>

      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span>
            <span class="p">(</span><span class="s">&quot;WAMP CALL_RESULT message with invalid type </span><span class="si">%s</span><span class="s"> for &quot;</span>
            <span class="s">&quot;&lt;callid&gt;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
         <span class="k">return</span> <span class="bp">False</span>

      <span class="k">return</span> <span class="bp">True</span>


   <span class="k">def</span> <span class="nf">_parseMessageParts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_parts</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Extract call result from message parts.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">callid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">msg_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


   <span class="k">def</span> <span class="nf">_handleMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c">## Pop and process Call Deferred</span>
      <span class="c">##</span>
      <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">calls</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
         <span class="c">## WAMP CALL_RESULT</span>
         <span class="c">##</span>
         <span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;callid not found for received call result message&quot;</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">CallErrorHandler</span><span class="p">(</span><span class="n">Handler</span><span class="p">):</span>

   <span class="n">typeid</span> <span class="o">=</span> <span class="n">WampProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPEID_CALL_ERROR</span>


   <span class="k">def</span> <span class="nf">_messageIsValid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_parts</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span>
            <span class="s">&quot;call error message invalid length </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">))</span>
         <span class="k">return</span> <span class="bp">False</span>

      <span class="c">## Error URI</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span>
            <span class="s">&quot;invalid type </span><span class="si">%s</span><span class="s"> for errorUri in call error message&quot;</span> <span class="o">%</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
         <span class="k">return</span> <span class="bp">False</span>

      <span class="c">## Error Description</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">_protocolError</span><span class="p">(</span>
            <span class="s">&quot;invalid type </span><span class="si">%s</span><span class="s"> for errorDesc in call error message&quot;</span> <span class="o">%</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])))</span>
         <span class="k">return</span> <span class="bp">False</span>

      <span class="k">return</span> <span class="bp">True</span>


   <span class="k">def</span> <span class="nf">_parseMessageParts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_parts</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Extract error information from message parts.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">callid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">erroruri</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">errordesc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

      <span class="c">## Error Details</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">errordetails</span> <span class="o">=</span> <span class="n">msg_parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">errordetails</span> <span class="o">=</span> <span class="bp">None</span>


   <span class="k">def</span> <span class="nf">_handleMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Fire Call Error Deferred.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">##</span>
      <span class="c">## Pop and process Call Deferred</span>
      <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">calls</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
         <span class="n">e</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">()</span>
         <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">erroruri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordesc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordetails</span><span class="p">)</span>
         <span class="n">d</span><span class="o">.</span><span class="n">errback</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">debugWamp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;callid not found for received call error message&quot;</span><span class="p">)</span>
</pre></div>

          <footer>
  

  <hr/>

  <p>
      &copy; Copyright 2011-2014 Tavendo GmbH.
  </p>

  <a href="https://www.github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="http://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  

</body>
</html>