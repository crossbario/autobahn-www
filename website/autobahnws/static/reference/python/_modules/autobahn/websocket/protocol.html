

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>autobahn.websocket.protocol &mdash; Autobahn 0.8.5 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../../../',
        VERSION:'0.8.5',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
    <link rel="top" title="Autobahn 0.8.5 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="icon icon-home"> Autobahn</a>
        <form class="wy-form" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search docs" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../websockettoc.html">WebSocket</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketintro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketbase.html">WebSocket</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketclient.html">WebSocket Clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketserver.html">WebSocket Servers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketcompress.html">WebSocket Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../websocketaux.html">WebSocket Auxiliary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../twistedintegration.html">Twisted Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../wamp1toc.html">WAMP v1</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp1base.html">Base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp1client.html">Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp1server.html">Server</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../wamp2.html">WAMP v2</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#sessions">Sessions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#callers">Callers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#callees">Callees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#subscribers">Subscribers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#publishers">Publishers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2.html#decorators">Decorators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../wamp2all.html">WAMP v2</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2all.html#interfaces">Interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2all.html#errors">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2all.html#router">Router</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wamp2all.html#protocol">Protocol</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="/">Autobahn</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <ul class="wy-breadcrumbs">
  <li><a href="../../../index.html">Docs</a> &raquo;</li>
  <li><a href="">autobahn.websocket.protocol</a></li>
  
</ul>
<hr/>

          
  <h1>Source code for autobahn.websocket.protocol</h1><div class="highlight"><pre>
<span class="c">###############################################################################</span>
<span class="c">##</span>
<span class="c">##  Copyright (C) 2011-2014 Tavendo GmbH</span>
<span class="c">##</span>
<span class="c">##  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c">##  you may not use this file except in compliance with the License.</span>
<span class="c">##  You may obtain a copy of the License at</span>
<span class="c">##</span>
<span class="c">##      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">##</span>
<span class="c">##  Unless required by applicable law or agreed to in writing, software</span>
<span class="c">##  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c">##  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c">##  See the License for the specific language governing permissions and</span>
<span class="c">##  limitations under the License.</span>
<span class="c">##</span>
<span class="c">###############################################################################</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">PY3</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;createWsUrl&quot;</span><span class="p">,</span>
           <span class="s">&quot;parseWsUrl&quot;</span><span class="p">,</span>

           <span class="s">&quot;ConnectionRequest&quot;</span><span class="p">,</span>
           <span class="s">&quot;ConnectionResponse&quot;</span><span class="p">,</span>
           <span class="s">&quot;Timings&quot;</span><span class="p">,</span>

           <span class="s">&quot;WebSocketProtocol&quot;</span><span class="p">,</span>
           <span class="s">&quot;WebSocketFactory&quot;</span><span class="p">,</span>
           <span class="s">&quot;WebSocketServerProtocol&quot;</span><span class="p">,</span>
           <span class="s">&quot;WebSocketServerFactory&quot;</span><span class="p">,</span>
           <span class="s">&quot;WebSocketClientProtocol&quot;</span><span class="p">,</span>
           <span class="s">&quot;WebSocketClientFactory&quot;</span><span class="p">]</span>

<span class="c">## The Python urlparse module currently does not contain the ws/wss</span>
<span class="c">## schemes, so we add those dynamically (which is a hack of course).</span>
<span class="c">##</span>
<span class="k">try</span><span class="p">:</span>
   <span class="kn">import</span> <span class="nn">urlparse</span>
<span class="k">except</span><span class="p">:</span>
   <span class="c">## Python 3</span>
   <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">urlparse</span>

<span class="n">wsschemes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="s">&quot;wss&quot;</span><span class="p">]</span>
<span class="n">urlparse</span><span class="o">.</span><span class="n">uses_relative</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wsschemes</span><span class="p">)</span>
<span class="n">urlparse</span><span class="o">.</span><span class="n">uses_netloc</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wsschemes</span><span class="p">)</span>
<span class="n">urlparse</span><span class="o">.</span><span class="n">uses_params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wsschemes</span><span class="p">)</span>
<span class="n">urlparse</span><span class="o">.</span><span class="n">uses_query</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wsschemes</span><span class="p">)</span>
<span class="n">urlparse</span><span class="o">.</span><span class="n">uses_fragment</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wsschemes</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">implementer</span>

<span class="kn">from</span> <span class="nn">autobahn</span> <span class="kn">import</span> <span class="n">__version__</span>

<span class="kn">from</span> <span class="nn">autobahn.websocket.interfaces</span> <span class="kn">import</span> <span class="n">IWebSocketChannel</span><span class="p">,</span> \
                                          <span class="n">IWebSocketChannelFrameApi</span><span class="p">,</span> \
                                          <span class="n">IWebSocketChannelStreamingApi</span>

<span class="kn">from</span> <span class="nn">autobahn.util</span> <span class="kn">import</span> <span class="n">Stopwatch</span>
<span class="kn">from</span> <span class="nn">autobahn.websocket.utf8validator</span> <span class="kn">import</span> <span class="n">Utf8Validator</span>
<span class="kn">from</span> <span class="nn">autobahn.websocket.xormasker</span> <span class="kn">import</span> <span class="n">XorMaskerNull</span><span class="p">,</span> <span class="n">createXorMasker</span>
<span class="kn">from</span> <span class="nn">autobahn.websocket.compress</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">autobahn.websocket</span> <span class="kn">import</span> <span class="n">http</span>


<div class="viewcode-block" id="createWsUrl"><a class="viewcode-back" href="../../../websocketaux.html#autobahn.websocket.protocol.createWsUrl">[docs]</a><span class="k">def</span> <span class="nf">createWsUrl</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">isSecure</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Create a WebSocket URL from components.</span>

<span class="sd">   :param hostname: WebSocket server hostname.</span>
<span class="sd">   :type hostname: str</span>
<span class="sd">   :param port: WebSocket service port or None (to select default ports 80/443 depending on isSecure).</span>
<span class="sd">   :type port: int</span>
<span class="sd">   :param isSecure: Set True for secure WebSocket (&quot;wss&quot; scheme).</span>
<span class="sd">   :type isSecure: bool</span>
<span class="sd">   :param path: Path component of addressed resource (will be properly URL escaped).</span>
<span class="sd">   :type path: str</span>
<span class="sd">   :param params: A dictionary of key-values to construct the query component of the addressed resource (will be properly URL escaped).</span>
<span class="sd">   :type params: dict</span>

<span class="sd">   :returns: str -- Constructed WebSocket URL.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">netloc</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">isSecure</span><span class="p">:</span>
         <span class="n">netloc</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:443&quot;</span> <span class="o">%</span> <span class="n">hostname</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">netloc</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:80&quot;</span> <span class="o">%</span> <span class="n">hostname</span>
   <span class="k">if</span> <span class="n">isSecure</span><span class="p">:</span>
      <span class="n">scheme</span> <span class="o">=</span> <span class="s">&quot;wss&quot;</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">scheme</span> <span class="o">=</span> <span class="s">&quot;ws&quot;</span>
   <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">ppath</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">ppath</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span>
   <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">query</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">query</span> <span class="o">=</span> <span class="bp">None</span>
   <span class="k">return</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlunparse</span><span class="p">((</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">ppath</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>


</div>
<div class="viewcode-block" id="parseWsUrl"><a class="viewcode-back" href="../../../websocketaux.html#autobahn.websocket.protocol.parseWsUrl">[docs]</a><span class="k">def</span> <span class="nf">parseWsUrl</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Parses as WebSocket URL into it&#39;s components and returns a tuple (isSecure, host, port, resource, path, params).</span>

<span class="sd">   isSecure is a flag which is True for wss URLs.</span>
<span class="sd">   host is the hostname or IP from the URL.</span>
<span class="sd">   port is the port from the URL or standard port derived from scheme (ws = 80, wss = 443).</span>
<span class="sd">   resource is the /resource name/ from the URL, the /path/ together with the (optional) /query/ component.</span>
<span class="sd">   path is the /path/ component properly unescaped.</span>
<span class="sd">   params is the /query) component properly unescaped and returned as dictionary.</span>

<span class="sd">   :param url: A valid WebSocket URL, i.e. `ws://localhost:9000/myresource?param1=23&amp;param2=666`</span>
<span class="sd">   :type url: str</span>

<span class="sd">   :returns: tuple -- A tuple (isSecure, host, port, resource, path, params)</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
   <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span> <span class="ow">or</span> <span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid WebSocket URL: missing hostname&quot;</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="s">&quot;wss&quot;</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid WebSocket URL: bogus protocol scheme &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">port</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">parsed</span><span class="o">.</span><span class="n">port</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s">&quot;ws&quot;</span><span class="p">:</span>
         <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">port</span> <span class="o">=</span> <span class="mi">443</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">fragment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">parsed</span><span class="o">.</span><span class="n">fragment</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid WebSocket URL: non-empty fragment &#39;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">parsed</span><span class="o">.</span><span class="n">fragment</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">parsed</span><span class="o">.</span><span class="n">path</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
      <span class="n">ppath</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">path</span>
      <span class="n">path</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">ppath</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">ppath</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span>
      <span class="n">path</span> <span class="o">=</span> <span class="n">ppath</span>
   <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">parsed</span><span class="o">.</span><span class="n">query</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
      <span class="n">resource</span> <span class="o">=</span> <span class="n">ppath</span> <span class="o">+</span> <span class="s">&quot;?&quot;</span> <span class="o">+</span> <span class="n">parsed</span><span class="o">.</span><span class="n">query</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">resource</span> <span class="o">=</span> <span class="n">ppath</span>
      <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s">&quot;wss&quot;</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="TrafficStats"><a class="viewcode-back" href="../../../websocketaux.html#autobahn.websocket.protocol.TrafficStats">[docs]</a><span class="k">class</span> <span class="nc">TrafficStats</span><span class="p">:</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>


   <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c">## all of the following only tracks data messages, not control frames, not handshaking</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsWireLevel</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsWebSocketLevel</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsAppLevel</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">outgoingWebSocketFrames</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">outgoingWebSocketMessages</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsWireLevel</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsWebSocketLevel</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsAppLevel</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">incomingWebSocketFrames</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">incomingWebSocketMessages</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="c">## the following track any traffic before the WebSocket connection</span>
      <span class="c">## reaches STATE_OPEN (this includes WebSocket opening handshake</span>
      <span class="c">## proxy handling and such)</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">preopenOutgoingOctetsWireLevel</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">preopenIncomingOctetsWireLevel</span> <span class="o">=</span> <span class="mi">0</span>


   <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

      <span class="c">## compression ratio = compressed size / uncompressed size</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsAppLevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">outgoingCompressionRatio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsWebSocketLevel</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsAppLevel</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">outgoingCompressionRatio</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsAppLevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">incomingCompressionRatio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsWebSocketLevel</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsAppLevel</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">incomingCompressionRatio</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c">## protocol overhead = non-payload size / payload size</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsWebSocketLevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">outgoingWebSocketOverhead</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsWireLevel</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsWebSocketLevel</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsWebSocketLevel</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">outgoingWebSocketOverhead</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsWebSocketLevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">incomingWebSocketOverhead</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsWireLevel</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsWebSocketLevel</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsWebSocketLevel</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">incomingWebSocketOverhead</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="k">return</span> <span class="p">{</span><span class="s">&#39;outgoingOctetsWireLevel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsWireLevel</span><span class="p">,</span>
              <span class="s">&#39;outgoingOctetsWebSocketLevel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsWebSocketLevel</span><span class="p">,</span>
              <span class="s">&#39;outgoingOctetsAppLevel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgoingOctetsAppLevel</span><span class="p">,</span>
              <span class="s">&#39;outgoingCompressionRatio&#39;</span><span class="p">:</span> <span class="n">outgoingCompressionRatio</span><span class="p">,</span>
              <span class="s">&#39;outgoingWebSocketOverhead&#39;</span><span class="p">:</span> <span class="n">outgoingWebSocketOverhead</span><span class="p">,</span>
              <span class="s">&#39;outgoingWebSocketFrames&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgoingWebSocketFrames</span><span class="p">,</span>
              <span class="s">&#39;outgoingWebSocketMessages&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outgoingWebSocketMessages</span><span class="p">,</span>
              <span class="s">&#39;preopenOutgoingOctetsWireLevel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">preopenOutgoingOctetsWireLevel</span><span class="p">,</span>

              <span class="s">&#39;incomingOctetsWireLevel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsWireLevel</span><span class="p">,</span>
              <span class="s">&#39;incomingOctetsWebSocketLevel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsWebSocketLevel</span><span class="p">,</span>
              <span class="s">&#39;incomingOctetsAppLevel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">incomingOctetsAppLevel</span><span class="p">,</span>
              <span class="s">&#39;incomingCompressionRatio&#39;</span><span class="p">:</span> <span class="n">incomingCompressionRatio</span><span class="p">,</span>
              <span class="s">&#39;incomingWebSocketOverhead&#39;</span><span class="p">:</span> <span class="n">incomingWebSocketOverhead</span><span class="p">,</span>
              <span class="s">&#39;incomingWebSocketFrames&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">incomingWebSocketFrames</span><span class="p">,</span>
              <span class="s">&#39;incomingWebSocketMessages&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">incomingWebSocketMessages</span><span class="p">,</span>
              <span class="s">&#39;preopenIncomingOctetsWireLevel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">preopenIncomingOctetsWireLevel</span><span class="p">}</span>


   <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__json__</span><span class="p">())</span>


</div>
<span class="k">class</span> <span class="nc">FrameHeader</span><span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Thin-wrapper for storing WebSocket frame metadata.</span>

<span class="sd">   FOR INTERNAL USE ONLY!</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">fin</span><span class="p">,</span> <span class="n">rsv</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Constructor.</span>

<span class="sd">      :param opcode: Frame opcode (0-15).</span>
<span class="sd">      :type opcode: int</span>
<span class="sd">      :param fin: Frame FIN flag.</span>
<span class="sd">      :type fin: bool</span>
<span class="sd">      :param rsv: Frame reserved flags (0-7).</span>
<span class="sd">      :type rsv: int</span>
<span class="sd">      :param length: Frame payload length.</span>
<span class="sd">      :type length: int</span>
<span class="sd">      :param mask: Frame mask (binary string) or None.</span>
<span class="sd">      :type mask: str</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">fin</span> <span class="o">=</span> <span class="n">fin</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rsv</span> <span class="o">=</span> <span class="n">rsv</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>



<div class="viewcode-block" id="ConnectionRequest"><a class="viewcode-back" href="../../../websocketserver.html#autobahn.websocket.protocol.ConnectionRequest">[docs]</a><span class="k">class</span> <span class="nc">ConnectionRequest</span><span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Thin-wrapper for WebSocket connection request information provided in</span>
<span class="sd">   :meth:`autobahn.websocket.protocol.WebSocketServerProtocol.onConnect` when</span>
<span class="sd">   a WebSocket client want to establish a connection to a WebSocket server.</span>
<span class="sd">   &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ConnectionRequest.__init__"><a class="viewcode-back" href="../../../websocketserver.html#autobahn.websocket.protocol.ConnectionRequest.__init__">[docs]</a>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">protocols</span><span class="p">,</span> <span class="n">extensions</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Constructor.</span>

<span class="sd">      :param peer: Descriptor of the connecting client (eg IP address/port in case of TCP transports).</span>
<span class="sd">      :type peer: str</span>
<span class="sd">      :param headers: HTTP headers from opening handshake request.</span>
<span class="sd">      :type headers: dict</span>
<span class="sd">      :param host: Host from opening handshake HTTP header.</span>
<span class="sd">      :type host: str</span>
<span class="sd">      :param path: Path from requested HTTP resource URI. For example, a resource URI of `/myservice?foo=23&amp;foo=66&amp;bar=2` will be parsed to `/myservice`.</span>
<span class="sd">      :type path: str</span>
<span class="sd">      :param params: Query parameters (if any) from requested HTTP resource URI. For example, a resource URI of `/myservice?foo=23&amp;foo=66&amp;bar=2` will be parsed to `{&#39;foo&#39;: [&#39;23&#39;, &#39;66&#39;], &#39;bar&#39;: [&#39;2&#39;]}`.</span>
<span class="sd">      :type params: dict of arrays of strings</span>
<span class="sd">      :param version: The WebSocket protocol version the client announced (and will be spoken, when connection is accepted).</span>
<span class="sd">      :type version: int</span>
<span class="sd">      :param origin: The WebSocket origin header or None. Note that this only a reliable source of information for browser clients!</span>
<span class="sd">      :type origin: str</span>
<span class="sd">      :param protocols: The WebSocket (sub)protocols the client announced. You must select and return one of those (or None) in :meth:`autobahn.websocket.WebSocketServerProtocol.onConnect`.</span>
<span class="sd">      :type protocols: array of strings</span>
<span class="sd">      :param extensions: The WebSocket extensions the client requested and the server accepted (and thus will be spoken, when WS connection is established).</span>
<span class="sd">      :type extensions: array of strings</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">peer</span> <span class="o">=</span> <span class="n">peer</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="o">=</span> <span class="n">protocols</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="n">extensions</span>

</div>
   <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">{</span><span class="s">&#39;peer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span>
              <span class="s">&#39;headers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
              <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
              <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
              <span class="s">&#39;params&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
              <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
              <span class="s">&#39;origin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span>
              <span class="s">&#39;protocols&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span><span class="p">,</span>
              <span class="s">&#39;extensions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">}</span>


   <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__json__</span><span class="p">())</span>


</div>
<div class="viewcode-block" id="ConnectionResponse"><a class="viewcode-back" href="../../../websocketclient.html#autobahn.websocket.protocol.ConnectionResponse">[docs]</a><span class="k">class</span> <span class="nc">ConnectionResponse</span><span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Thin-wrapper for WebSocket connection response information provided in</span>
<span class="sd">   :meth:`autobahn.websocket.protocol.WebSocketClientProtocol.onConnect` when</span>
<span class="sd">   a WebSocket server has accepted a connection request by a client.</span>
<span class="sd">   &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ConnectionResponse.__init__"><a class="viewcode-back" href="../../../websocketclient.html#autobahn.websocket.protocol.ConnectionResponse.__init__">[docs]</a>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">extensions</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Constructor.</span>

<span class="sd">      :param peer: Descriptor of the connected server (e.g. IP address/port in case of TCP transport).</span>
<span class="sd">      :type peer: str</span>
<span class="sd">      :param headers: HTTP headers from opening handshake response.</span>
<span class="sd">      :type headers: dict</span>
<span class="sd">      :param version: The WebSocket protocol version that is spoken.</span>
<span class="sd">      :type version: int</span>
<span class="sd">      :param protocol: The WebSocket (sub)protocol in use.</span>
<span class="sd">      :type protocol: str</span>
<span class="sd">      :param extensions: The WebSocket extensions in use.</span>
<span class="sd">      :type extensions: array of strings</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">peer</span> <span class="o">=</span> <span class="n">peer</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="n">extensions</span>

</div>
   <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">{</span><span class="s">&#39;peer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span>
              <span class="s">&#39;headers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
              <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
              <span class="s">&#39;protocol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
              <span class="s">&#39;extensions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">}</span>


   <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__json__</span><span class="p">())</span>


</div>
<span class="k">def</span> <span class="nf">parseHttpHeader</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Parses the beginning of a HTTP request header (the data up to the \n\n line) into a pair</span>
<span class="sd">   of status line and HTTP headers dictionary.</span>
<span class="sd">   Header keys are normalized to all-lower-case.</span>

<span class="sd">   FOR INTERNAL USE ONLY!</span>

<span class="sd">   :param data: The HTTP header data up to the \n\n line.</span>
<span class="sd">   :type data: str</span>

<span class="sd">   :returns: tuple -- Tuple of HTTP status line, headers and headers count.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">raw</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
   <span class="n">http_status_line</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
   <span class="n">http_headers</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="n">http_headers_cnt</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="c">## HTTP header keys are case-insensitive</span>
         <span class="n">key</span> <span class="o">=</span> <span class="n">h</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

         <span class="c">## not sure if UTF-8 is allowed for HTTP header values..</span>
         <span class="n">value</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

         <span class="c">## handle HTTP headers split across multiple lines</span>
         <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">http_headers</span><span class="p">:</span>
            <span class="n">http_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&quot;, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">value</span>
            <span class="n">http_headers_cnt</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">http_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">http_headers_cnt</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c"># skip bad HTTP header</span>
         <span class="k">pass</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">http_status_line</span><span class="p">,</span> <span class="n">http_headers</span><span class="p">,</span> <span class="n">http_headers_cnt</span><span class="p">)</span>



<div class="viewcode-block" id="Timings"><a class="viewcode-back" href="../../../websocketaux.html#autobahn.websocket.protocol.Timings">[docs]</a><span class="k">class</span> <span class="nc">Timings</span><span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Helper class to track timings by key. This class also supports item access,</span>
<span class="sd">   iteration and conversion to string.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span> <span class="o">=</span> <span class="n">Stopwatch</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_timings</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Timings.track"><a class="viewcode-back" href="../../../websocketaux.html#autobahn.websocket.protocol.Timings.track">[docs]</a>   <span class="k">def</span> <span class="nf">track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Track elapsed for key.</span>

<span class="sd">      :param key: Key under which to track the timing.</span>
<span class="sd">      :type key: str</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_timings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">elapsed</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Timings.diff"><a class="viewcode-back" href="../../../websocketaux.html#autobahn.websocket.protocol.Timings.diff">[docs]</a>   <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startKey</span><span class="p">,</span> <span class="n">endKey</span><span class="p">,</span> <span class="n">format</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Get elapsed difference between two previously tracked keys.</span>

<span class="sd">      :param startKey: First key for interval (older timestamp).</span>
<span class="sd">      :type startKey: str</span>
<span class="sd">      :param endKey: Second key for interval (younger timestamp).</span>
<span class="sd">      :type endKey: str</span>
<span class="sd">      :param format: If `True`, format computed time period and return string.</span>
<span class="sd">      :type format: bool</span>

<span class="sd">      :returns: float or str -- Computed time period in seconds (or formatted string).</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">endKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timings</span> <span class="ow">and</span> <span class="n">startKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timings</span><span class="p">:</span>
         <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timings</span><span class="p">[</span><span class="n">endKey</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timings</span><span class="p">[</span><span class="n">startKey</span><span class="p">]</span>
         <span class="k">if</span> <span class="n">format</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">:</span> <span class="c"># 10us</span>
               <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> ns&quot;</span> <span class="o">%</span> <span class="nb">round</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="mf">1000000000.</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="c"># 10ms</span>
               <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> us&quot;</span> <span class="o">%</span> <span class="nb">round</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="mf">1000000.</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="c"># 10s</span>
               <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> ms&quot;</span> <span class="o">%</span> <span class="nb">round</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="mf">1000.</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> s&quot;</span> <span class="o">%</span> <span class="nb">round</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">format</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;n.a.&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
   <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timings</span><span class="o">.</span><span class="n">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timings</span><span class="p">)</span>


</div>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IWebSocketChannel</span><span class="p">)</span>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IWebSocketChannelFrameApi</span><span class="p">)</span>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IWebSocketChannelStreamingApi</span><span class="p">)</span>
<div class="viewcode-block" id="WebSocketProtocol"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol">[docs]</a><span class="k">class</span> <span class="nc">WebSocketProtocol</span><span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Protocol base class for WebSocket.</span>

<span class="sd">   This class implements:</span>

<span class="sd">     * :class:`autobahn.websocket.interfaces.IWebSocketChannel`</span>
<span class="sd">     * :class:`autobahn.websocket.interfaces.IWebSocketChannelFrameApi`</span>
<span class="sd">     * :class:`autobahn.websocket.interfaces.IWebSocketChannelStreamingApi`</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">SUPPORTED_SPEC_VERSIONS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   WebSocket protocol spec (draft) versions supported by this implementation.</span>
<span class="sd">   Use of version 18 indicates RFC6455. Use of versions &lt; 18 indicate actual</span>
<span class="sd">   draft spec versions (Hybi-Drafts). Use of version 0 indicates Hixie-76.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">SUPPORTED_PROTOCOL_VERSIONS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   WebSocket protocol versions supported by this implementation. For Hixie-76,</span>
<span class="sd">   there is no protocol version announced in HTTP header, and we just use the</span>
<span class="sd">   draft version (0) in this case.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">SPEC_TO_PROTOCOL_VERSION</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">18</span><span class="p">:</span> <span class="mi">13</span><span class="p">}</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Mapping from protocol spec (draft) version to protocol version.  For Hixie-76,</span>
<span class="sd">   there is no protocol version announced in HTTP header, and we just use the</span>
<span class="sd">   pseudo protocol version 0 in this case.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">PROTOCOL_TO_SPEC_VERSION</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span> <span class="mi">18</span><span class="p">}</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Mapping from protocol version to the latest protocol spec (draft) version</span>
<span class="sd">   using that protocol version.  For Hixie-76, there is no protocol version</span>
<span class="sd">   announced in HTTP header, and we just use the draft version (0) in this case.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">DEFAULT_SPEC_VERSION</span> <span class="o">=</span> <span class="mi">18</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Default WebSocket protocol spec version this implementation speaks: final RFC6455.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">DEFAULT_ALLOW_HIXIE76</span> <span class="o">=</span> <span class="bp">False</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   By default, this implementation will not allow to speak the obsoleted</span>
<span class="sd">   Hixie-76 protocol version. That protocol version has security issues, but</span>
<span class="sd">   is still spoken by some clients. Enable at your own risk! Enabling can be</span>
<span class="sd">   done by using setProtocolOptions() on the factories for clients and servers.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">_WS_MAGIC</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Protocol defined magic used during WebSocket handshake (used in Hybi-drafts</span>
<span class="sd">   and final RFC6455.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">_QUEUED_WRITE_DELAY</span> <span class="o">=</span> <span class="mf">0.00001</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   For synched/chopped writes, this is the reactor reentry delay in seconds.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">MESSAGE_TYPE_TEXT</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   WebSocket text message type (UTF-8 payload).</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">MESSAGE_TYPE_BINARY</span> <span class="o">=</span> <span class="mi">2</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   WebSocket binary message type (arbitrary binary payload).</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="c">## WebSocket protocol state:</span>
   <span class="c">## (STATE_PROXY_CONNECTING) =&gt; STATE_CONNECTING =&gt; STATE_OPEN =&gt; STATE_CLOSING =&gt; STATE_CLOSED</span>
   <span class="c">##</span>
   <span class="n">STATE_CLOSED</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">STATE_CONNECTING</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="n">STATE_CLOSING</span> <span class="o">=</span> <span class="mi">2</span>
   <span class="n">STATE_OPEN</span> <span class="o">=</span> <span class="mi">3</span>
   <span class="n">STATE_PROXY_CONNECTING</span> <span class="o">=</span> <span class="mi">4</span>

   <span class="c">## Streaming Send State</span>
   <span class="n">SEND_STATE_GROUND</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">SEND_STATE_MESSAGE_BEGIN</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="n">SEND_STATE_INSIDE_MESSAGE</span> <span class="o">=</span> <span class="mi">2</span>
   <span class="n">SEND_STATE_INSIDE_MESSAGE_FRAME</span> <span class="o">=</span> <span class="mi">3</span>

   <span class="c">## WebSocket protocol close codes</span>
   <span class="c">##</span>
   <span class="n">CLOSE_STATUS_CODE_NORMAL</span> <span class="o">=</span> <span class="mi">1000</span>
   <span class="sd">&quot;&quot;&quot;Normal close of connection.&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_GOING_AWAY</span> <span class="o">=</span> <span class="mi">1001</span>
   <span class="sd">&quot;&quot;&quot;Going away.&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_PROTOCOL_ERROR</span> <span class="o">=</span> <span class="mi">1002</span>
   <span class="sd">&quot;&quot;&quot;Protocol error.&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_UNSUPPORTED_DATA</span> <span class="o">=</span> <span class="mi">1003</span>
   <span class="sd">&quot;&quot;&quot;Unsupported data.&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_RESERVED1</span> <span class="o">=</span> <span class="mi">1004</span>
   <span class="sd">&quot;&quot;&quot;RESERVED&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_NULL</span> <span class="o">=</span> <span class="mi">1005</span> <span class="c"># MUST NOT be set in close frame!</span>
   <span class="sd">&quot;&quot;&quot;No status received. (MUST NOT be used as status code when sending a close).&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_ABNORMAL_CLOSE</span> <span class="o">=</span> <span class="mi">1006</span> <span class="c"># MUST NOT be set in close frame!</span>
   <span class="sd">&quot;&quot;&quot;Abnormal close of connection. (MUST NOT be used as status code when sending a close).&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_INVALID_PAYLOAD</span> <span class="o">=</span> <span class="mi">1007</span>
   <span class="sd">&quot;&quot;&quot;Invalid frame payload data.&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_POLICY_VIOLATION</span> <span class="o">=</span> <span class="mi">1008</span>
   <span class="sd">&quot;&quot;&quot;Policy violation.&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_MESSAGE_TOO_BIG</span> <span class="o">=</span> <span class="mi">1009</span>
   <span class="sd">&quot;&quot;&quot;Message too big.&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_MANDATORY_EXTENSION</span> <span class="o">=</span> <span class="mi">1010</span>
   <span class="sd">&quot;&quot;&quot;Mandatory extension.&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_INTERNAL_ERROR</span> <span class="o">=</span> <span class="mi">1011</span>
   <span class="sd">&quot;&quot;&quot;The peer encountered an unexpected condition or internal error.&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODE_TLS_HANDSHAKE_FAILED</span> <span class="o">=</span> <span class="mi">1015</span> <span class="c"># MUST NOT be set in close frame!</span>
   <span class="sd">&quot;&quot;&quot;TLS handshake failed, i.e. server certificate could not be verified. (MUST NOT be used as status code when sending a close).&quot;&quot;&quot;</span>

   <span class="n">CLOSE_STATUS_CODES_ALLOWED</span> <span class="o">=</span> <span class="p">[</span><span class="n">CLOSE_STATUS_CODE_NORMAL</span><span class="p">,</span>
                                 <span class="n">CLOSE_STATUS_CODE_GOING_AWAY</span><span class="p">,</span>
                                 <span class="n">CLOSE_STATUS_CODE_PROTOCOL_ERROR</span><span class="p">,</span>
                                 <span class="n">CLOSE_STATUS_CODE_UNSUPPORTED_DATA</span><span class="p">,</span>
                                 <span class="n">CLOSE_STATUS_CODE_INVALID_PAYLOAD</span><span class="p">,</span>
                                 <span class="n">CLOSE_STATUS_CODE_POLICY_VIOLATION</span><span class="p">,</span>
                                 <span class="n">CLOSE_STATUS_CODE_MESSAGE_TOO_BIG</span><span class="p">,</span>
                                 <span class="n">CLOSE_STATUS_CODE_MANDATORY_EXTENSION</span><span class="p">,</span>
                                 <span class="n">CLOSE_STATUS_CODE_INTERNAL_ERROR</span><span class="p">]</span>
   <span class="sd">&quot;&quot;&quot;Status codes allowed to send in close.&quot;&quot;&quot;</span>


   <span class="n">CONFIG_ATTRS_COMMON</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">,</span>
                          <span class="s">&#39;debugCodePaths&#39;</span><span class="p">,</span>
                          <span class="s">&#39;logOctets&#39;</span><span class="p">,</span>
                          <span class="s">&#39;logFrames&#39;</span><span class="p">,</span>
                          <span class="s">&#39;trackTimings&#39;</span><span class="p">,</span>
                          <span class="s">&#39;allowHixie76&#39;</span><span class="p">,</span>
                          <span class="s">&#39;utf8validateIncoming&#39;</span><span class="p">,</span>
                          <span class="s">&#39;applyMask&#39;</span><span class="p">,</span>
                          <span class="s">&#39;maxFramePayloadSize&#39;</span><span class="p">,</span>
                          <span class="s">&#39;maxMessagePayloadSize&#39;</span><span class="p">,</span>
                          <span class="s">&#39;autoFragmentSize&#39;</span><span class="p">,</span>
                          <span class="s">&#39;failByDrop&#39;</span><span class="p">,</span>
                          <span class="s">&#39;echoCloseCodeReason&#39;</span><span class="p">,</span>
                          <span class="s">&#39;openHandshakeTimeout&#39;</span><span class="p">,</span>
                          <span class="s">&#39;closeHandshakeTimeout&#39;</span><span class="p">,</span>
                          <span class="s">&#39;tcpNoDelay&#39;</span><span class="p">]</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Configuration attributes common to servers and clients.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">CONFIG_ATTRS_SERVER</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;versions&#39;</span><span class="p">,</span>
                          <span class="s">&#39;webStatus&#39;</span><span class="p">,</span>
                          <span class="s">&#39;requireMaskedClientFrames&#39;</span><span class="p">,</span>
                          <span class="s">&#39;maskServerFrames&#39;</span><span class="p">,</span>
                          <span class="s">&#39;perMessageCompressionAccept&#39;</span><span class="p">]</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Configuration attributes specific to servers.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">CONFIG_ATTRS_CLIENT</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">,</span>
                          <span class="s">&#39;acceptMaskedServerFrames&#39;</span><span class="p">,</span>
                          <span class="s">&#39;maskClientFrames&#39;</span><span class="p">,</span>
                          <span class="s">&#39;serverConnectionDropTimeout&#39;</span><span class="p">,</span>
                          <span class="s">&#39;perMessageCompressionOffers&#39;</span><span class="p">,</span>
                          <span class="s">&#39;perMessageCompressionAccept&#39;</span><span class="p">]</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Configuration attributes specific to clients.</span>
<span class="sd">   &quot;&quot;&quot;</span>


<div class="viewcode-block" id="WebSocketProtocol.onOpen"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.onOpen">[docs]</a>   <span class="k">def</span> <span class="nf">onOpen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.onOpen`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;WebSocketProtocol.onOpen&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.onMessageBegin"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.onMessageBegin">[docs]</a>   <span class="k">def</span> <span class="nf">onMessageBegin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isBinary</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.onMessageBegin`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">message_is_binary</span> <span class="o">=</span> <span class="n">isBinary</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">message_data</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">message_data_total_length</span> <span class="o">=</span> <span class="mi">0</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.onMessageFrameBegin"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.onMessageFrameBegin">[docs]</a>   <span class="k">def</span> <span class="nf">onMessageFrameBegin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.onMessageFrameBegin`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">frame_length</span> <span class="o">=</span> <span class="n">length</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">frame_data</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">message_data_total_length</span> <span class="o">+=</span> <span class="n">length</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">failedByMe</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_data_total_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wasMaxMessagePayloadSizeExceeded</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failConnection</span><span class="p">(</span><span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CLOSE_STATUS_CODE_MESSAGE_TOO_BIG</span><span class="p">,</span> <span class="s">&quot;message exceeds payload limit of </span><span class="si">%d</span><span class="s"> octets&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span><span class="p">)</span>
         <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxFramePayloadSize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxFramePayloadSize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wasMaxFramePayloadSizeExceeded</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failConnection</span><span class="p">(</span><span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CLOSE_STATUS_CODE_POLICY_VIOLATION</span><span class="p">,</span> <span class="s">&quot;frame exceeds payload limit of </span><span class="si">%d</span><span class="s"> octets&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxFramePayloadSize</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.onMessageFrameData"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.onMessageFrameData">[docs]</a>   <span class="k">def</span> <span class="nf">onMessageFrameData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.onMessageFrameData`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">failedByMe</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_data_total_length</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_data_total_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">wasMaxMessagePayloadSizeExceeded</span> <span class="o">=</span> <span class="bp">True</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">failConnection</span><span class="p">(</span><span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CLOSE_STATUS_CODE_MESSAGE_TOO_BIG</span><span class="p">,</span> <span class="s">&quot;message exceeds payload limit of </span><span class="si">%d</span><span class="s"> octets&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.onMessageFrameEnd"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.onMessageFrameEnd">[docs]</a>   <span class="k">def</span> <span class="nf">onMessageFrameEnd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.onMessageFrameEnd`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">failedByMe</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_onMessageFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_data</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">frame_data</span> <span class="o">=</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.onMessageFrame"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.onMessageFrame">[docs]</a>   <span class="k">def</span> <span class="nf">onMessageFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.onMessageFrame`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">failedByMe</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">message_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.onMessageEnd"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.onMessageEnd">[docs]</a>   <span class="k">def</span> <span class="nf">onMessageEnd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.onMessageEnd`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">failedByMe</span><span class="p">:</span>
         <span class="n">payload</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message_data</span><span class="p">)</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="s">&quot;onMessage&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_onMessage</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_is_binary</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">message_data</span> <span class="o">=</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.onMessage"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.onMessage">[docs]</a>   <span class="k">def</span> <span class="nf">onMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">isBinary</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.onMessage`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;WebSocketProtocol.onMessage&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.onPing"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.onPing">[docs]</a>   <span class="k">def</span> <span class="nf">onPing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.onPing`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;WebSocketProtocol.onPing&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendPong</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.onPong"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.onPong">[docs]</a>   <span class="k">def</span> <span class="nf">onPong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.onPong`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;WebSocketProtocol.onPong&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.onClose"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.onClose">[docs]</a>   <span class="k">def</span> <span class="nf">onClose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wasClean</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.onClose`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
         <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;WebSocketProtocol.onClose:</span><span class="se">\n</span><span class="s">&quot;</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;wasClean=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">wasClean</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;code=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">code</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;reason=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">reason</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;self.closedByMe=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">closedByMe</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;self.failedByMe=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">failedByMe</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;self.droppedByMe=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">droppedByMe</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;self.wasClean=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">wasClean</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;self.wasNotCleanReason=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">wasNotCleanReason</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;self.localCloseCode=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">localCloseCode</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;self.localCloseReason=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">localCloseReason</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;self.remoteCloseCode=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteCloseCode</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;self.remoteCloseReason=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteCloseReason</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

</div>
   <span class="k">def</span> <span class="nf">onCloseFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">reasonRaw</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback when a Close frame was received. The default implementation answers by</span>
<span class="sd">      sending a Close when no Close was sent before. Otherwise it drops</span>
<span class="sd">      the TCP connection either immediately (when we are a server) or after a timeout</span>
<span class="sd">      (when we are a client and expect the server to drop the TCP).</span>

<span class="sd">      Modes: Hybi, Hixie</span>

<span class="sd">      Notes:</span>
<span class="sd">        - For Hixie mode, this method is slightly misnamed for historic reasons.</span>
<span class="sd">        - For Hixie mode, code and reasonRaw are silently ignored.</span>

<span class="sd">      :param code: None or close status code, if there was one (:class:`WebSocketProtocol`.CLOSE_STATUS_CODE_*).</span>
<span class="sd">      :type code: int</span>
<span class="sd">      :param reason: None or close reason (when present, a status code MUST have been also be present).</span>
<span class="sd">      :type reason: str</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;WebSocketProtocol.onCloseFrame&quot;</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">remoteCloseCode</span> <span class="o">=</span> <span class="n">code</span>

      <span class="c">## reserved close codes: 0-999, 1004, 1005, 1006, 1011-2999, &gt;= 5000</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">code</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="ow">or</span> <span class="p">(</span><span class="n">code</span> <span class="o">&gt;=</span> <span class="mi">1000</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="mi">2999</span> <span class="ow">and</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CLOSE_STATUS_CODES_ALLOWED</span><span class="p">)</span> <span class="ow">or</span> <span class="n">code</span> <span class="o">&gt;=</span> <span class="mi">5000</span><span class="p">):</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;invalid close code </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">code</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>

      <span class="c">## closing reason</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">reasonRaw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="c">## we use our own UTF-8 validator to get consistent and fully conformant</span>
         <span class="c">## UTF-8 validation behavior</span>
         <span class="n">u</span> <span class="o">=</span> <span class="n">Utf8Validator</span><span class="p">()</span>
         <span class="n">val</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">reasonRaw</span><span class="p">)</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalidPayload</span><span class="p">(</span><span class="s">&quot;invalid close reason (non-UTF-8 payload)&quot;</span><span class="p">):</span>
               <span class="k">return</span> <span class="bp">True</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">remoteCloseReason</span> <span class="o">=</span> <span class="n">reasonRaw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSING</span><span class="p">:</span>
         <span class="c">## We already initiated the closing handshake, so this</span>
         <span class="c">## is the peer&#39;s reply to our close frame.</span>

         <span class="c">## cancel any closing HS timer if present</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeoutCall</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;closeHandshakeTimeoutCall.cancel&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeoutCall</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeoutCall</span> <span class="o">=</span> <span class="bp">None</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">wasClean</span> <span class="o">=</span> <span class="bp">True</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span><span class="p">:</span>
            <span class="c">## When we are a server, we immediately drop the TCP.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropConnection</span><span class="p">(</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c">## When we are a client, the server should drop the TCP</span>
            <span class="c">## If that doesn&#39;t happen, we do. And that will set wasClean = False.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverConnectionDropTimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">serverConnectionDropTimeoutCall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_callLater</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serverConnectionDropTimeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onServerConnectionDropTimeout</span><span class="p">)</span>

      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="c">## The peer initiates a closing handshake, so we reply</span>
         <span class="c">## by sending close frame.</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">wasClean</span> <span class="o">=</span> <span class="bp">True</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendCloseFrame</span><span class="p">(</span><span class="n">isReply</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c">## Either reply with same code/reason, or code == NORMAL/reason=None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">echoCloseCodeReason</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">sendCloseFrame</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">,</span> <span class="n">reasonUtf8</span> <span class="o">=</span> <span class="n">reason</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;UTF-8&quot;</span><span class="p">),</span> <span class="n">isReply</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">sendCloseFrame</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CLOSE_STATUS_CODE_NORMAL</span><span class="p">,</span> <span class="n">isReply</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span><span class="p">:</span>
            <span class="c">## When we are a server, we immediately drop the TCP.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropConnection</span><span class="p">(</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c">## When we are a client, we expect the server to drop the TCP,</span>
            <span class="c">## and when the server fails to do so, a timeout in sendCloseFrame()</span>
            <span class="c">## will set wasClean = False back again.</span>
            <span class="k">pass</span>

      <span class="k">else</span><span class="p">:</span>
         <span class="c">## STATE_PROXY_CONNECTING, STATE_CONNECTING, STATE_CLOSED</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;logic error&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">onServerConnectionDropTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      We (a client) expected the peer (a server) to drop the connection,</span>
<span class="sd">      but it didn&#39;t (in time self.serverConnectionDropTimeout).</span>
<span class="sd">      So we drop the connection, but set self.wasClean = False.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">serverConnectionDropTimeoutCall</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSED</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;onServerConnectionDropTimeout&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wasClean</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wasNotCleanReason</span> <span class="o">=</span> <span class="s">&quot;server did not drop TCP connection (in time)&quot;</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wasServerConnectionDropTimeout</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">dropConnection</span><span class="p">(</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;skipping onServerConnectionDropTimeout since connection is already closed&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">onOpenHandshakeTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      We expected the peer to complete the opening handshake with to us.</span>
<span class="sd">      It didn&#39;t do so (in time self.openHandshakeTimeout).</span>
<span class="sd">      So we drop the connection, but set self.wasClean = False.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeoutCall</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CONNECTING</span><span class="p">,</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_PROXY_CONNECTING</span><span class="p">]:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;onOpenHandshakeTimeout fired&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wasClean</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wasNotCleanReason</span> <span class="o">=</span> <span class="s">&quot;peer did not finish (in time) the opening handshake&quot;</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wasOpenHandshakeTimeout</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">dropConnection</span><span class="p">(</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;skipping onOpenHandshakeTimeout since WebSocket connection is open (opening handshake already finished)&quot;</span><span class="p">)</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSING</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;skipping onOpenHandshakeTimeout since WebSocket connection is closing&quot;</span><span class="p">)</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSED</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;skipping onOpenHandshakeTimeout since WebSocket connection already closed&quot;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c"># should not arrive here</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;logic error&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">onCloseHandshakeTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      We expected the peer to respond to us initiating a close handshake. It didn&#39;t</span>
<span class="sd">      respond (in time self.closeHandshakeTimeout) with a close response frame though.</span>
<span class="sd">      So we drop the connection, but set self.wasClean = False.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeoutCall</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSED</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;onCloseHandshakeTimeout fired&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wasClean</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wasNotCleanReason</span> <span class="o">=</span> <span class="s">&quot;peer did not respond (in time) in closing handshake&quot;</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wasCloseHandshakeTimeout</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">dropConnection</span><span class="p">(</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;skipping onCloseHandshakeTimeout since connection is already closed&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">dropConnection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abort</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Drop the underlying TCP connection.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSED</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;dropping connection&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">droppedByMe</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSED</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">_closeConnection</span><span class="p">(</span><span class="n">abort</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;skipping dropConnection since connection is already closed&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">failConnection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">CLOSE_STATUS_CODE_GOING_AWAY</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;Going Away&quot;</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Fails the WebSocket connection.</span>

<span class="sd">      Modes: Hybi, Hixie</span>

<span class="sd">      Notes:</span>
<span class="sd">        - For Hixie mode, the code and reason are silently ignored.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSED</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;Failing connection : </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">failedByMe</span> <span class="o">=</span> <span class="bp">True</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failByDrop</span><span class="p">:</span>
            <span class="c">## brutally drop the TCP connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wasClean</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wasNotCleanReason</span> <span class="o">=</span> <span class="s">&quot;I failed the WebSocket connection by dropping the TCP connection&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropConnection</span><span class="p">(</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSING</span><span class="p">:</span>
               <span class="c">## perform WebSocket closing handshake</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">sendCloseFrame</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">,</span> <span class="n">reasonUtf8</span> <span class="o">=</span> <span class="n">reason</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;UTF-8&quot;</span><span class="p">)[:</span><span class="mi">125</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">isReply</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="c">## already performing closing handshake .. we now drop the TCP</span>
               <span class="c">## (this can happen e.g. if we encounter a 2nd protocol violation during closing HS)</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">dropConnection</span><span class="p">(</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;skipping failConnection since connection is already closed&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">protocolViolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Fired when a WebSocket protocol violation/error occurs.</span>

<span class="sd">      Modes: Hybi, Hixie</span>

<span class="sd">      Notes:</span>
<span class="sd">        - For Hixie mode, reason is silently ignored.</span>

<span class="sd">      :param reason: Protocol violation that was encountered (human readable).</span>
<span class="sd">      :type reason: str</span>

<span class="sd">      :returns: bool -- True, when any further processing should be discontinued.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;Protocol violation : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">reason</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">failConnection</span><span class="p">(</span><span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CLOSE_STATUS_CODE_PROTOCOL_ERROR</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failByDrop</span><span class="p">:</span>
         <span class="k">return</span> <span class="bp">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c">## if we don&#39;t immediately drop the TCP, we need to skip the invalid frame</span>
         <span class="c">## to continue to later receive the closing handshake reply</span>
         <span class="k">return</span> <span class="bp">False</span>


   <span class="k">def</span> <span class="nf">invalidPayload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Fired when invalid payload is encountered. Currently, this only happens</span>
<span class="sd">      for text message when payload is invalid UTF-8 or close frames with</span>
<span class="sd">      close reason that is invalid UTF-8.</span>

<span class="sd">      Modes: Hybi, Hixie</span>

<span class="sd">      Notes:</span>
<span class="sd">        - For Hixie mode, reason is silently ignored.</span>

<span class="sd">      :param reason: What was invalid for the payload (human readable).</span>
<span class="sd">      :type reason: str</span>

<span class="sd">      :returns: bool -- True, when any further processing should be discontinued.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;Invalid payload : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">reason</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">failConnection</span><span class="p">(</span><span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CLOSE_STATUS_CODE_INVALID_PAYLOAD</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failByDrop</span><span class="p">:</span>
         <span class="k">return</span> <span class="bp">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c">## if we don&#39;t immediately drop the TCP, we need to skip the invalid frame</span>
         <span class="c">## to continue to later receive the closing handshake reply</span>
         <span class="k">return</span> <span class="bp">False</span>


   <span class="k">def</span> <span class="nf">setTrackTimings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Enable/disable tracking of detailed timings.</span>

<span class="sd">      :param enable: Turn time tracking on/off.</span>
<span class="sd">      :type enable: bool</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;trackTimings&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackTimings</span> <span class="o">!=</span> <span class="n">enable</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">trackTimings</span> <span class="o">=</span> <span class="n">enable</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackTimings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span> <span class="o">=</span> <span class="n">Timings</span><span class="p">()</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span> <span class="o">=</span> <span class="bp">None</span>


   <span class="k">def</span> <span class="nf">_connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      This is called by network framework when a new TCP connection has been established</span>
<span class="sd">      and handed over to a Protocol instance (an instance of this class).</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="c">## copy default options from factory (so we are not affected by changed on</span>
      <span class="c">## those), but only copy if not already set on protocol instance (allow</span>
      <span class="c">## to set configuration individually)</span>
      <span class="c">##</span>
      <span class="n">configAttrLog</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">configAttr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_ATTRS</span><span class="p">:</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configAttr</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configAttr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="p">,</span> <span class="n">configAttr</span><span class="p">))</span>
            <span class="n">configAttrSource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">configAttrSource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
         <span class="n">configAttrLog</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">configAttr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configAttr</span><span class="p">),</span> <span class="n">configAttrSource</span><span class="p">))</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="c">#self.factory._log(configAttrLog)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">pformat</span><span class="p">(</span><span class="n">configAttrLog</span><span class="p">))</span>

      <span class="c">## permessage-compress extension</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c">## Time tracking</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setTrackTimings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trackTimings</span><span class="p">)</span>

      <span class="c">## Traffic stats</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span> <span class="o">=</span> <span class="n">TrafficStats</span><span class="p">()</span>

      <span class="c">## initial state</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_PROXY_CONNECTING</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CONNECTING</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_GROUND</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;&quot;</span>

      <span class="c">## for chopped/synched sends, we need to queue to maintain</span>
      <span class="c">## ordering when recalling the reactor to actually &quot;force&quot;</span>
      <span class="c">## the octets to wire (see test/trickling in the repo)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">triggered</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="c">## incremental UTF8 validator</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">utf8validator</span> <span class="o">=</span> <span class="n">Utf8Validator</span><span class="p">()</span>

      <span class="c">## track when frame/message payload sizes (incoming) were exceeded</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">wasMaxFramePayloadSizeExceeded</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">wasMaxMessagePayloadSizeExceeded</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="c">## the following vars are related to connection close handling/tracking</span>

      <span class="c"># True, iff I have initiated closing HS (that is, did send close first)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">closedByMe</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="c"># True, iff I have failed the WS connection (i.e. due to protocol error)</span>
      <span class="c"># Failing can be either by initiating close HS or brutal drop (this is</span>
      <span class="c"># controlled by failByDrop option)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">failedByMe</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="c"># True, iff I dropped the TCP connection (called transport.loseConnection())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">droppedByMe</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="c"># True, iff full WebSocket closing handshake was performed (close frame sent</span>
      <span class="c"># and received) _and_ the server dropped the TCP (which is its responsibility)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">wasClean</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="c"># When self.wasClean = False, the reason (what happened)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">wasNotCleanReason</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c"># When we are a client, and we expected the server to drop the TCP, but that</span>
      <span class="c"># didn&#39;t happen in time, this gets True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">wasServerConnectionDropTimeout</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="c"># When the initial WebSocket opening handshake times out, this gets True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">wasOpenHandshakeTimeout</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="c"># When we initiated a closing handshake, but the peer did not respond in</span>
      <span class="c"># time, this gets True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">wasCloseHandshakeTimeout</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="c"># The close code I sent in close frame (if any)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">localCloseCode</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c"># The close reason I sent in close frame (if any)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">localCloseReason</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c"># The close code the peer sent me in close frame (if any)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">remoteCloseCode</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c"># The close reason the peer sent me in close frame (if any)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">remoteCloseReason</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c"># timers, which might get set up later, and remembered here to get canceled</span>
      <span class="c"># when appropriate</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">serverConnectionDropTimeoutCall</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeoutCall</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeoutCall</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c"># set opening handshake timeout handler</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeoutCall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_callLater</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onOpenHandshakeTimeout</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      This is called by network framework when a transport connection was lost.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">## cancel any server connection drop timer if present</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverConnectionDropTimeoutCall</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;serverConnectionDropTimeoutCall.cancel&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">serverConnectionDropTimeoutCall</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">serverConnectionDropTimeoutCall</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSED</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wasClean</span><span class="p">:</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">droppedByMe</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wasNotCleanReason</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wasNotCleanReason</span> <span class="o">=</span> <span class="s">&quot;peer dropped the TCP connection without previous WebSocket closing handshake&quot;</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_onClose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wasClean</span><span class="p">,</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CLOSE_STATUS_CODE_ABNORMAL_CLOSE</span><span class="p">,</span> <span class="s">&quot;connection was closed uncleanly (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">wasNotCleanReason</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_onClose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wasClean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteCloseCode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteCloseReason</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">logRxOctets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Hook fired right after raw octets have been received, but only when self.logOctets == True.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;RX Octets from </span><span class="si">%s</span><span class="s"> : octets = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>


   <span class="k">def</span> <span class="nf">logTxOctets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sync</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Hook fired right after raw octets have been sent, but only when self.logOctets == True.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;TX Octets to </span><span class="si">%s</span><span class="s"> : sync = </span><span class="si">%s</span><span class="s">, octets = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">sync</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>


   <span class="k">def</span> <span class="nf">logRxFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameHeader</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Hook fired right after WebSocket frame has been received and decoded, but only when self.logFrames == True.</span>

<span class="sd">      Modes: Hybi</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
      <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span>
              <span class="n">frameHeader</span><span class="o">.</span><span class="n">fin</span><span class="p">,</span>
              <span class="n">frameHeader</span><span class="o">.</span><span class="n">rsv</span><span class="p">,</span>
              <span class="n">frameHeader</span><span class="o">.</span><span class="n">opcode</span><span class="p">,</span>
              <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">frameHeader</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">frameHeader</span><span class="o">.</span><span class="n">mask</span> <span class="k">else</span> <span class="s">&quot;-&quot;</span><span class="p">,</span>
              <span class="n">frameHeader</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
              <span class="n">data</span> <span class="k">if</span> <span class="n">frameHeader</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;RX Frame from </span><span class="si">%s</span><span class="s"> : fin = </span><span class="si">%s</span><span class="s">, rsv = </span><span class="si">%s</span><span class="s">, opcode = </span><span class="si">%s</span><span class="s">, mask = </span><span class="si">%s</span><span class="s">, length = </span><span class="si">%s</span><span class="s">, payload = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">info</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">logTxFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameHeader</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">repeatLength</span><span class="p">,</span> <span class="n">chopsize</span><span class="p">,</span> <span class="n">sync</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Hook fired right after WebSocket frame has been encoded and sent, but only when self.logFrames == True.</span>

<span class="sd">      Modes: Hybi</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span>
              <span class="n">frameHeader</span><span class="o">.</span><span class="n">fin</span><span class="p">,</span>
              <span class="n">frameHeader</span><span class="o">.</span><span class="n">rsv</span><span class="p">,</span>
              <span class="n">frameHeader</span><span class="o">.</span><span class="n">opcode</span><span class="p">,</span>
              <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">frameHeader</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">frameHeader</span><span class="o">.</span><span class="n">mask</span> <span class="k">else</span> <span class="s">&quot;-&quot;</span><span class="p">,</span>
              <span class="n">frameHeader</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
              <span class="n">repeatLength</span><span class="p">,</span>
              <span class="n">chopsize</span><span class="p">,</span>
              <span class="n">sync</span><span class="p">,</span>
              <span class="n">payload</span> <span class="k">if</span> <span class="n">frameHeader</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;TX Frame to </span><span class="si">%s</span><span class="s"> : fin = </span><span class="si">%s</span><span class="s">, rsv = </span><span class="si">%s</span><span class="s">, opcode = </span><span class="si">%s</span><span class="s">, mask = </span><span class="si">%s</span><span class="s">, length = </span><span class="si">%s</span><span class="s">, repeat_length = </span><span class="si">%s</span><span class="s">, chopsize = </span><span class="si">%s</span><span class="s">, sync = </span><span class="si">%s</span><span class="s">, payload = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">info</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      This is called by network framework upon receiving data on transport connection.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">incomingOctetsWireLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CONNECTING</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_PROXY_CONNECTING</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">preopenIncomingOctetsWireLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logOctets</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">logRxOctets</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">data</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">consumeData</span><span class="p">()</span>


   <span class="k">def</span> <span class="nf">consumeData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Consume buffered (incoming) data.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="c">## WebSocket is open (handshake was completed) or close was sent</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSING</span><span class="p">:</span>

         <span class="c">## process until no more buffered data left or WS was closed</span>
         <span class="c">##</span>
         <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">processData</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSED</span><span class="p">:</span>
            <span class="k">pass</span>

      <span class="c">## need to establish proxy connection</span>
      <span class="c">##</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_PROXY_CONNECTING</span><span class="p">:</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">processProxyConnect</span><span class="p">()</span>

      <span class="c">## WebSocket needs handshake</span>
      <span class="c">##</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CONNECTING</span><span class="p">:</span>

         <span class="c">## the implementation of processHandshake() in derived</span>
         <span class="c">## class needs to perform client or server handshake</span>
         <span class="c">## from other party here ..</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">processHandshake</span><span class="p">()</span>

      <span class="c">## we failed the connection .. don&#39;t process any more data!</span>
      <span class="c">##</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSED</span><span class="p">:</span>

         <span class="c">## ignore any data received after WS was closed</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;received data in STATE_CLOSED&quot;</span><span class="p">)</span>

      <span class="c">## should not arrive here (invalid state)</span>
      <span class="c">##</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid state&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">processProxyConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Process proxy connect.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;must implement proxy connect (client or server) in derived class&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">processHandshake</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Process WebSocket handshake.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;must implement handshake (client or server) in derived class&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Trigger sending stuff from send queue (which is only used for chopped/synched writes).</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">triggered</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">()</span>


   <span class="k">def</span> <span class="nf">_send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Send out stuff from send queue. For details how this works, see test/trickling</span>
<span class="sd">      in the repo.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSED</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingOctetsWireLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CONNECTING</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_PROXY_CONNECTING</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">preopenOutgoingOctetsWireLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logOctets</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">logTxOctets</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;skipped delayed write, since connection is closed&quot;</span><span class="p">)</span>
         <span class="c"># we need to reenter the reactor to make the latter</span>
         <span class="c"># reenter the OS network stack, so that octets</span>
         <span class="c"># can get on the wire. Note: this is a &quot;heuristic&quot;,</span>
         <span class="c"># since there is no (easy) way to really force out</span>
         <span class="c"># octets from the OS network stack to wire.</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_callLater</span><span class="p">(</span><span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">_QUEUED_WRITE_DELAY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">triggered</span> <span class="o">=</span> <span class="bp">False</span>


   <span class="k">def</span> <span class="nf">sendData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">chopsize</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Wrapper for self.transport.write which allows to give a chopsize.</span>
<span class="sd">      When asked to chop up writing to TCP stream, we write only chopsize octets</span>
<span class="sd">      and then give up control to select() in underlying reactor so that bytes</span>
<span class="sd">      get onto wire immediately. Note that this is different from and unrelated</span>
<span class="sd">      to WebSocket data message fragmentation. Note that this is also different</span>
<span class="sd">      from the TcpNoDelay option which can be set on the socket.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">chopsize</span> <span class="ow">and</span> <span class="n">chopsize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
         <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chopsize</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
               <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
               <span class="n">j</span> <span class="o">=</span> <span class="n">n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="bp">True</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">chopsize</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_trigger</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">sync</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">sync</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trigger</span><span class="p">()</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingOctetsWireLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CONNECTING</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_PROXY_CONNECTING</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">preopenOutgoingOctetsWireLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logOctets</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">logTxOctets</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>


<div class="viewcode-block" id="WebSocketProtocol.sendPreparedMessage"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.sendPreparedMessage">[docs]</a>   <span class="k">def</span> <span class="nf">sendPreparedMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preparedMsg</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.sendPreparedMessage`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">preparedMsg</span><span class="o">.</span><span class="n">doNotCompress</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">preparedMsg</span><span class="o">.</span><span class="n">payloadHybi</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">preparedMsg</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">preparedMsg</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">preparedMsg</span><span class="o">.</span><span class="n">payloadHixie</span><span class="p">)</span>

</div>
   <span class="k">def</span> <span class="nf">processData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      After WebSocket handshake has been completed, this procedure will do all</span>
<span class="sd">      subsequent processing of incoming bytes.</span>

<span class="sd">      Modes: Hybi, Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processDataHixie76</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processDataHybi</span><span class="p">()</span>


   <span class="k">def</span> <span class="nf">processDataHixie76</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Hixie-76 incoming data processing.</span>

<span class="sd">      Modes: Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">buffered_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

      <span class="c">## outside a message, that is we are awaiting data which starts a new message</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_message</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">buffered_len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>

            <span class="c">## new message</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">:</span>

               <span class="bp">self</span><span class="o">.</span><span class="n">inside_message</span> <span class="o">=</span> <span class="bp">True</span>

               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncoming</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">utf8validator</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncomingCurrentMessage</span> <span class="o">=</span> <span class="bp">True</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateLast</span> <span class="o">=</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncomingCurrentMessage</span> <span class="o">=</span> <span class="bp">False</span>

               <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="s">&quot;onMessageBegin&quot;</span><span class="p">)</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_onMessageBegin</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

            <span class="c">## Hixie close from peer received</span>
            <span class="c">##</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\xff</span><span class="s">&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">onCloseFrame</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
               <span class="c"># stop receiving/processing after having received close!</span>
               <span class="k">return</span> <span class="bp">False</span>

            <span class="c">## malformed data</span>
            <span class="c">##</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;malformed data received&quot;</span><span class="p">):</span>
                  <span class="k">return</span> <span class="bp">False</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c">## need more data</span>
            <span class="k">return</span> <span class="bp">False</span>

      <span class="n">end_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xff</span><span class="s">&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">end_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">end_index</span><span class="p">]</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">end_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>

      <span class="c">## incrementally validate UTF-8 payload</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncomingCurrentMessage</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateLast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateLast</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalidPayload</span><span class="p">(</span><span class="s">&quot;encountered invalid UTF-8 while processing text message at payload octet index </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateLast</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
               <span class="k">return</span> <span class="bp">False</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_onMessageFrameData</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">end_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">inside_message</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_onMessageEnd</span><span class="p">()</span>

      <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>


   <span class="k">def</span> <span class="nf">processDataHybi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      RFC6455/Hybi-Drafts incoming data processing.</span>

<span class="sd">      Modes: Hybi</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">buffered_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

      <span class="c">## outside a frame, that is we are awaiting data which starts a new frame</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>

         <span class="c">## need minimum of 2 octets to for new frame</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="n">buffered_len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>

            <span class="c">## FIN, RSV, OPCODE</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
               <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">b</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">frame_fin</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="n">frame_rsv</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
            <span class="n">frame_opcode</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x0f</span>

            <span class="c">## MASK, PAYLOAD LEN 1</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
               <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">b</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">frame_masked</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="n">frame_payload_len1</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>

            <span class="c">## MUST be 0 when no extension defining</span>
            <span class="c">## the semantics of RSV has been negotiated</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="n">frame_rsv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">frame_rsv</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                  <span class="k">pass</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;RSV = </span><span class="si">%d</span><span class="s"> and no extension negotiated&quot;</span> <span class="o">%</span> <span class="n">frame_rsv</span><span class="p">):</span>
                     <span class="k">return</span> <span class="bp">False</span>

            <span class="c">## all client-to-server frames MUST be masked</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">requireMaskedClientFrames</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">frame_masked</span><span class="p">:</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;unmasked client-to-server frame&quot;</span><span class="p">):</span>
                  <span class="k">return</span> <span class="bp">False</span>

            <span class="c">## all server-to-client frames MUST NOT be masked</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptMaskedServerFrames</span> <span class="ow">and</span> <span class="n">frame_masked</span><span class="p">:</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;masked server-to-client frame&quot;</span><span class="p">):</span>
                  <span class="k">return</span> <span class="bp">False</span>

            <span class="c">## check frame</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="n">frame_opcode</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span> <span class="c"># control frame (have MSB in opcode set)</span>

               <span class="c">## control frames MUST NOT be fragmented</span>
               <span class="c">##</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="n">frame_fin</span><span class="p">:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;fragmented control frame&quot;</span><span class="p">):</span>
                     <span class="k">return</span> <span class="bp">False</span>

               <span class="c">## control frames MUST have payload 125 octets or less</span>
               <span class="c">##</span>
               <span class="k">if</span> <span class="n">frame_payload_len1</span> <span class="o">&gt;</span> <span class="mi">125</span><span class="p">:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;control frame with payload length &gt; 125 octets&quot;</span><span class="p">):</span>
                     <span class="k">return</span> <span class="bp">False</span>

               <span class="c">## check for reserved control frame opcodes</span>
               <span class="c">##</span>
               <span class="k">if</span> <span class="n">frame_opcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;control frame using reserved opcode </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">frame_opcode</span><span class="p">):</span>
                     <span class="k">return</span> <span class="bp">False</span>

               <span class="c">## close frame : if there is a body, the first two bytes of the body MUST be a 2-byte</span>
               <span class="c">## unsigned integer (in network byte order) representing a status code</span>
               <span class="c">##</span>
               <span class="k">if</span> <span class="n">frame_opcode</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">frame_payload_len1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;received close control frame with payload len 1&quot;</span><span class="p">):</span>
                     <span class="k">return</span> <span class="bp">False</span>

               <span class="c">## control frames MUST NOT be compressed</span>
               <span class="c">##</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">frame_rsv</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;received compressed control frame [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="o">.</span><span class="n">EXTENSION_NAME</span><span class="p">):</span>
                     <span class="k">return</span> <span class="bp">False</span>

            <span class="k">else</span><span class="p">:</span> <span class="c"># data frame</span>

               <span class="c">## check for reserved data frame opcodes</span>
               <span class="c">##</span>
               <span class="k">if</span> <span class="n">frame_opcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;data frame using reserved opcode </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">frame_opcode</span><span class="p">):</span>
                     <span class="k">return</span> <span class="bp">False</span>

               <span class="c">## check opcode vs message fragmentation state 1/2</span>
               <span class="c">##</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_message</span> <span class="ow">and</span> <span class="n">frame_opcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;received continuation data frame outside fragmented message&quot;</span><span class="p">):</span>
                     <span class="k">return</span> <span class="bp">False</span>

               <span class="c">## check opcode vs message fragmentation state 2/2</span>
               <span class="c">##</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_message</span> <span class="ow">and</span> <span class="n">frame_opcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;received non-continuation data frame while inside fragmented message&quot;</span><span class="p">):</span>
                     <span class="k">return</span> <span class="bp">False</span>

               <span class="c">## continuation data frames MUST NOT have the compressed bit set</span>
               <span class="c">##</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">frame_rsv</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_message</span><span class="p">:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;received continution data frame with compress bit set [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="o">.</span><span class="n">EXTENSION_NAME</span><span class="p">):</span>
                     <span class="k">return</span> <span class="bp">False</span>

            <span class="c">## compute complete header length</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="n">frame_masked</span><span class="p">:</span>
               <span class="n">mask_len</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">mask_len</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">frame_payload_len1</span> <span class="o">&lt;</span>  <span class="mi">126</span><span class="p">:</span>
               <span class="n">frame_header_len</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">mask_len</span>
            <span class="k">elif</span> <span class="n">frame_payload_len1</span> <span class="o">==</span> <span class="mi">126</span><span class="p">:</span>
               <span class="n">frame_header_len</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">mask_len</span>
            <span class="k">elif</span> <span class="n">frame_payload_len1</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
               <span class="n">frame_header_len</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">mask_len</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;logic error&quot;</span><span class="p">)</span>

            <span class="c">## only proceed when we have enough data buffered for complete</span>
            <span class="c">## frame header (which includes extended payload len + mask)</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="n">buffered_len</span> <span class="o">&gt;=</span> <span class="n">frame_header_len</span><span class="p">:</span>

               <span class="c">## minimum frame header length (already consumed)</span>
               <span class="c">##</span>
               <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>

               <span class="c">## extract extended payload length</span>
               <span class="c">##</span>
               <span class="k">if</span> <span class="n">frame_payload_len1</span> <span class="o">==</span> <span class="mi">126</span><span class="p">:</span>
                  <span class="n">frame_payload_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;!H&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                  <span class="k">if</span> <span class="n">frame_payload_len</span> <span class="o">&lt;</span> <span class="mi">126</span><span class="p">:</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;invalid data frame length (not using minimal length encoding)&quot;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="bp">False</span>
                  <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
               <span class="k">elif</span> <span class="n">frame_payload_len1</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
                  <span class="n">frame_payload_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;!Q&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                  <span class="k">if</span> <span class="n">frame_payload_len</span> <span class="o">&gt;</span> <span class="mh">0x7FFFFFFFFFFFFFFF</span><span class="p">:</span> <span class="c"># 2**63</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;invalid data frame length (&gt;2^63)&quot;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="bp">False</span>
                  <span class="k">if</span> <span class="n">frame_payload_len</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">:</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocolViolation</span><span class="p">(</span><span class="s">&quot;invalid data frame length (not using minimal length encoding)&quot;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="bp">False</span>
                  <span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="n">frame_payload_len</span> <span class="o">=</span> <span class="n">frame_payload_len1</span>

               <span class="c">## when payload is masked, extract frame mask</span>
               <span class="c">##</span>
               <span class="n">frame_mask</span> <span class="o">=</span> <span class="bp">None</span>
               <span class="k">if</span> <span class="n">frame_masked</span><span class="p">:</span>
                  <span class="n">frame_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
                  <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span>

               <span class="k">if</span> <span class="n">frame_masked</span> <span class="ow">and</span> <span class="n">frame_payload_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">current_frame_masker</span> <span class="o">=</span> <span class="n">createXorMasker</span><span class="p">(</span><span class="n">frame_mask</span><span class="p">,</span> <span class="n">frame_payload_len</span><span class="p">)</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">current_frame_masker</span> <span class="o">=</span> <span class="n">XorMaskerNull</span><span class="p">()</span>


               <span class="c">## remember rest (payload of current frame after header and everything thereafter)</span>
               <span class="c">##</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>

               <span class="c">## ok, got complete frame header</span>
               <span class="c">##</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">=</span> <span class="n">FrameHeader</span><span class="p">(</span><span class="n">frame_opcode</span><span class="p">,</span>
                                                <span class="n">frame_fin</span><span class="p">,</span>
                                                <span class="n">frame_rsv</span><span class="p">,</span>
                                                <span class="n">frame_payload_len</span><span class="p">,</span>
                                                <span class="n">frame_mask</span><span class="p">)</span>

               <span class="c">## process begin on new frame</span>
               <span class="c">##</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">onFrameBegin</span><span class="p">()</span>

               <span class="c">## reprocess when frame has no payload or and buffered data left</span>
               <span class="c">##</span>
               <span class="k">return</span> <span class="n">frame_payload_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">False</span> <span class="c"># need more data</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span> <span class="c"># need more data</span>

      <span class="c">## inside a started frame</span>
      <span class="c">##</span>
      <span class="k">else</span><span class="p">:</span>

         <span class="c">## cut out rest of frame payload</span>
         <span class="c">##</span>
         <span class="n">rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame_masker</span><span class="o">.</span><span class="n">pointer</span><span class="p">()</span>
         <span class="k">if</span> <span class="n">buffered_len</span> <span class="o">&gt;=</span> <span class="n">rest</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">rest</span><span class="p">]</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">rest</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">rest</span><span class="p">:]</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">buffered_len</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>

         <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">## unmask payload</span>
            <span class="c">##</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame_masker</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c">## we also process empty payloads, since we need to fire</span>
            <span class="c">## our hooks (at least for streaming processing, this is</span>
            <span class="c">## necessary for correct protocol state transitioning)</span>
            <span class="c">##</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>

         <span class="c">## process frame data</span>
         <span class="c">##</span>
         <span class="n">fr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onFrameData</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">fr</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

         <span class="c">## fire frame end handler when frame payload is complete</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame_masker</span><span class="o">.</span><span class="n">pointer</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
            <span class="n">fr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onFrameEnd</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fr</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">False</span>

         <span class="c">## reprocess when no error occurred and buffered data left</span>
         <span class="c">##</span>
         <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>


   <span class="k">def</span> <span class="nf">onFrameBegin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Begin of receive new frame.</span>

<span class="sd">      Modes: Hybi</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">opcode</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">control_frame_data</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c">## new message started</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_message</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">inside_message</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c">## setup decompressor</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">rsv</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_isMessageCompressed</span> <span class="o">=</span> <span class="bp">True</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="o">.</span><span class="n">startDecompressMessage</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_isMessageCompressed</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="c">## setup UTF8 validator</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPE_TEXT</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncoming</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">utf8validator</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncomingCurrentMessage</span> <span class="o">=</span> <span class="bp">True</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateLast</span> <span class="o">=</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncomingCurrentMessage</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="c">## track timings</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="s">&quot;onMessageBegin&quot;</span><span class="p">)</span>

            <span class="c">## fire onMessageBegin</span>
            <span class="c">##</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_onMessageBegin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPE_BINARY</span><span class="p">)</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">_onMessageFrameBegin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">onFrameData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      New data received within frame.</span>

<span class="sd">      Modes: Hybi</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">opcode</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">control_frame_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c">## decompress frame payload</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isMessageCompressed</span><span class="p">:</span>
            <span class="n">compressedLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;RX compressed [</span><span class="si">%d</span><span class="s">]: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">compressedLen</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="o">.</span><span class="n">decompressMessageData</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">uncompressedLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">compressedLen</span> <span class="o">=</span> <span class="n">l</span>
            <span class="n">uncompressedLen</span> <span class="o">=</span> <span class="n">l</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">incomingOctetsWebSocketLevel</span> <span class="o">+=</span> <span class="n">compressedLen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">incomingOctetsAppLevel</span> <span class="o">+=</span> <span class="n">uncompressedLen</span>

         <span class="c">## incrementally validate UTF-8 payload</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncomingCurrentMessage</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateLast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateLast</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalidPayload</span><span class="p">(</span><span class="s">&quot;encountered invalid UTF-8 while processing text message at payload octet index </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateLast</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                  <span class="k">return</span> <span class="bp">False</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">_onMessageFrameData</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">onFrameEnd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      End of frame received.</span>

<span class="sd">      Modes: Hybi</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">opcode</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logFrames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logRxFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_frame_data</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">processControlFrame</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">incomingWebSocketFrames</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logFrames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logRxFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_data</span><span class="p">)</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">_onMessageFrameEnd</span><span class="p">()</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">fin</span><span class="p">:</span>

            <span class="c">## handle end of compressed message</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isMessageCompressed</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="o">.</span><span class="n">endDecompressMessage</span><span class="p">()</span>

            <span class="c">## verify UTF8 has actually ended</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncomingCurrentMessage</span><span class="p">:</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateLast</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalidPayload</span><span class="p">(</span><span class="s">&quot;UTF-8 text message payload ended within Unicode code point at payload octet index </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateLast</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                     <span class="k">return</span> <span class="bp">False</span>

            <span class="c">#if self.debug:</span>
            <span class="c">#   self.factory._log(&quot;Traffic statistics:\n&quot; + str(self.trafficStats))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">incomingWebSocketMessages</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_onMessageEnd</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inside_message</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">=</span> <span class="bp">None</span>


   <span class="k">def</span> <span class="nf">processControlFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Process a completely received control frame.</span>

<span class="sd">      Modes: Hybi</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="n">payload</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_frame_data</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">control_frame_data</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c">## CLOSE frame</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>

         <span class="n">code</span> <span class="o">=</span> <span class="bp">None</span>
         <span class="n">reasonRaw</span> <span class="o">=</span> <span class="bp">None</span>
         <span class="n">ll</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">ll</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;!H&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ll</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
               <span class="n">reasonRaw</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onCloseFrame</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">reasonRaw</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

      <span class="c">## PING frame</span>
      <span class="c">##</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_onPing</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

      <span class="c">## PONG frame</span>
      <span class="c">##</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_onPong</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
         <span class="c">## we might arrive here, when protocolViolation</span>
         <span class="c">## wants us to continue anyway</span>
         <span class="k">pass</span>

      <span class="k">return</span> <span class="bp">True</span>


   <span class="k">def</span> <span class="nf">sendFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">opcode</span><span class="p">,</span>
                 <span class="n">payload</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">fin</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                 <span class="n">rsv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">mask</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">payload_len</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">chopsize</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">sync</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Send out frame. Normally only used internally via sendMessage(), sendPing(), sendPong() and sendClose().</span>

<span class="sd">      This method deliberately allows to send invalid frames (that is frames invalid</span>
<span class="sd">      per-se, or frames invalid because of protocol state). Other than in fuzzing servers,</span>
<span class="sd">      calling methods will ensure that no invalid frames are sent.</span>

<span class="sd">      In addition, this method supports explicit specification of payload length.</span>
<span class="sd">      When payload_len is given, it will always write that many octets to the stream.</span>
<span class="sd">      It&#39;ll wrap within payload, resending parts of that when more octets were requested</span>
<span class="sd">      The use case is again for fuzzing server which want to sent increasing amounts</span>
<span class="sd">      of payload data to peers without having to construct potentially large messges</span>
<span class="sd">      themselfes.</span>

<span class="sd">      Modes: Hybi</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;function not supported in Hixie-76 mode&quot;</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">payload_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;cannot construct repeated payload with length </span><span class="si">%d</span><span class="s"> from payload of length </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">payload_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
         <span class="n">l</span> <span class="o">=</span> <span class="n">payload_len</span>
         <span class="n">pl</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">payload</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">payload_len</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))])</span> <span class="o">+</span> <span class="n">payload</span><span class="p">[:</span><span class="n">payload_len</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)]</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="n">pl</span> <span class="o">=</span> <span class="n">payload</span>

      <span class="c">## first byte</span>
      <span class="c">##</span>
      <span class="n">b0</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">fin</span><span class="p">:</span>
         <span class="n">b0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>
      <span class="n">b0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rsv</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
      <span class="n">b0</span> <span class="o">|=</span> <span class="n">opcode</span> <span class="o">%</span> <span class="mi">128</span>

      <span class="c">## second byte, payload len bytes and mask</span>
      <span class="c">##</span>
      <span class="n">b1</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">mask</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">maskClientFrames</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">maskServerFrames</span><span class="p">):</span>
         <span class="n">b1</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!I&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
            <span class="n">mv</span> <span class="o">=</span> <span class="n">mask</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">mv</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>

         <span class="c">## mask frame payload</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span><span class="p">:</span>
            <span class="n">masker</span> <span class="o">=</span> <span class="n">createXorMasker</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
            <span class="n">plm</span> <span class="o">=</span> <span class="n">masker</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">plm</span> <span class="o">=</span> <span class="n">pl</span>

      <span class="k">else</span><span class="p">:</span>
         <span class="n">mv</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
         <span class="n">plm</span> <span class="o">=</span> <span class="n">pl</span>

      <span class="n">el</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
      <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="mi">125</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">|=</span> <span class="n">l</span>
      <span class="k">elif</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="mh">0xFFFF</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">|=</span> <span class="mi">126</span>
         <span class="n">el</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!H&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="mh">0x7FFFFFFFFFFFFFFF</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">|=</span> <span class="mi">127</span>
         <span class="n">el</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!Q&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid payload length&quot;</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
         <span class="n">raw</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">b0</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;big&#39;</span><span class="p">),</span> <span class="n">b1</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;big&#39;</span><span class="p">),</span> <span class="n">el</span><span class="p">,</span> <span class="n">mv</span><span class="p">,</span> <span class="n">plm</span><span class="p">])</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">raw</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">b0</span><span class="p">),</span> <span class="nb">chr</span><span class="p">(</span><span class="n">b1</span><span class="p">),</span> <span class="n">el</span><span class="p">,</span> <span class="n">mv</span><span class="p">,</span> <span class="n">plm</span><span class="p">])</span>

      <span class="k">if</span> <span class="n">opcode</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingWebSocketFrames</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logFrames</span><span class="p">:</span>
         <span class="n">frameHeader</span> <span class="o">=</span> <span class="n">FrameHeader</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">fin</span><span class="p">,</span> <span class="n">rsv</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">logTxFrame</span><span class="p">(</span><span class="n">frameHeader</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">chopsize</span><span class="p">,</span> <span class="n">sync</span><span class="p">)</span>

      <span class="c">## send frame octets</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">sync</span><span class="p">,</span> <span class="n">chopsize</span><span class="p">)</span>


<div class="viewcode-block" id="WebSocketProtocol.sendPing"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.sendPing">[docs]</a>   <span class="k">def</span> <span class="nf">sendPing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.sendPing`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;function not supported in Hixie-76 mode&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="k">return</span>
      <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
         <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">125</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid payload for PING (payload length must be &lt;= 125, was </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">l</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendFrame</span><span class="p">(</span><span class="n">opcode</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendFrame</span><span class="p">(</span><span class="n">opcode</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.sendPong"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.sendPong">[docs]</a>   <span class="k">def</span> <span class="nf">sendPong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.sendPong`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;function not supported in Hixie-76 mode&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="k">return</span>
      <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
         <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">125</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid payload for PONG (payload length must be &lt;= 125, was </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">l</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendFrame</span><span class="p">(</span><span class="n">opcode</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendFrame</span><span class="p">(</span><span class="n">opcode</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>

</div>
   <span class="k">def</span> <span class="nf">sendCloseFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">reasonUtf8</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">isReply</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Send a close frame and update protocol state. Note, that this is</span>
<span class="sd">      an internal method which deliberately allows not send close</span>
<span class="sd">      frame with invalid payload.</span>

<span class="sd">      Modes: Hybi, Hixie</span>

<span class="sd">      Notes:</span>
<span class="sd">        - For Hixie mode, this method is slightly misnamed for historic reasons.</span>
<span class="sd">        - For Hixie mode, code and reasonUtf8 will be silently ignored.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSING</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;ignoring sendCloseFrame since connection is closing&quot;</span><span class="p">)</span>

      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSED</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;ignoring sendCloseFrame since connection already closed&quot;</span><span class="p">)</span>

      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_PROXY_CONNECTING</span><span class="p">,</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CONNECTING</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;cannot close a connection not yet connected&quot;</span><span class="p">)</span>

      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\xff\x00</span><span class="s">&quot;</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c">## construct Hybi close frame payload and send frame</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
               <span class="n">payload</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!H&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reasonUtf8</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
               <span class="n">payload</span> <span class="o">+=</span> <span class="n">reasonUtf8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendFrame</span><span class="p">(</span><span class="n">opcode</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">)</span>

         <span class="c">## update state</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CLOSING</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">closedByMe</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">isReply</span>

         <span class="c">## remember payload of close frame we sent</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">localCloseCode</span> <span class="o">=</span> <span class="n">code</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">localCloseReason</span> <span class="o">=</span> <span class="n">reasonUtf8</span>

         <span class="c">## drop connection when timeout on receiving close handshake reply</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closedByMe</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeoutCall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_callLater</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onCloseHandshakeTimeout</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;logic error&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="WebSocketProtocol.sendClose"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.sendClose">[docs]</a>   <span class="k">def</span> <span class="nf">sendClose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.sendClose`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type </span><span class="si">%s</span><span class="s"> for close code&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
         <span class="k">if</span> <span class="n">code</span> <span class="o">!=</span> <span class="mi">1000</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">code</span> <span class="o">&gt;=</span> <span class="mi">3000</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="mi">4999</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid close code </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;close reason without close code&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type </span><span class="si">%s</span><span class="s"> for close reason&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">]:</span>
               <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type </span><span class="si">%s</span><span class="s"> for close reason&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span>
         <span class="n">reasonUtf8</span> <span class="o">=</span> <span class="n">reason</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reasonUtf8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">125</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;close reason too long (</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">reasonUtf8</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">reasonUtf8</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendCloseFrame</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">,</span> <span class="n">reasonUtf8</span> <span class="o">=</span> <span class="n">reasonUtf8</span><span class="p">,</span> <span class="n">isReply</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.beginMessage"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.beginMessage">[docs]</a>   <span class="k">def</span> <span class="nf">beginMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isBinary</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">doNotCompress</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.beginMessage`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="k">return</span>

      <span class="c">## check if sending state is valid for this method</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_GROUND</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;WebSocketProtocol.beginMessage invalid in current sending state&quot;</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">isBinary</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;cannot send binary message in Hixie76 mode&quot;</span><span class="p">)</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_INSIDE_MESSAGE</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">send_message_opcode</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPE_BINARY</span> <span class="k">if</span> <span class="n">isBinary</span> <span class="k">else</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">MESSAGE_TYPE_TEXT</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_MESSAGE_BEGIN</span>

         <span class="c">## setup compressor</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">doNotCompress</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_compressed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="o">.</span><span class="n">startCompressMessage</span><span class="p">()</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_compressed</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingWebSocketMessages</span> <span class="o">+=</span> <span class="mi">1</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.beginMessageFrame"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.beginMessageFrame">[docs]</a>   <span class="k">def</span> <span class="nf">beginMessageFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.beginMessageFrame`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;function not supported in Hixie-76 mode&quot;</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="k">return</span>

      <span class="c">## check if sending state is valid for this method</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_MESSAGE_BEGIN</span><span class="p">,</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_INSIDE_MESSAGE</span><span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;WebSocketProtocol.beginMessageFrame invalid in current sending state [</span><span class="si">%d</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mh">0x7FFFFFFFFFFFFFFF</span><span class="p">:</span> <span class="c"># 2**63</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid value for message frame length&quot;</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_length</span> <span class="o">=</span> <span class="n">length</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingWebSocketFrames</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">maskClientFrames</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">maskServerFrames</span><span class="p">):</span>
         <span class="c">## automatic mask:</span>
         <span class="c">##  - client-to-server masking (if not deactivated)</span>
         <span class="c">##  - server-to-client masking (if activated)</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_mask</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!I&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>

      <span class="k">else</span><span class="p">:</span>
         <span class="c">## no mask</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_mask</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c">## payload masker</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_mask</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_masker</span> <span class="o">=</span> <span class="n">createXorMasker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_mask</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_masker</span> <span class="o">=</span> <span class="n">XorMaskerNull</span><span class="p">()</span>

      <span class="c">## first byte</span>
      <span class="c">##</span>
      <span class="c"># FIN = false .. since with streaming, we don&#39;t know when message ends</span>
      <span class="n">b0</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="o">==</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_MESSAGE_BEGIN</span><span class="p">:</span>

         <span class="n">b0</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_opcode</span> <span class="o">%</span> <span class="mi">128</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_compressed</span><span class="p">:</span>
            <span class="n">b0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_INSIDE_MESSAGE</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">pass</span> <span class="c"># message continuation frame</span>

      <span class="c">## second byte, payload len bytes and mask</span>
      <span class="c">##</span>
      <span class="n">b1</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_mask</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
         <span class="n">mv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_mask</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">mv</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>

      <span class="n">el</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
      <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">125</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">|=</span> <span class="n">length</span>
      <span class="k">elif</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mh">0xFFFF</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">|=</span> <span class="mi">126</span>
         <span class="n">el</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!H&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mh">0x7FFFFFFFFFFFFFFF</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">|=</span> <span class="mi">127</span>
         <span class="n">el</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!Q&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid payload length&quot;</span><span class="p">)</span>

      <span class="c">## write message frame header</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
         <span class="n">header</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">b0</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;big&#39;</span><span class="p">),</span> <span class="n">b1</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;big&#39;</span><span class="p">),</span> <span class="n">el</span><span class="p">,</span> <span class="n">mv</span><span class="p">])</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">header</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">b0</span><span class="p">),</span> <span class="nb">chr</span><span class="p">(</span><span class="n">b1</span><span class="p">),</span> <span class="n">el</span><span class="p">,</span> <span class="n">mv</span><span class="p">])</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

      <span class="c">## now we are inside message frame ..</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_INSIDE_MESSAGE_FRAME</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.sendMessageFrameData"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.sendMessageFrameData">[docs]</a>   <span class="k">def</span> <span class="nf">sendMessageFrameData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.sendMessageFrameData`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="k">return</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_compressed</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingOctetsAppLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingOctetsWebSocketLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="c">## Hixie Mode</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_INSIDE_MESSAGE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;WebSocketProtocol.sendMessageFrameData invalid in current sending state&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="n">sync</span><span class="p">)</span>
         <span class="k">return</span> <span class="bp">None</span>

      <span class="k">else</span><span class="p">:</span>
         <span class="c">## Hybi Mode</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_INSIDE_MESSAGE_FRAME</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;WebSocketProtocol.sendMessageFrameData invalid in current sending state&quot;</span><span class="p">)</span>

         <span class="n">rl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_masker</span><span class="o">.</span><span class="n">pointer</span><span class="p">()</span> <span class="o">+</span> <span class="n">rl</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_length</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_masker</span><span class="o">.</span><span class="n">pointer</span><span class="p">()</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">rl</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="n">l</span><span class="p">]</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">rl</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_masker</span><span class="o">.</span><span class="n">pointer</span><span class="p">()</span> <span class="o">-</span> <span class="n">l</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="n">payload</span>

         <span class="c">## mask frame payload</span>
         <span class="c">##</span>
         <span class="n">plm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_masker</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span>

         <span class="c">## send frame payload</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">plm</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="n">sync</span><span class="p">)</span>

         <span class="c">## if we are done with frame, move back into &quot;inside message&quot; state</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_masker</span><span class="o">.</span><span class="n">pointer</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_message_frame_length</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_INSIDE_MESSAGE</span>

         <span class="c">## when =0 : frame was completed exactly</span>
         <span class="c">## when &gt;0 : frame is still uncomplete and that much amount is still left to complete the frame</span>
         <span class="c">## when &lt;0 : frame was completed and there was this much unconsumed data in payload argument</span>
         <span class="c">##</span>
         <span class="k">return</span> <span class="n">rest</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.endMessage"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.endMessage">[docs]</a>   <span class="k">def</span> <span class="nf">endMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.endMessage`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="k">return</span>

      <span class="c">## check if sending state is valid for this method</span>
      <span class="c">##</span>
      <span class="c">#if self.send_state != WebSocketProtocol.SEND_STATE_INSIDE_MESSAGE:</span>
      <span class="c">#   raise Exception(&quot;WebSocketProtocol.endMessage invalid in current sending state [%d]&quot; % self.send_state)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_compressed</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="o">.</span><span class="n">endCompressMessage</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingOctetsWebSocketLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c">## send continuation frame with empty payload and FIN set to end message</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendFrame</span><span class="p">(</span><span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">,</span> <span class="n">fin</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">send_state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SEND_STATE_GROUND</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.sendMessageFrame"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.sendMessageFrame">[docs]</a>   <span class="k">def</span> <span class="nf">sendMessageFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.sendMessageFrame`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;function not supported in Hixie-76 mode&quot;</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="k">return</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_compressed</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingOctetsAppLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="o">.</span><span class="n">compressMessageData</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">beginMessageFrame</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendMessageFrameData</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">sync</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebSocketProtocol.sendMessage"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketProtocol.sendMessage">[docs]</a>   <span class="k">def</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">payload</span><span class="p">,</span>
                   <span class="n">isBinary</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="n">fragmentSize</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                   <span class="n">sync</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="n">doNotCompress</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implements :func:`autobahn.websocket.interfaces.IWebSocketChannel.sendMessage`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">assert</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bytes</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span><span class="p">:</span>
         <span class="k">return</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="s">&quot;sendMessage&quot;</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">isBinary</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;cannot send binary message in Hixie76 mode&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">fragmentSize</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;cannot fragment messages in Hixie76 mode&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendMessageHixie76</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">sync</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendMessageHybi</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">isBinary</span><span class="p">,</span> <span class="n">fragmentSize</span><span class="p">,</span> <span class="n">sync</span><span class="p">,</span> <span class="n">doNotCompress</span><span class="p">)</span>

</div>
   <span class="k">def</span> <span class="nf">sendMessageHixie76</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Hixie76-Variant of sendMessage().</span>

<span class="sd">      Modes: Hixie</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\xff</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="n">sync</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">sendMessageHybi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">payload</span><span class="p">,</span>
                       <span class="n">isBinary</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                       <span class="n">fragmentSize</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                       <span class="n">sync</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                       <span class="n">doNotCompress</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Hybi-Variant of sendMessage().</span>

<span class="sd">      Modes: Hybi</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">## (initial) frame opcode</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">isBinary</span><span class="p">:</span>
         <span class="n">opcode</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">opcode</span> <span class="o">=</span> <span class="mi">1</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingWebSocketMessages</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="c">## setup compressor</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">doNotCompress</span><span class="p">:</span>
         <span class="n">sendCompressed</span> <span class="o">=</span> <span class="bp">True</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="o">.</span><span class="n">startCompressMessage</span><span class="p">()</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingOctetsAppLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

         <span class="n">payload1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="o">.</span><span class="n">compressMessageData</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="n">payload2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="o">.</span><span class="n">endCompressMessage</span><span class="p">()</span>
         <span class="n">payload</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">payload1</span><span class="p">,</span> <span class="n">payload2</span><span class="p">])</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingOctetsWebSocketLevel</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
         <span class="n">sendCompressed</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingOctetsAppLevel</span> <span class="o">+=</span> <span class="n">l</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">trafficStats</span><span class="o">.</span><span class="n">outgoingOctetsWebSocketLevel</span> <span class="o">+=</span> <span class="n">l</span>

      <span class="c">## explicit fragmentSize arguments overrides autoFragmentSize setting</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">fragmentSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">pfs</span> <span class="o">=</span> <span class="n">fragmentSize</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoFragmentSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoFragmentSize</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">pfs</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c">## send unfragmented</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">pfs</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pfs</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendFrame</span><span class="p">(</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="n">sync</span><span class="p">,</span> <span class="n">rsv</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="n">sendCompressed</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

      <span class="c">## send data message in fragments</span>
      <span class="c">##</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">pfs</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;payload fragment size must be at least 1 (was </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">pfs</span><span class="p">)</span>
         <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
         <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="n">first</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">pfs</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
               <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
               <span class="n">j</span> <span class="o">=</span> <span class="n">n</span>
            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">sendFrame</span><span class="p">(</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="n">fin</span> <span class="o">=</span> <span class="n">done</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="n">sync</span><span class="p">,</span> <span class="n">rsv</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="n">sendCompressed</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
               <span class="n">first</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">sendFrame</span><span class="p">(</span><span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="n">fin</span> <span class="o">=</span> <span class="n">done</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="n">sync</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">pfs</span>

      <span class="c">#if self.debug:</span>
      <span class="c">#   self.factory._log(&quot;Traffic statistics:\n&quot; + str(self.trafficStats))</span>


   <span class="k">def</span> <span class="nf">_parseExtensionsHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">removeQuotes</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Parse the Sec-WebSocket-Extensions header.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">extensions</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">exts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
      <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exts</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">e</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;;&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
               <span class="n">extension</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
               <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
               <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                  <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)]</span>
                  <span class="n">key</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                     <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;=&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                     <span class="k">if</span> <span class="n">removeQuotes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span>
                           <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span>
                           <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                  <span class="k">else</span><span class="p">:</span>
                     <span class="n">value</span> <span class="o">=</span> <span class="bp">True</span>
                  <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                     <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                  <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
               <span class="n">extensions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">extension</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">pass</span> <span class="c"># should not arrive here</span>
      <span class="k">return</span> <span class="n">extensions</span>


</div>
<div class="viewcode-block" id="PreparedMessage"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.PreparedMessage">[docs]</a><span class="k">class</span> <span class="nc">PreparedMessage</span><span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Encapsulates a prepared message to be sent later once or multiple</span>
<span class="sd">   times on one or more WebSocket connections.</span>
<span class="sd">   This can be used for optimizing Broadcast/PubSub.</span>
<span class="sd">   &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PreparedMessage.__init__"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.PreparedMessage.__init__">[docs]</a>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">isBinary</span><span class="p">,</span> <span class="n">applyMask</span><span class="p">,</span> <span class="n">doNotCompress</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Ctor for a prepared message.</span>

<span class="sd">      :param payload: The message payload.</span>
<span class="sd">      :type payload: str</span>
<span class="sd">      :param isBinary: Provide `True` for binary payload.</span>
<span class="sd">      :type isBinary: bool</span>
<span class="sd">      :param applyMask: Provide `True` if WebSocket message is to be masked (required for client to server WebSocket messages).</span>
<span class="sd">      :type applyMask: bool</span>
<span class="sd">      :param doNotCompress: Iff `True`, never compress this message. This only applies to</span>
<span class="sd">                            Hybi-Mode and only when WebSocket compression has been negotiated on</span>
<span class="sd">                            the WebSocket connection. Use when you know the payload</span>
<span class="sd">                            uncompressible (e.g. encrypted or already compressed).</span>
<span class="sd">      :type doNotCompress: bool</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">doNotCompress</span><span class="p">:</span>
         <span class="c">## we need to store original payload for compressed WS</span>
         <span class="c">## connections (cannot compress/frame in advanced when</span>
         <span class="c">## compression is on, and context takeover is off)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">isBinary</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">doNotCompress</span> <span class="o">=</span> <span class="n">doNotCompress</span>

      <span class="c">## store pre-framed octets to be sent to Hixie-76 peers</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_initHixie</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">isBinary</span><span class="p">)</span>

      <span class="c">## store pre-framed octets to be sent to Hybi peers</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_initHybi</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">isBinary</span><span class="p">,</span> <span class="n">applyMask</span><span class="p">)</span>

</div>
   <span class="k">def</span> <span class="nf">_initHixie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">binary</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
         <span class="c"># silently filter out .. probably do something else:</span>
         <span class="c"># base64?</span>
         <span class="c"># dunno</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">payloadHixie</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">payloadHixie</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\xff</span><span class="s">&#39;</span>


   <span class="k">def</span> <span class="nf">_initHybi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">masked</span><span class="p">):</span>
      <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

      <span class="c">## first byte</span>
      <span class="c">##</span>
      <span class="n">b0</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">binary</span> <span class="k">else</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span>

      <span class="c">## second byte, payload len bytes and mask</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">masked</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
         <span class="n">mask</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!I&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
         <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plm</span> <span class="o">=</span> <span class="n">payload</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">plm</span> <span class="o">=</span> <span class="n">createXorMasker</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">mask</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
         <span class="n">plm</span> <span class="o">=</span> <span class="n">payload</span>

      <span class="c">## payload extended length</span>
      <span class="c">##</span>
      <span class="n">el</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
      <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="mi">125</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">|=</span> <span class="n">l</span>
      <span class="k">elif</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="mh">0xFFFF</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">|=</span> <span class="mi">126</span>
         <span class="n">el</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!H&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="mh">0x7FFFFFFFFFFFFFFF</span><span class="p">:</span>
         <span class="n">b1</span> <span class="o">|=</span> <span class="mi">127</span>
         <span class="n">el</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!Q&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid payload length&quot;</span><span class="p">)</span>

      <span class="c">## raw WS message (single frame)</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">payloadHybi</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">b0</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;big&#39;</span><span class="p">),</span> <span class="n">b1</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;big&#39;</span><span class="p">),</span> <span class="n">el</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">plm</span><span class="p">])</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">payloadHybi</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">b0</span><span class="p">),</span> <span class="nb">chr</span><span class="p">(</span><span class="n">b1</span><span class="p">),</span> <span class="n">el</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">plm</span><span class="p">])</span>


</div>
<div class="viewcode-block" id="WebSocketFactory"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketFactory">[docs]</a><span class="k">class</span> <span class="nc">WebSocketFactory</span><span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Mixin for</span>
<span class="sd">   :class:`autobahn.websocket.protocol.WebSocketClientFactory` and</span>
<span class="sd">   :class:`autobahn.websocket.protocol.WebSocketServerFactory`.</span>
<span class="sd">   &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WebSocketFactory.prepareMessage"><a class="viewcode-back" href="../../../websocketbase.html#autobahn.websocket.protocol.WebSocketFactory.prepareMessage">[docs]</a>   <span class="k">def</span> <span class="nf">prepareMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">isBinary</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">doNotCompress</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Prepare a WebSocket message. This can be later sent on multiple</span>
<span class="sd">      instances of :class:`autobahn.websocket.WebSocketProtocol` using</span>
<span class="sd">      :meth:`autobahn.websocket.WebSocketProtocol.sendPreparedMessage`.</span>

<span class="sd">      By doing so, you can avoid the (small) overhead of framing the</span>
<span class="sd">      *same* payload into WebSocket messages multiple times when that</span>
<span class="sd">      same payload is to be sent out on multiple connections.</span>

<span class="sd">      :param payload: The message payload.</span>
<span class="sd">      :type payload: bytes</span>
<span class="sd">      :param isBinary: `True` iff payload is binary, else the payload must be UTF-8 encoded text.</span>
<span class="sd">      :type isBinary: bool</span>
<span class="sd">      :param doNotCompress: Iff `True`, never compress this message. This only applies to</span>
<span class="sd">                            Hybi-Mode and only when WebSocket compression has been negotiated on</span>
<span class="sd">                            the WebSocket connection. Use when you know the payload</span>
<span class="sd">                            uncompressible (e.g. encrypted or already compressed).</span>
<span class="sd">      :type doNotCompress: bool</span>

<span class="sd">      :returns: obj -- An instance of :class:`autobahn.websocket.protocol.PreparedMessage`.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">applyMask</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isServer</span>
      <span class="k">return</span> <span class="n">PreparedMessage</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">isBinary</span><span class="p">,</span> <span class="n">applyMask</span><span class="p">,</span> <span class="n">doNotCompress</span><span class="p">)</span>


</div></div>
<div class="viewcode-block" id="WebSocketServerProtocol"><a class="viewcode-back" href="../../../websocketserver.html#autobahn.websocket.protocol.WebSocketServerProtocol">[docs]</a><span class="k">class</span> <span class="nc">WebSocketServerProtocol</span><span class="p">(</span><span class="n">WebSocketProtocol</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Protocol base class for WebSocket servers.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">CONFIG_ATTRS</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CONFIG_ATTRS_COMMON</span> <span class="o">+</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CONFIG_ATTRS_SERVER</span>


<div class="viewcode-block" id="WebSocketServerProtocol.onConnect"><a class="viewcode-back" href="../../../websocketserver.html#autobahn.websocket.protocol.WebSocketServerProtocol.onConnect">[docs]</a>   <span class="k">def</span> <span class="nf">onConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback fired during WebSocket opening handshake when new WebSocket client</span>
<span class="sd">      connection is about to be established.</span>

<span class="sd">      When you want to accept the connection, return the accepted protocol</span>
<span class="sd">      from list of WebSocket (sub)protocols provided by client or `None` to</span>
<span class="sd">      speak no specific one or when the client protocol list was empty.</span>

<span class="sd">      You may also return a pair of `(protocol, headers)` to send additional</span>
<span class="sd">      HTTP headers, with `headers` being a dictionary of key-values.</span>

<span class="sd">      Throw :class:`autobahn.websocket.http.HttpException` when you don&#39;t want</span>
<span class="sd">      to accept the WebSocket connection request.</span>

<span class="sd">      :param request: WebSocket connection request information.</span>
<span class="sd">      :type request: instance of :class:`autobahn.websocket.protocol.ConnectionRequest`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">None</span>

</div>
   <span class="k">def</span> <span class="nf">_connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Called by network framework when new transport connection from client was</span>
<span class="sd">      accepted. Default implementation will prepare for initial WebSocket opening</span>
<span class="sd">      handshake. When overriding in derived class, make sure to call this base class</span>
<span class="sd">      implementation *before* your code.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">_connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">countConnections</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;connection accepted from peer </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Called by network framework when established transport connection from client</span>
<span class="sd">      was lost. Default implementation will tear down all state properly.</span>
<span class="sd">      When overriding in derived class, make sure to call this base class</span>
<span class="sd">      implementation *after* your code.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">_connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">countConnections</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;connection from </span><span class="si">%s</span><span class="s"> lost&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">processProxyConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Autobahn isn&#39;t a proxy server&quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">parseHixie76Key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Parse Hixie76 opening handshake key provided by client.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="n">key</span><span class="p">))</span> <span class="o">/</span> <span class="n">key</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">processHandshake</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Process WebSocket opening handshake request from client.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">## only proceed when we have fully received the HTTP request line and all headers</span>
      <span class="c">##</span>
      <span class="n">end_of_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;</span><span class="se">\x0d\x0a\x0d\x0a</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">end_of_header</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">http_request_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;received HTTP request:</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_request_data</span><span class="p">)</span>

         <span class="c">## extract HTTP status line and headers</span>
         <span class="c">##</span>
         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_status_line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">,</span> <span class="n">http_headers_cnt</span><span class="p">)</span> <span class="o">=</span> <span class="n">parseHttpHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_request_data</span><span class="p">)</span>

         <span class="c">## validate WebSocket opening handshake client request</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;received HTTP status line in opening handshake : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_status_line</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;received HTTP headers in opening handshake : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">))</span>

         <span class="c">## HTTP Request line : METHOD, VERSION</span>
         <span class="c">##</span>
         <span class="n">rl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_status_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;Bad HTTP request status line &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_status_line</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">rl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&quot;GET&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP method &#39;</span><span class="si">%s</span><span class="s">&#39; not allowed&quot;</span> <span class="o">%</span> <span class="n">rl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">http</span><span class="o">.</span><span class="n">METHOD_NOT_ALLOWED</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
         <span class="n">vs</span> <span class="o">=</span> <span class="n">rl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">vs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;HTTP&quot;</span> <span class="ow">or</span> <span class="n">vs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;1.1&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;Unsupported HTTP version &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">rl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">http</span><span class="o">.</span><span class="n">UNSUPPORTED_HTTP_VERSION</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

         <span class="c">## HTTP Request line : REQUEST-URI</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">http_request_uri</span> <span class="o">=</span> <span class="n">rl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span><span class="p">)</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_request_uri</span><span class="p">)</span>

            <span class="c">## FIXME: check that if absolute resource URI is given,</span>
            <span class="c">## the scheme/netloc matches the server</span>
            <span class="k">if</span> <span class="n">scheme</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="n">netloc</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
               <span class="k">pass</span>

            <span class="c">## Fragment identifiers are meaningless in the context of WebSocket</span>
            <span class="c">## URIs, and MUST NOT be used on these URIs.</span>
            <span class="k">if</span> <span class="n">fragment</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP requested resource contains a fragment identifier &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">fragment</span><span class="p">)</span>

            <span class="c">## resource path and query parameters .. this will get forwarded</span>
            <span class="c">## to onConnect()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">http_request_path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">http_request_params</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
         <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;Bad HTTP request resource - could not parse &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">rl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

         <span class="c">## Host</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;host&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Host header missing in opening handshake request&quot;</span><span class="p">)</span>

         <span class="k">if</span> <span class="n">http_headers_cnt</span><span class="p">[</span><span class="s">&quot;host&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Host header appears more than once in opening handshake request&quot;</span><span class="p">)</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">http_request_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;host&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_request_host</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_request_host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
               <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
            <span class="k">except</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;invalid port &#39;</span><span class="si">%s</span><span class="s">&#39; in HTTP Host header &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_request_host</span><span class="p">)))</span>

            <span class="c">## do port checking only if externalPort or URL was set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">port</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;port </span><span class="si">%d</span><span class="s"> in HTTP Host header &#39;</span><span class="si">%s</span><span class="s">&#39; does not match server listening port </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_request_host</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;skipping openening handshake port checking - neither WS URL nor external port set&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">http_request_host</span> <span class="o">=</span> <span class="n">h</span>

         <span class="k">else</span><span class="p">:</span>
            <span class="c">## do port checking only if externalPort or URL was set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span><span class="p">:</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isSecure</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span> <span class="o">==</span> <span class="mi">443</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isSecure</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span> <span class="o">==</span> <span class="mi">80</span><span class="p">)):</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;missing port in HTTP Host header &#39;</span><span class="si">%s</span><span class="s">&#39; and server runs on non-standard port </span><span class="si">%d</span><span class="s"> (wss = </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_request_host</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isSecure</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;skipping openening handshake port checking - neither WS URL nor external port set&quot;</span><span class="p">)</span>

         <span class="c">## Upgrade</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;upgrade&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
            <span class="c">## When no WS upgrade, render HTML server status page</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">webStatus</span><span class="p">:</span>
               <span class="k">if</span> <span class="s">&#39;redirect&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_request_params</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_request_params</span><span class="p">[</span><span class="s">&#39;redirect&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="c">## To specifiy an URL for redirection, encode the URL, i.e. from JavaScript:</span>
                  <span class="c">##</span>
                  <span class="c">##    var url = encodeURIComponent(&quot;http://autobahn.ws/python&quot;);</span>
                  <span class="c">##</span>
                  <span class="c">## and append the encoded string as a query parameter &#39;redirect&#39;</span>
                  <span class="c">##</span>
                  <span class="c">##    http://localhost:9000?redirect=http%3A%2F%2Fautobahn.ws%2Fpython</span>
                  <span class="c">##    https://localhost:9000?redirect=https%3A%2F%2Ftwitter.com%2F</span>
                  <span class="c">##</span>
                  <span class="c">## This will perform an immediate HTTP-303 redirection. If you provide</span>
                  <span class="c">## an additional parameter &#39;after&#39; (int &gt;= 0), the redirection happens</span>
                  <span class="c">## via Meta-Refresh in the rendered HTML status page, i.e.</span>
                  <span class="c">##</span>
                  <span class="c">##    https://localhost:9000/?redirect=https%3A%2F%2Ftwitter.com%2F&amp;after=3</span>
                  <span class="c">##</span>
                  <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_request_params</span><span class="p">[</span><span class="s">&#39;redirect&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                  <span class="k">if</span> <span class="s">&#39;after&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_request_params</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_request_params</span><span class="p">[</span><span class="s">&#39;after&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                     <span class="n">after</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_request_params</span><span class="p">[</span><span class="s">&#39;after&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;HTTP Upgrade header missing : render server status page and meta-refresh-redirecting to </span><span class="si">%s</span><span class="s"> after </span><span class="si">%d</span><span class="s"> seconds&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">after</span><span class="p">))</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sendServerStatus</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>
                  <span class="k">else</span><span class="p">:</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;HTTP Upgrade header missing : 303-redirecting to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sendRedirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;HTTP Upgrade header missing : render server status page&quot;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">sendServerStatus</span><span class="p">()</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">dropConnection</span><span class="p">(</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
               <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Upgrade header missing&quot;</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">UPGRADE_REQUIRED</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
         <span class="n">upgradeWebSocket</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;upgrade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;websocket&quot;</span><span class="p">:</span>
               <span class="n">upgradeWebSocket</span> <span class="o">=</span> <span class="bp">True</span>
               <span class="k">break</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="n">upgradeWebSocket</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Upgrade headers do not include &#39;websocket&#39; value (case-insensitive) : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;upgrade&quot;</span><span class="p">])</span>

         <span class="c">## Connection</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;connection&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Connection header missing&quot;</span><span class="p">)</span>
         <span class="n">connectionUpgrade</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;connection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;upgrade&quot;</span><span class="p">:</span>
               <span class="n">connectionUpgrade</span> <span class="o">=</span> <span class="bp">True</span>
               <span class="k">break</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="n">connectionUpgrade</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Connection headers do not include &#39;upgrade&#39; value (case-insensitive) : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;connection&quot;</span><span class="p">])</span>

         <span class="c">## Sec-WebSocket-Version PLUS determine mode: Hybi or Hixie</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;sec-websocket-version&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;Hixie76 protocol detected&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowHixie76</span><span class="p">:</span>
               <span class="n">version</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;WebSocket connection denied - Hixie76 protocol mode disabled.&quot;</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;Hybi protocol detected&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">http_headers_cnt</span><span class="p">[</span><span class="s">&quot;sec-websocket-version&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Sec-WebSocket-Version header appears more than once in opening handshake request&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
               <span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;sec-websocket-version&quot;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;could not parse HTTP Sec-WebSocket-Version header &#39;</span><span class="si">%s</span><span class="s">&#39; in opening handshake request&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;sec-websocket-version&quot;</span><span class="p">])</span>

         <span class="k">if</span> <span class="n">version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">:</span>

            <span class="c">## respond with list of supported versions (descending order)</span>
            <span class="c">##</span>
            <span class="n">sv</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">)</span>
            <span class="n">sv</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">svs</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sv</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;WebSocket version </span><span class="si">%d</span><span class="s"> not supported (supported versions: </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">svs</span><span class="p">),</span>
                                      <span class="n">http</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="p">[(</span><span class="s">&quot;Sec-WebSocket-Version&quot;</span><span class="p">,</span> <span class="n">svs</span><span class="p">)])</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c">## store the protocol version we are supposed to talk</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">=</span> <span class="n">version</span>

         <span class="c">## Sec-WebSocket-Protocol</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="s">&#39;sec-websocket-protocol&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
            <span class="n">protocols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;sec-websocket-protocol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)]</span>
            <span class="c"># check for duplicates in protocol header</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;duplicate protocol &#39;</span><span class="si">%s</span><span class="s">&#39; specified in HTTP Sec-WebSocket-Protocol header&quot;</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="n">pp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c"># ok, no duplicates, save list in order the client sent it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">websocket_protocols</span> <span class="o">=</span> <span class="n">protocols</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">websocket_protocols</span> <span class="o">=</span> <span class="p">[]</span>

         <span class="c">## Origin / Sec-WebSocket-Origin</span>
         <span class="c">## http://tools.ietf.org/html/draft-ietf-websec-origin-02</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">&lt;</span> <span class="mi">13</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Hybi, but only &lt; Hybi-13</span>
            <span class="n">websocket_origin_header_key</span> <span class="o">=</span> <span class="s">&#39;sec-websocket-origin&#39;</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c"># RFC6455, &gt;= Hybi-13 and Hixie</span>
            <span class="n">websocket_origin_header_key</span> <span class="o">=</span> <span class="s">&quot;origin&quot;</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">websocket_origin</span> <span class="o">=</span> <span class="bp">None</span>
         <span class="k">if</span> <span class="n">websocket_origin_header_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">http_headers_cnt</span><span class="p">[</span><span class="n">websocket_origin_header_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Origin header appears more than once in opening handshake request&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">websocket_origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="n">websocket_origin_header_key</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c"># non-browser clients are allowed to omit this header</span>
            <span class="k">pass</span>

         <span class="c">## Sec-WebSocket-Key (Hybi) or Sec-WebSocket-Key1/Sec-WebSocket-Key2 (Hixie-76)</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Sec-WebSocket-Key1&#39;</span><span class="p">,</span> <span class="s">&#39;Sec-WebSocket-Key2&#39;</span><span class="p">]:</span>
               <span class="n">k</span> <span class="o">=</span> <span class="n">kk</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP </span><span class="si">%s</span><span class="s"> header missing&quot;</span> <span class="o">%</span> <span class="n">kk</span><span class="p">)</span>
               <span class="k">if</span> <span class="n">http_headers_cnt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP </span><span class="si">%s</span><span class="s"> header appears more than once in opening handshake request&quot;</span> <span class="o">%</span> <span class="n">kk</span><span class="p">)</span>
               <span class="k">try</span><span class="p">:</span>
                  <span class="n">key1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseHixie76Key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;sec-websocket-key1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                  <span class="n">key2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseHixie76Key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;sec-websocket-key2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
               <span class="k">except</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;could not parse Sec-WebSocket-Key1/2&quot;</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;sec-websocket-key&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Sec-WebSocket-Key header missing&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">http_headers_cnt</span><span class="p">[</span><span class="s">&quot;sec-websocket-key&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Sec-WebSocket-Key header appears more than once in opening handshake request&quot;</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;sec-websocket-key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">:</span> <span class="c"># 16 bytes =&gt; (ceil(128/24)*24)/6 == 24</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;bad Sec-WebSocket-Key (length must be 24 ASCII chars) &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="s">&quot;==&quot;</span><span class="p">:</span> <span class="c"># 24 - ceil(128/6) == 2</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;bad Sec-WebSocket-Key (invalid base64 encoding) &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">key</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
               <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/&quot;</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;bad character &#39;</span><span class="si">%s</span><span class="s">&#39; in Sec-WebSocket-Key (invalid base64 encoding) &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

         <span class="c">## Sec-WebSocket-Extensions</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">websocket_extensions</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="k">if</span> <span class="s">&#39;sec-websocket-extensions&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Sec-WebSocket-Extensions header encountered for Hixie-76&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">http_headers_cnt</span><span class="p">[</span><span class="s">&quot;sec-websocket-extensions&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Sec-WebSocket-Extensions header appears more than once in opening handshake request&quot;</span><span class="p">)</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="c">## extensions requested/offered by client</span>
                  <span class="c">##</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">websocket_extensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseExtensionsHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;sec-websocket-extensions&quot;</span><span class="p">])</span>

         <span class="c">## For Hixie-76, we need 8 octets of HTTP request body to complete HS!</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span><span class="p">:</span>
               <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">key3</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;received HTTP request body containing key3 for Hixie-76: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">key3</span><span class="p">)</span>

         <span class="c">## Ok, got complete HS input, remember rest (if any)</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span><span class="p">:]</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:]</span>

         <span class="c">## store WS key</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wskey</span> <span class="o">=</span> <span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">key3</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wskey</span> <span class="o">=</span> <span class="n">key</span>

         <span class="c">## WebSocket handshake validated =&gt; produce opening handshake response</span>

         <span class="c">## Now fire onConnect() on derived class, to give that class a chance to accept or deny</span>
         <span class="c">## the connection. onConnect() may throw, in which case the connection is denied, or it</span>
         <span class="c">## may return a protocol from the protocols provided by client or None.</span>
         <span class="c">##</span>
         <span class="n">request</span> <span class="o">=</span> <span class="n">ConnectionRequest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">http_request_host</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">http_request_path</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">http_request_params</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">websocket_origin</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">websocket_protocols</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">websocket_extensions</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_onConnect</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">succeedHandshake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback after onConnect() returns successfully. Generates the response for the handshake.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">protocol</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">protocol</span> <span class="o">=</span> <span class="n">res</span>

      <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">protocol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_protocols</span><span class="p">):</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;protocol accepted must be from the list client sent or None&quot;</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">websocket_protocol_in_use</span> <span class="o">=</span> <span class="n">protocol</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">key3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wskey</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wskey</span>


      <span class="c">## extensions effectively in use for this connection</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">websocket_extensions_in_use</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="n">extensionResponse</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="c">## gets filled with permessage-compress offers from the client</span>
      <span class="c">##</span>
      <span class="n">pmceOffers</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="c">## handle WebSocket extensions</span>
      <span class="c">##</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_extensions</span><span class="p">:</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;parsed WebSocket extension &#39;</span><span class="si">%s</span><span class="s">&#39; with params &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>

         <span class="c">## process permessage-compress extension</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">PERMESSAGE_COMPRESSION_EXTENSION</span><span class="p">:</span>

            <span class="n">PMCE</span> <span class="o">=</span> <span class="n">PERMESSAGE_COMPRESSION_EXTENSION</span><span class="p">[</span><span class="n">extension</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
               <span class="n">offer</span> <span class="o">=</span> <span class="n">PMCE</span><span class="p">[</span><span class="s">&#39;Offer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
               <span class="n">pmceOffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offer</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;client requested &#39;</span><span class="si">%s</span><span class="s">&#39; extension we don&#39;t support or which is not activated&quot;</span> <span class="o">%</span> <span class="n">extension</span><span class="p">)</span>

      <span class="c">## handle permessage-compress offers by the client</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pmceOffers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">accept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionAccept</span><span class="p">(</span><span class="n">pmceOffers</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">accept</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">PMCE</span> <span class="o">=</span> <span class="n">PERMESSAGE_COMPRESSION_EXTENSION</span><span class="p">[</span><span class="n">accept</span><span class="o">.</span><span class="n">EXTENSION_NAME</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span> <span class="o">=</span> <span class="n">PMCE</span><span class="p">[</span><span class="s">&#39;PMCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">createFromOfferAccept</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span><span class="p">,</span> <span class="n">accept</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">websocket_extensions_in_use</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="p">)</span>
            <span class="n">extensionResponse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accept</span><span class="o">.</span><span class="n">getExtensionString</span><span class="p">())</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;client request permessage-compress extension, but we did not accept any offer [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">pmceOffers</span><span class="p">)</span>


      <span class="c">## build response to complete WebSocket handshake</span>
      <span class="c">##</span>
      <span class="n">response</span> <span class="o">=</span> <span class="s">&quot;HTTP/1.1 </span><span class="si">%d</span><span class="s"> Switching Protocols</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">http</span><span class="o">.</span><span class="n">SWITCHING_PROTOCOLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
         <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Server: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">server</span>

      <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Upgrade: WebSocket</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>
      <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Connection: Upgrade</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>

      <span class="c">## optional, user supplied additional HTTP headers</span>
      <span class="c">##</span>
      <span class="c">## headers from factory</span>
      <span class="k">for</span> <span class="n">uh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
         <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uh</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="c">## headers from onConnect</span>
      <span class="k">for</span> <span class="n">uh</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
         <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uh</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_protocol_in_use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Protocol: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">websocket_protocol_in_use</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_origin</span><span class="p">:</span>
            <span class="c">## browser client provide the header, and expect it to be echo&#39;ed</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Origin: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">websocket_origin</span><span class="p">)</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&#39;factory isSecure = </span><span class="si">%s</span><span class="s"> port = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isSecure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span><span class="p">))</span>

         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isSecure</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span> <span class="o">!=</span> <span class="mi">443</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isSecure</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span> <span class="o">!=</span> <span class="mi">80</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&#39;factory running on non-default port&#39;</span><span class="p">)</span>
            <span class="n">response_port</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">externalPort</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&#39;factory running on default port&#39;</span><span class="p">)</span>
            <span class="n">response_port</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

         <span class="c">## FIXME: check this! But see below ..</span>
         <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">response_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
            <span class="n">response_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">response_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_request_host</span><span class="p">)</span>
            <span class="n">response_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_request_uri</span><span class="p">)</span>

         <span class="n">location</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">://</span><span class="si">%s%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;wss&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isSecure</span> <span class="k">else</span> <span class="s">&#39;ws&#39;</span><span class="p">,</span> <span class="n">response_host</span><span class="p">,</span> <span class="n">response_port</span><span class="p">,</span> <span class="n">response_path</span><span class="p">)</span>

         <span class="c"># Safari is very picky about this one</span>
         <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Location: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">location</span>

         <span class="c">## end of HTTP response headers</span>
         <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>

         <span class="c">## compute accept body</span>
         <span class="c">##</span>
         <span class="n">accept_val</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">)</span> <span class="o">+</span> <span class="n">key3</span>
         <span class="n">response_body</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">accept_val</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

      <span class="k">else</span><span class="p">:</span>
         <span class="c">## compute Sec-WebSocket-Accept</span>
         <span class="c">##</span>
         <span class="n">sha1</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
         <span class="n">sha1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">_WS_MAGIC</span><span class="p">)</span>
         <span class="n">sec_websocket_accept</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">sha1</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>

         <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Accept: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sec_websocket_accept</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

         <span class="c">## agreed extensions</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensionResponse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Extensions: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extensionResponse</span><span class="p">)</span>

         <span class="c">## end of HTTP response headers</span>
         <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>
         <span class="n">response_body</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c">## send out opening handshake response</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;sending HTTP response:</span><span class="se">\n\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">response_body</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;sending HTTP response body:</span><span class="se">\n\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">response_body</span><span class="p">))</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">response_body</span><span class="p">)</span>

      <span class="c">## save response for testsuite</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">http_response_data</span> <span class="o">=</span> <span class="n">response</span>

      <span class="c">## opening handshake completed, move WebSocket connection into OPEN state</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span>

      <span class="c">## cancel any opening HS timer if present</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeoutCall</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;openHandshakeTimeoutCall.cancel&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeoutCall</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeoutCall</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c">## init state</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">inside_message</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c">## fire handler on derived class</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="s">&quot;onOpen&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_onOpen</span><span class="p">()</span>

      <span class="c">## process rest, if any</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">consumeData</span><span class="p">()</span>


   <span class="k">def</span> <span class="nf">failHandshake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">responseHeaders</span> <span class="o">=</span> <span class="p">[]):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      During opening handshake the client request was invalid, we send a HTTP</span>
<span class="sd">      error response and then drop the connection.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;failing WebSocket opening handshake (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">reason</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendHttpErrorResponse</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">responseHeaders</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dropConnection</span><span class="p">(</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">sendHttpErrorResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">responseHeaders</span> <span class="o">=</span> <span class="p">[]):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Send out HTTP error response.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">response</span>  <span class="o">=</span> <span class="s">&quot;HTTP/1.1 {0} {1}</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">responseHeaders</span><span class="p">:</span>
         <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;{0}: {1}</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">))</span>


   <span class="k">def</span> <span class="nf">sendHtml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Send HTML page HTTP response.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">responseBody</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
      <span class="n">response</span>  <span class="o">=</span> <span class="s">&quot;HTTP/1.1 </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">OK</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">http</span><span class="o">.</span><span class="n">OK</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
         <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Server: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">server</span>
      <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Content-Type: text/html; charset=UTF-8</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>
      <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Content-Length: </span><span class="si">%d</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">responseBody</span><span class="p">)</span>
      <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">responseBody</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">sendRedirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Send HTTP Redirect (303) response.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">response</span>  <span class="o">=</span> <span class="s">&quot;HTTP/1.1 </span><span class="si">%d</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">http</span><span class="o">.</span><span class="n">SEE_OTHER</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
         <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Server: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">server</span>
      <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;Location: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">url</span>
      <span class="n">response</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">))</span>


   <span class="k">def</span> <span class="nf">sendServerStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirectUrl</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">redirectAfter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Used to send out server status/version upon receiving a HTTP/GET without</span>
<span class="sd">      upgrade to WebSocket header (and option serverStatus is True).</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">redirectUrl</span><span class="p">:</span>
         <span class="n">redirect</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;&lt;meta http-equiv=&quot;refresh&quot; content=&quot;</span><span class="si">%d</span><span class="s">;URL=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;&gt;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redirectAfter</span><span class="p">,</span> <span class="n">redirectUrl</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">redirect</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
      <span class="n">html</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">&lt;!DOCTYPE html&gt;</span>
<span class="s">&lt;html&gt;</span>
<span class="s">   &lt;head&gt;</span>
<span class="s">      </span><span class="si">%s</span><span class="s"></span>
<span class="s">      &lt;style&gt;</span>
<span class="s">         body {</span>
<span class="s">            color: #fff;</span>
<span class="s">            background-color: #027eae;</span>
<span class="s">            font-family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;</span>
<span class="s">            font-size: 16px;</span>
<span class="s">         }</span>

<span class="s">         a, a:visited, a:hover {</span>
<span class="s">            color: #fff;</span>
<span class="s">         }</span>
<span class="s">      &lt;/style&gt;</span>
<span class="s">   &lt;/head&gt;</span>
<span class="s">   &lt;body&gt;</span>
<span class="s">      &lt;h1&gt;AutobahnPython </span><span class="si">%s</span><span class="s">&lt;/h1&gt;</span>
<span class="s">      &lt;p&gt;</span>
<span class="s">         I am not Web server, but a WebSocket endpoint.</span>
<span class="s">         You can talk to me using the WebSocket &lt;a href=&quot;http://tools.ietf.org/html/rfc6455&quot;&gt;protocol&lt;/a&gt;.</span>
<span class="s">      &lt;/p&gt;</span>
<span class="s">      &lt;p&gt;</span>
<span class="s">         For more information, please visit &lt;a href=&quot;http://autobahn.ws/python&quot;&gt;my homepage&lt;/a&gt;.</span>
<span class="s">      &lt;/p&gt;</span>
<span class="s">   &lt;/body&gt;</span>
<span class="s">&lt;/html&gt;</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">redirect</span><span class="p">,</span> <span class="n">__version__</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendHtml</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="WebSocketServerFactory"><a class="viewcode-back" href="../../../websocketserver.html#autobahn.websocket.protocol.WebSocketServerFactory">[docs]</a><span class="k">class</span> <span class="nc">WebSocketServerFactory</span><span class="p">(</span><span class="n">WebSocketFactory</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   A protocol factory for WebSocket servers.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">protocol</span> <span class="o">=</span> <span class="n">WebSocketServerProtocol</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   The protocol to be spoken. Must be derived from :class:`autobahn.websocket.protocol.WebSocketServerProtocol`.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">isServer</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Flag indicating if this factory is client- or server-side.</span>
<span class="sd">   &quot;&quot;&quot;</span>


<div class="viewcode-block" id="WebSocketServerFactory.__init__"><a class="viewcode-back" href="../../../websocketserver.html#autobahn.websocket.protocol.WebSocketServerFactory.__init__">[docs]</a>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">url</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                <span class="n">protocols</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="n">server</span> <span class="o">=</span> <span class="s">&quot;AutobahnPython/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">__version__</span><span class="p">,</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{},</span>
                <span class="n">externalPort</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">debugCodePaths</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Create instance of WebSocket server factory.</span>

<span class="sd">      :param url: The WebSocket URL this factory is working for, e.g. `ws://myhost.com/somepath`.</span>
<span class="sd">                  For non-TCP transports like pipes or Unix domain sockets, provide `None`.</span>
<span class="sd">                  This will use an implicit URL of `ws://localhost`.</span>
<span class="sd">      :type url: str</span>
<span class="sd">      :param protocols: List of subprotocols the server supports. The subprotocol used is the first from the list of subprotocols announced by the client that is contained in this list.</span>
<span class="sd">      :type protocols: list of strings</span>
<span class="sd">      :param server: Server as announced in HTTP response header during opening handshake or None (default: `AutobahnWebSocket/?.?.?`).</span>
<span class="sd">      :type server: str</span>
<span class="sd">      :param headers: An optional mapping of additional HTTP headers to send during the WebSocket opening handshake.</span>
<span class="sd">      :type headers: dict</span>
<span class="sd">      :param externalPort: Optionally, the external visible port this factory will be reachable under (i.e. when running behind a L2/L3 forwarding device).</span>
<span class="sd">      :type externalPort: int</span>
<span class="sd">      :param debug: Debug mode (default: `False`).</span>
<span class="sd">      :type debug: bool</span>
<span class="sd">      :param debugCodePaths: Debug code paths mode (default: `False`).</span>
<span class="sd">      :type debugCodePaths: bool</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span> <span class="o">=</span> <span class="n">debugCodePaths</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">logOctets</span> <span class="o">=</span> <span class="n">debug</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">logFrames</span> <span class="o">=</span> <span class="n">debug</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">trackTimings</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="c">## seed RNG which is used for WS frame masks generation</span>
      <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>

      <span class="c">## default WS session parameters</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setSessionParameters</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">protocols</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">externalPort</span><span class="p">)</span>

      <span class="c">## default WebSocket protocol options</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">resetProtocolOptions</span><span class="p">()</span>

      <span class="c">## number of currently connected clients</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">countConnections</span> <span class="o">=</span> <span class="mi">0</span>

</div>
<div class="viewcode-block" id="WebSocketServerFactory.setSessionParameters"><a class="viewcode-back" href="../../../websocketserver.html#autobahn.websocket.protocol.WebSocketServerFactory.setSessionParameters">[docs]</a>   <span class="k">def</span> <span class="nf">setSessionParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">url</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                            <span class="n">protocols</span> <span class="o">=</span> <span class="p">[],</span>
                            <span class="n">server</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                            <span class="n">headers</span> <span class="o">=</span> <span class="p">{},</span>
                            <span class="n">externalPort</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Set WebSocket session parameters.</span>

<span class="sd">      :param url: The WebSocket URL this factory is working for, e.g. `ws://myhost.com/somepath`.</span>
<span class="sd">                  For non-TCP transports like pipes or Unix domain sockets, provide `None`.</span>
<span class="sd">                  This will use an implicit URL of `ws://localhost`.</span>
<span class="sd">      :type url: str</span>
<span class="sd">      :param protocols: List of subprotocols the server supports. The subprotocol used is the first from the list of subprotocols announced by the client that is contained in this list.</span>
<span class="sd">      :type protocols: list of strings</span>
<span class="sd">      :param server: Server as announced in HTTP response header during opening handshake.</span>
<span class="sd">      :type server: str</span>
<span class="sd">      :param headers: An optional mapping of additional HTTP headers to send during the WebSocket opening handshake.</span>
<span class="sd">      :type headers: dict</span>
<span class="sd">      :param externalPort: Optionally, the external visible port this server will be reachable under (i.e. when running behind a L2/L3 forwarding device).</span>
<span class="sd">      :type externalPort: int</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">## parse WebSocket URI into components</span>
      <span class="p">(</span><span class="n">isSecure</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">=</span> <span class="n">parseWsUrl</span><span class="p">(</span><span class="n">url</span> <span class="ow">or</span> <span class="s">&quot;ws://localhost&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;query parameters specified for server WebSocket URL&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">isSecure</span> <span class="o">=</span> <span class="n">isSecure</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="o">=</span> <span class="n">protocols</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>

      <span class="k">if</span> <span class="n">externalPort</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">externalPort</span> <span class="o">=</span> <span class="n">externalPort</span>
      <span class="k">elif</span> <span class="n">url</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">externalPort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">externalPort</span> <span class="o">=</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="WebSocketServerFactory.resetProtocolOptions"><a class="viewcode-back" href="../../../websocketserver.html#autobahn.websocket.protocol.WebSocketServerFactory.resetProtocolOptions">[docs]</a>   <span class="k">def</span> <span class="nf">resetProtocolOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Reset all WebSocket protocol options to defaults.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">versions</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SUPPORTED_PROTOCOL_VERSIONS</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">allowHixie76</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">DEFAULT_ALLOW_HIXIE76</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">webStatus</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncoming</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">requireMaskedClientFrames</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">maskServerFrames</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">maxFramePayloadSize</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">autoFragmentSize</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">failByDrop</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">echoCloseCodeReason</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeout</span> <span class="o">=</span> <span class="mi">5</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeout</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">tcpNoDelay</span> <span class="o">=</span> <span class="bp">True</span>

      <span class="c">## permessage-XXX extension</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionAccept</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="WebSocketServerFactory.setProtocolOptions"><a class="viewcode-back" href="../../../websocketserver.html#autobahn.websocket.protocol.WebSocketServerFactory.setProtocolOptions">[docs]</a>   <span class="k">def</span> <span class="nf">setProtocolOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">versions</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">allowHixie76</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">webStatus</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">utf8validateIncoming</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">maskServerFrames</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">requireMaskedClientFrames</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">applyMask</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">maxFramePayloadSize</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">maxMessagePayloadSize</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">autoFragmentSize</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">failByDrop</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">echoCloseCodeReason</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">openHandshakeTimeout</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">closeHandshakeTimeout</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">tcpNoDelay</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">perMessageCompressionAccept</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Set WebSocket protocol options used as defaults for new protocol instances.</span>

<span class="sd">      :param versions: The WebSocket protocol versions accepted by the server (default: :func:`autobahn.websocket.protocol.WebSocketProtocol.SUPPORTED_PROTOCOL_VERSIONS`).</span>
<span class="sd">      :type versions: list of ints</span>
<span class="sd">      :param allowHixie76: Allow to speak Hixie76 protocol version.</span>
<span class="sd">      :type allowHixie76: bool</span>
<span class="sd">      :param webStatus: Return server status/version on HTTP/GET without WebSocket upgrade header (default: `True`).</span>
<span class="sd">      :type webStatus: bool</span>
<span class="sd">      :param utf8validateIncoming: Validate incoming UTF-8 in text message payloads (default: `True`).</span>
<span class="sd">      :type utf8validateIncoming: bool</span>
<span class="sd">      :param maskServerFrames: Mask server-to-client frames (default: `False`).</span>
<span class="sd">      :type maskServerFrames: bool</span>
<span class="sd">      :param requireMaskedClientFrames: Require client-to-server frames to be masked (default: `True`).</span>
<span class="sd">      :type requireMaskedClientFrames: bool</span>
<span class="sd">      :param applyMask: Actually apply mask to payload when mask it present. Applies for outgoing and incoming frames (default: `True`).</span>
<span class="sd">      :type applyMask: bool</span>
<span class="sd">      :param maxFramePayloadSize: Maximum frame payload size that will be accepted when receiving or `0` for unlimited (default: `0`).</span>
<span class="sd">      :type maxFramePayloadSize: int</span>
<span class="sd">      :param maxMessagePayloadSize: Maximum message payload size (after reassembly of fragmented messages) that will be accepted when receiving or `0` for unlimited (default: `0`).</span>
<span class="sd">      :type maxMessagePayloadSize: int</span>
<span class="sd">      :param autoFragmentSize: Automatic fragmentation of outgoing data messages (when using the message-based API) into frames with payload length `&lt;=` this size or `0` for no auto-fragmentation (default: `0`).</span>
<span class="sd">      :type autoFragmentSize: int</span>
<span class="sd">      :param failByDrop: Fail connections by dropping the TCP connection without performaing closing handshake (default: `True`).</span>
<span class="sd">      :type failbyDrop: bool</span>
<span class="sd">      :param echoCloseCodeReason: Iff true, when receiving a close, echo back close code/reason. Otherwise reply with `code == 1000, reason = &quot;&quot;` (default: `False`).</span>
<span class="sd">      :type echoCloseCodeReason: bool</span>
<span class="sd">      :param openHandshakeTimeout: Opening WebSocket handshake timeout, timeout in seconds or `0` to deactivate (default: `0`).</span>
<span class="sd">      :type openHandshakeTimeout: float</span>
<span class="sd">      :param closeHandshakeTimeout: When we expect to receive a closing handshake reply, timeout in seconds (default: `1`).</span>
<span class="sd">      :type closeHandshakeTimeout: float</span>
<span class="sd">      :param tcpNoDelay: TCP NODELAY (&quot;Nagle&quot;) socket option (default: `True`).</span>
<span class="sd">      :type tcpNoDelay: bool</span>
<span class="sd">      :param perMessageCompressionAccept: Acceptor function for offers.</span>
<span class="sd">      :type perMessageCompressionAccept: callable</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">allowHixie76</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">allowHixie76</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowHixie76</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">allowHixie76</span> <span class="o">=</span> <span class="n">allowHixie76</span>

      <span class="k">if</span> <span class="n">versions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SUPPORTED_PROTOCOL_VERSIONS</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid WebSocket protocol version </span><span class="si">%s</span><span class="s"> (allowed values: </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SUPPORTED_PROTOCOL_VERSIONS</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowHixie76</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;use of Hixie-76 requires allowHixie76 == True&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">versions</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">versions</span> <span class="o">=</span> <span class="n">versions</span>

      <span class="k">if</span> <span class="n">webStatus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">webStatus</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">webStatus</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">webStatus</span> <span class="o">=</span> <span class="n">webStatus</span>

      <span class="k">if</span> <span class="n">utf8validateIncoming</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">utf8validateIncoming</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncoming</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncoming</span> <span class="o">=</span> <span class="n">utf8validateIncoming</span>

      <span class="k">if</span> <span class="n">requireMaskedClientFrames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">requireMaskedClientFrames</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requireMaskedClientFrames</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">requireMaskedClientFrames</span> <span class="o">=</span> <span class="n">requireMaskedClientFrames</span>

      <span class="k">if</span> <span class="n">maskServerFrames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">maskServerFrames</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maskServerFrames</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">maskServerFrames</span> <span class="o">=</span> <span class="n">maskServerFrames</span>

      <span class="k">if</span> <span class="n">applyMask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">applyMask</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span> <span class="o">=</span> <span class="n">applyMask</span>

      <span class="k">if</span> <span class="n">maxFramePayloadSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">maxFramePayloadSize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxFramePayloadSize</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">maxFramePayloadSize</span> <span class="o">=</span> <span class="n">maxFramePayloadSize</span>

      <span class="k">if</span> <span class="n">maxMessagePayloadSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">maxMessagePayloadSize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span> <span class="o">=</span> <span class="n">maxMessagePayloadSize</span>

      <span class="k">if</span> <span class="n">autoFragmentSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">autoFragmentSize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoFragmentSize</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">autoFragmentSize</span> <span class="o">=</span> <span class="n">autoFragmentSize</span>

      <span class="k">if</span> <span class="n">failByDrop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">failByDrop</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failByDrop</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">failByDrop</span> <span class="o">=</span> <span class="n">failByDrop</span>

      <span class="k">if</span> <span class="n">echoCloseCodeReason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">echoCloseCodeReason</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">echoCloseCodeReason</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">echoCloseCodeReason</span> <span class="o">=</span> <span class="n">echoCloseCodeReason</span>

      <span class="k">if</span> <span class="n">openHandshakeTimeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">openHandshakeTimeout</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeout</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeout</span> <span class="o">=</span> <span class="n">openHandshakeTimeout</span>

      <span class="k">if</span> <span class="n">closeHandshakeTimeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">closeHandshakeTimeout</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeout</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeout</span> <span class="o">=</span> <span class="n">closeHandshakeTimeout</span>

      <span class="k">if</span> <span class="n">tcpNoDelay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tcpNoDelay</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcpNoDelay</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">tcpNoDelay</span> <span class="o">=</span> <span class="n">tcpNoDelay</span>

      <span class="k">if</span> <span class="n">perMessageCompressionAccept</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">perMessageCompressionAccept</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionAccept</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionAccept</span> <span class="o">=</span> <span class="n">perMessageCompressionAccept</span>

</div>
<div class="viewcode-block" id="WebSocketServerFactory.getConnectionCount"><a class="viewcode-back" href="../../../websocketserver.html#autobahn.websocket.protocol.WebSocketServerFactory.getConnectionCount">[docs]</a>   <span class="k">def</span> <span class="nf">getConnectionCount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Get number of currently connected clients.</span>

<span class="sd">      :returns: int -- Number of currently connected clients.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">countConnections</span>


</div></div>
<div class="viewcode-block" id="WebSocketClientProtocol"><a class="viewcode-back" href="../../../websocketclient.html#autobahn.websocket.protocol.WebSocketClientProtocol">[docs]</a><span class="k">class</span> <span class="nc">WebSocketClientProtocol</span><span class="p">(</span><span class="n">WebSocketProtocol</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Protocol base class for WebSocket clients.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">CONFIG_ATTRS</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CONFIG_ATTRS_COMMON</span> <span class="o">+</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">CONFIG_ATTRS_CLIENT</span>


<div class="viewcode-block" id="WebSocketClientProtocol.onConnect"><a class="viewcode-back" href="../../../websocketclient.html#autobahn.websocket.protocol.WebSocketClientProtocol.onConnect">[docs]</a>   <span class="k">def</span> <span class="nf">onConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Callback fired directly after WebSocket opening handshake when new WebSocket server</span>
<span class="sd">      connection was established.</span>

<span class="sd">      :param response: WebSocket connection response information.</span>
<span class="sd">      :type response: instance of :class:`autobahn.websocket.protocol.ConnectionResponse`</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">pass</span>

</div>
   <span class="k">def</span> <span class="nf">_connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Called by network framework when new transport connection to server was established. Default</span>
<span class="sd">      implementation will start the initial WebSocket opening handshake (or proxy connect).</span>
<span class="sd">      When overriding in derived class, make sure to call this base class</span>
<span class="sd">      implementation _before_ your code.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">_connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;connection to </span><span class="si">%s</span><span class="s"> established&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="c">## start by doing a HTTP/CONNECT for explicit proxies</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">startProxyConnect</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="c">## immediately start with the WebSocket opening handshake</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">startHandshake</span><span class="p">()</span>


   <span class="k">def</span> <span class="nf">_connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Called by network framework when established transport connection to server was lost. Default</span>
<span class="sd">      implementation will tear down all state properly.</span>
<span class="sd">      When overriding in derived class, make sure to call this base class</span>
<span class="sd">      implementation _after_ your code.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">_connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;connection to </span><span class="si">%s</span><span class="s"> lost&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">startProxyConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Connect to explicit proxy.</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="c">## construct proxy connect HTTP request</span>
      <span class="c">##</span>
      <span class="n">request</span>  <span class="o">=</span> <span class="s">&quot;CONNECT </span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s"> HTTP/1.1</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
      <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Host: </span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
      <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">processProxyConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Process HTTP/CONNECT response from server.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">## only proceed when we have fully received the HTTP request line and all headers</span>
      <span class="c">##</span>
      <span class="n">end_of_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;</span><span class="se">\x0d\x0a\x0d\x0a</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">end_of_header</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>

         <span class="n">http_response_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;received HTTP response:</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">http_response_data</span><span class="p">)</span>

         <span class="c">## extract HTTP status line and headers</span>
         <span class="c">##</span>
         <span class="p">(</span><span class="n">http_status_line</span><span class="p">,</span> <span class="n">http_headers</span><span class="p">,</span> <span class="n">http_headers_cnt</span><span class="p">)</span> <span class="o">=</span> <span class="n">parseHttpHeader</span><span class="p">(</span><span class="n">http_response_data</span><span class="p">)</span>

         <span class="c">## validate proxy connect response</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;received HTTP status line for proxy connect request : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">http_status_line</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;received HTTP headers for proxy connect request : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">http_headers</span><span class="p">))</span>

         <span class="c">## Response Line</span>
         <span class="c">##</span>
         <span class="n">sl</span> <span class="o">=</span> <span class="n">http_status_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failProxyConnect</span><span class="p">(</span><span class="s">&quot;Bad HTTP response status line &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">http_status_line</span><span class="p">)</span>

         <span class="c">## HTTP version</span>
         <span class="c">##</span>
         <span class="n">http_version</span> <span class="o">=</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
         <span class="k">if</span> <span class="n">http_version</span> <span class="o">!=</span> <span class="s">&quot;HTTP/1.1&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failProxyConnect</span><span class="p">(</span><span class="s">&quot;Unsupported HTTP version (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">http_version</span><span class="p">)</span>

         <span class="c">## HTTP status code</span>
         <span class="c">##</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
         <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failProxyConnect</span><span class="p">(</span><span class="s">&quot;Bad HTTP status code (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

         <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">):</span>

            <span class="c">## FIXME: handle redirects</span>
            <span class="c">## FIXME: handle authentication required</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
               <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot; - </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failProxyConnect</span><span class="p">(</span><span class="s">&quot;HTTP proxy connect failed (</span><span class="si">%d%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>


         <span class="c">## Ok, got complete response for HTTP/CONNECT, remember rest (if any)</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:]</span>

         <span class="c">## opening handshake completed, move WebSocket connection into OPEN state</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_CONNECTING</span>

         <span class="c">## process rest of buffered data, if any</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumeData</span><span class="p">()</span>

         <span class="c">## now start WebSocket opening handshake</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">startHandshake</span><span class="p">()</span>


   <span class="k">def</span> <span class="nf">failProxyConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      During initial explicit proxy connect, the server response indicates some failure and we drop the</span>
<span class="sd">      connection.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;failing proxy connect (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">reason</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dropConnection</span><span class="p">(</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">createHixieKey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Supposed to implement the crack smoker algorithm below. Well, crack</span>
<span class="sd">      probably wasn&#39;t the stuff they smoked - dog poo?</span>

<span class="sd">      http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76#page-21</span>
<span class="sd">      Items 16 - 22</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">spaces1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
      <span class="n">max1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">4294967295</span> <span class="o">/</span> <span class="n">spaces1</span><span class="p">)</span>
      <span class="n">number1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max1</span><span class="p">)</span>
      <span class="n">product1</span> <span class="o">=</span> <span class="n">number1</span> <span class="o">*</span> <span class="n">spaces1</span>
      <span class="n">key1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">product1</span><span class="p">)</span>
      <span class="n">rchars</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mh">0x21</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mh">0x2f</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mh">0x3a</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mh">0x7e</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)):</span>
         <span class="n">p</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
         <span class="n">key1</span> <span class="o">=</span> <span class="n">key1</span><span class="p">[:</span><span class="n">p</span><span class="p">]</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">rchars</span><span class="p">))</span> <span class="o">+</span> <span class="n">key1</span><span class="p">[</span><span class="n">p</span><span class="p">:]</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">spaces1</span><span class="p">):</span>
         <span class="n">p</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
         <span class="n">key1</span> <span class="o">=</span> <span class="n">key1</span><span class="p">[:</span><span class="n">p</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">key1</span><span class="p">[</span><span class="n">p</span><span class="p">:]</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">number1</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">startHandshake</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Start WebSocket opening handshake.</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="c">## construct WS opening handshake HTTP header</span>
      <span class="c">##</span>
      <span class="n">request</span>  <span class="o">=</span> <span class="s">&quot;GET </span><span class="si">%s</span><span class="s"> HTTP/1.1</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">resource</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">useragent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">useragent</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
         <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;User-Agent: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">useragent</span>

      <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Host: </span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
      <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Upgrade: WebSocket</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>
      <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Connection: Upgrade</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>

      <span class="c">## this seems to prohibit some non-compliant proxies from removing the</span>
      <span class="c">## connection &quot;Upgrade&quot; header</span>
      <span class="c">## See also:</span>
      <span class="c">##   http://www.ietf.org/mail-archive/web/hybi/current/msg09841.html</span>
      <span class="c">##   http://code.google.com/p/chromium/issues/detail?id=148908</span>
      <span class="c">##</span>
      <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Pragma: no-cache</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>
      <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Cache-Control: no-cache</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>

      <span class="c">## optional, user supplied additional HTTP headers</span>
      <span class="c">##</span>
      <span class="k">for</span> <span class="n">uh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
         <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uh</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

      <span class="c">## handshake random key</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">websocket_key1</span><span class="p">,</span> <span class="n">number1</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createHixieKey</span><span class="p">()</span>
         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">websocket_key2</span><span class="p">,</span> <span class="n">number2</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createHixieKey</span><span class="p">()</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">websocket_key3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
         <span class="n">accept_val</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&gt;II&quot;</span><span class="p">,</span> <span class="n">number1</span><span class="p">,</span> <span class="n">number2</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_key3</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">websocket_expected_challenge_response</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">accept_val</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

         <span class="c">## Safari does NOT set Content-Length, even though the body is</span>
         <span class="c">## non-empty, and the request unchunked. We do it.</span>
         <span class="c">## See also: http://www.ietf.org/mail-archive/web/hybi/current/msg02149.html</span>
         <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Content-Length: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">websocket_key3</span><span class="p">)</span>

         <span class="c">## First two keys.</span>
         <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Key1: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_key1</span>
         <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Key2: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_key2</span>
         <span class="n">request_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_key3</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">websocket_key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
         <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Key: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
         <span class="n">request_body</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c">## optional origin announced</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">origin</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Origin: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">origin</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Origin: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">origin</span>

      <span class="c">## optional list of WS subprotocols announced</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">protocols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Protocol: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">protocols</span><span class="p">)</span>

      <span class="c">## extensions</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">extensions</span> <span class="o">=</span> <span class="p">[]</span>

         <span class="c">## permessage-compress offers</span>
         <span class="c">##</span>
         <span class="k">for</span> <span class="n">offer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionOffers</span><span class="p">:</span>
            <span class="n">extensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offer</span><span class="o">.</span><span class="n">getExtensionString</span><span class="p">())</span>

         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Extensions: </span><span class="si">%s</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>

      <span class="c">## set WS protocol version depending on WS spec version</span>
      <span class="c">##</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;Sec-WebSocket-Version: </span><span class="si">%d</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SPEC_TO_PROTOCOL_VERSION</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">]</span>

      <span class="n">request</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x0d\x0a</span><span class="s">&quot;</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">http_request_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_request_data</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">request_body</span><span class="p">:</span>
         <span class="c">## Write HTTP request body for Hixie-76</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">sendData</span><span class="p">(</span><span class="n">request_body</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">processHandshake</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Process WebSocket opening handshake response from server.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">## only proceed when we have fully received the HTTP request line and all headers</span>
      <span class="c">##</span>
      <span class="n">end_of_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;</span><span class="se">\x0d\x0a\x0d\x0a</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">end_of_header</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">http_response_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;received HTTP response:</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_response_data</span><span class="p">)</span>

         <span class="c">## extract HTTP status line and headers</span>
         <span class="c">##</span>
         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_status_line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">,</span> <span class="n">http_headers_cnt</span><span class="p">)</span> <span class="o">=</span> <span class="n">parseHttpHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_response_data</span><span class="p">)</span>

         <span class="c">## validate WebSocket opening handshake server response</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;received HTTP status line in opening handshake : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_status_line</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;received HTTP headers in opening handshake : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">))</span>

         <span class="c">## Response Line</span>
         <span class="c">##</span>
         <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_status_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;Bad HTTP response status line &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_status_line</span><span class="p">)</span>

         <span class="c">## HTTP version</span>
         <span class="c">##</span>
         <span class="n">http_version</span> <span class="o">=</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
         <span class="k">if</span> <span class="n">http_version</span> <span class="o">!=</span> <span class="s">&quot;HTTP/1.1&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;Unsupported HTTP version (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">http_version</span><span class="p">)</span>

         <span class="c">## HTTP status code</span>
         <span class="c">##</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
         <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;Bad HTTP status code (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
         <span class="k">if</span> <span class="n">status_code</span> <span class="o">!=</span> <span class="n">http</span><span class="o">.</span><span class="n">SWITCHING_PROTOCOLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

            <span class="c">## FIXME: handle redirects</span>
            <span class="c">## FIXME: handle authentication required</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
               <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot; - </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;WebSocket connection upgrade failed (</span><span class="si">%d%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>

         <span class="c">## Upgrade</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;upgrade&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Upgrade header missing&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;upgrade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&quot;websocket&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Upgrade header different from &#39;websocket&#39; (case-insensitive) : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;upgrade&quot;</span><span class="p">])</span>

         <span class="c">## Connection</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;connection&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Connection header missing&quot;</span><span class="p">)</span>
         <span class="n">connectionUpgrade</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;connection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;upgrade&quot;</span><span class="p">:</span>
               <span class="n">connectionUpgrade</span> <span class="o">=</span> <span class="bp">True</span>
               <span class="k">break</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="n">connectionUpgrade</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Connection header does not include &#39;upgrade&#39; value (case-insensitive) : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;connection&quot;</span><span class="p">])</span>

         <span class="c">## compute Sec-WebSocket-Accept</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;sec-websocket-accept&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Sec-WebSocket-Accept header missing in opening handshake reply&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">http_headers_cnt</span><span class="p">[</span><span class="s">&quot;sec-websocket-accept&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Sec-WebSocket-Accept header appears more than once in opening handshake reply&quot;</span><span class="p">)</span>
               <span class="n">sec_websocket_accept_got</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;sec-websocket-accept&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

               <span class="n">sha1</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
               <span class="n">sha1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">websocket_key</span> <span class="o">+</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">_WS_MAGIC</span><span class="p">)</span>
               <span class="n">sec_websocket_accept</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">sha1</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

               <span class="k">if</span> <span class="n">sec_websocket_accept_got</span> <span class="o">!=</span> <span class="n">sec_websocket_accept</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Sec-WebSocket-Accept bogus value : expected </span><span class="si">%s</span><span class="s"> / got </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sec_websocket_accept</span><span class="p">,</span> <span class="n">sec_websocket_accept_got</span><span class="p">))</span>

         <span class="c">## Sec-WebSocket-Extensions</span>
         <span class="c">##</span>

         <span class="c">## extensions effectively in use for this connection</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">websocket_extensions_in_use</span> <span class="o">=</span> <span class="p">[]</span>

         <span class="k">if</span> <span class="s">&#39;sec-websocket-extensions&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Sec-WebSocket-Extensions header encountered for Hixie-76&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">http_headers_cnt</span><span class="p">[</span><span class="s">&quot;sec-websocket-extensions&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Sec-WebSocket-Extensions header appears more than once in opening handshake reply&quot;</span><span class="p">)</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="c">## extensions select by server</span>
                  <span class="c">##</span>
                  <span class="n">websocket_extensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseExtensionsHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;sec-websocket-extensions&quot;</span><span class="p">])</span>

            <span class="c">## process extensions selected by server</span>
            <span class="c">##</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="ow">in</span> <span class="n">websocket_extensions</span><span class="p">:</span>

               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;parsed WebSocket extension &#39;</span><span class="si">%s</span><span class="s">&#39; with params &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>

               <span class="c">## process permessage-compress extension</span>
               <span class="c">##</span>
               <span class="k">if</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">PERMESSAGE_COMPRESSION_EXTENSION</span><span class="p">:</span>

                  <span class="c">## check that server only responded with 1 configuration (&quot;PMCE&quot;)</span>
                  <span class="c">##</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;multiple occurence of a permessage-compress extension&quot;</span><span class="p">)</span>

                  <span class="n">PMCE</span> <span class="o">=</span> <span class="n">PERMESSAGE_COMPRESSION_EXTENSION</span><span class="p">[</span><span class="n">extension</span><span class="p">]</span>

                  <span class="k">try</span><span class="p">:</span>
                     <span class="n">pmceResponse</span> <span class="o">=</span> <span class="n">PMCE</span><span class="p">[</span><span class="s">&#39;Response&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

                  <span class="n">accept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionAccept</span><span class="p">(</span><span class="n">pmceResponse</span><span class="p">)</span>

                  <span class="k">if</span> <span class="n">accept</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;WebSocket permessage-compress extension response from server denied by client&quot;</span><span class="p">)</span>

                  <span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span> <span class="o">=</span> <span class="n">PMCE</span><span class="p">[</span><span class="s">&#39;PMCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">createFromResponseAccept</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">isServer</span><span class="p">,</span> <span class="n">accept</span><span class="p">)</span>

                  <span class="bp">self</span><span class="o">.</span><span class="n">websocket_extensions_in_use</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perMessageCompress</span><span class="p">)</span>

               <span class="k">else</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;server wants to use extension &#39;</span><span class="si">%s</span><span class="s">&#39; we did not request, haven&#39;t implemented or did not enable&quot;</span> <span class="o">%</span> <span class="n">extension</span><span class="p">)</span>

         <span class="c">## handle &quot;subprotocol in use&quot; - if any</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">websocket_protocol_in_use</span> <span class="o">=</span> <span class="bp">None</span>
         <span class="k">if</span> <span class="s">&#39;sec-websocket-protocol&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">http_headers_cnt</span><span class="p">[</span><span class="s">&quot;sec-websocket-protocol&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;HTTP Sec-WebSocket-Protocol header appears more than once in opening handshake reply&quot;</span><span class="p">)</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">[</span><span class="s">&quot;sec-websocket-protocol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">sp</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">sp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">protocols</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;subprotocol selected by server (</span><span class="si">%s</span><span class="s">) not in subprotocol list requested by client (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">protocols</span><span class="p">)))</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="c">## ok, subprotocol in use</span>
                  <span class="c">##</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">websocket_protocol_in_use</span> <span class="o">=</span> <span class="n">sp</span>

         <span class="c">## For Hixie-76, we need 16 octets of HTTP request body to complete HS!</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">16</span><span class="p">:</span>
               <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">challenge_response</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
               <span class="k">if</span> <span class="n">challenge_response</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_expected_challenge_response</span><span class="p">:</span>
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failHandshake</span><span class="p">(</span><span class="s">&quot;invalid challenge response received from server (Hixie-76)&quot;</span><span class="p">)</span>

         <span class="c">## Ok, got complete HS input, remember rest (if any)</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">16</span><span class="p">:]</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">end_of_header</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:]</span>

         <span class="c">## opening handshake completed, move WebSocket connection into OPEN state</span>
         <span class="c">##</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">STATE_OPEN</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">inside_message</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">=</span> <span class="bp">None</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">websocket_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>

         <span class="c">## we handle this symmetrical to server-side .. that is, give the</span>
         <span class="c">## client a chance to bail out .. i.e. on no subprotocol selected</span>
         <span class="c">## by server</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">ConnectionResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peer</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">http_headers</span><span class="p">,</span>
                                          <span class="bp">None</span><span class="p">,</span> <span class="c"># FIXME</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">websocket_protocol_in_use</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">websocket_extensions_in_use</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_onConnect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c">## immediately close the WS connection</span>
            <span class="c">##</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failConnection</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="c">## fire handler on derived class</span>
            <span class="c">##</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">trackedTimings</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="s">&quot;onOpen&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_onOpen</span><span class="p">()</span>

         <span class="c">## process rest, if any</span>
         <span class="c">##</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumeData</span><span class="p">()</span>


   <span class="k">def</span> <span class="nf">failHandshake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      During opening handshake the server response is invalid and we drop the</span>
<span class="sd">      connection.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;failing WebSocket opening handshake (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">reason</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dropConnection</span><span class="p">(</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="WebSocketClientFactory"><a class="viewcode-back" href="../../../websocketclient.html#autobahn.websocket.protocol.WebSocketClientFactory">[docs]</a><span class="k">class</span> <span class="nc">WebSocketClientFactory</span><span class="p">(</span><span class="n">WebSocketFactory</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   A protocol factory for WebSocket clients.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">protocol</span> <span class="o">=</span> <span class="n">WebSocketClientProtocol</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   The protocol to be spoken. Must be derived from :class:`autobahn.websocket.protocol.WebSocketClientProtocol`.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">isServer</span> <span class="o">=</span> <span class="bp">False</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Flag indicating if this factory is client- or server-side.</span>
<span class="sd">   &quot;&quot;&quot;</span>


<div class="viewcode-block" id="WebSocketClientFactory.__init__"><a class="viewcode-back" href="../../../websocketclient.html#autobahn.websocket.protocol.WebSocketClientFactory.__init__">[docs]</a>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">url</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                <span class="n">protocols</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="n">useragent</span> <span class="o">=</span> <span class="s">&quot;AutobahnPython/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">__version__</span><span class="p">,</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{},</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">debugCodePaths</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Create instance of WebSocket client factory.</span>

<span class="sd">      Note that you MUST provide URL either here or set using</span>
<span class="sd">      :meth:`autobahn.websocket.WebSocketClientFactory.setSessionParameters`</span>
<span class="sd">      *before* the factory is started.</span>

<span class="sd">      :param url: WebSocket URL this factory will connect to, e.g. `ws://myhost.com/somepath?param1=23`.</span>
<span class="sd">                  For non-TCP transports like pipes or Unix domain sockets, provide `None`.</span>
<span class="sd">                  This will use an implicit URL of `ws://localhost`.</span>
<span class="sd">      :type url: str</span>
<span class="sd">      :param origin: The origin to be sent in WebSocket opening handshake or None (default: `None`).</span>
<span class="sd">      :type origin: str</span>
<span class="sd">      :param protocols: List of subprotocols the client should announce in WebSocket opening handshake (default: `[]`).</span>
<span class="sd">      :type protocols: list of strings</span>
<span class="sd">      :param useragent: User agent as announced in HTTP request header or None (default: `AutobahnWebSocket/?.?.?`).</span>
<span class="sd">      :type useragent: str</span>
<span class="sd">      :param headers: An optional mapping of additional HTTP headers to send during the WebSocket opening handshake.</span>
<span class="sd">      :type headers: dict</span>
<span class="sd">      :param proxy: Explicit proxy server to use (`hostname:port` or `IP:port`), e.g. `192.168.1.100:8080`.</span>
<span class="sd">      :type proxy: str</span>
<span class="sd">      :param debug: Debug mode (default: `False`).</span>
<span class="sd">      :type debug: bool</span>
<span class="sd">      :param debugCodePaths: Debug code paths mode (default: `False`).</span>
<span class="sd">      :type debugCodePaths: bool</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">debugCodePaths</span> <span class="o">=</span> <span class="n">debugCodePaths</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">logOctets</span> <span class="o">=</span> <span class="n">debug</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">logFrames</span> <span class="o">=</span> <span class="n">debug</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">trackTimings</span> <span class="o">=</span> <span class="bp">False</span>

      <span class="c">## seed RNG which is used for WS opening handshake key and WS frame masks generation</span>
      <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>

      <span class="c">## default WS session parameters</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setSessionParameters</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">protocols</span><span class="p">,</span> <span class="n">useragent</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">proxy</span><span class="p">)</span>

      <span class="c">## default WebSocket protocol options</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">resetProtocolOptions</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="WebSocketClientFactory.setSessionParameters"><a class="viewcode-back" href="../../../websocketclient.html#autobahn.websocket.protocol.WebSocketClientFactory.setSessionParameters">[docs]</a>   <span class="k">def</span> <span class="nf">setSessionParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">url</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                            <span class="n">origin</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                            <span class="n">protocols</span> <span class="o">=</span> <span class="p">[],</span>
                            <span class="n">useragent</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                            <span class="n">headers</span> <span class="o">=</span> <span class="p">{},</span>
                            <span class="n">proxy</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Set WebSocket session parameters.</span>

<span class="sd">      :param url: WebSocket URL this factory will connect to, e.g. `ws://myhost.com/somepath?param1=23`.</span>
<span class="sd">                  For non-TCP transports like pipes or Unix domain sockets, provide `None`.</span>
<span class="sd">                  This will use an implicit URL of `ws://localhost`.</span>
<span class="sd">      :type url: str</span>
<span class="sd">      :param origin: The origin to be sent in opening handshake.</span>
<span class="sd">      :type origin: str</span>
<span class="sd">      :param protocols: List of WebSocket subprotocols the client should announce in opening handshake.</span>
<span class="sd">      :type protocols: list of strings</span>
<span class="sd">      :param useragent: User agent as announced in HTTP request header during opening handshake.</span>
<span class="sd">      :type useragent: str</span>
<span class="sd">      :param headers: An optional mapping of additional HTTP headers to send during the WebSocket opening handshake.</span>
<span class="sd">      :type headers: dict</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c">## parse WebSocket URI into components</span>
      <span class="p">(</span><span class="n">isSecure</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">=</span> <span class="n">parseWsUrl</span><span class="p">(</span><span class="n">url</span> <span class="ow">or</span> <span class="s">&quot;ws://localhost&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">isSecure</span> <span class="o">=</span> <span class="n">isSecure</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="o">=</span> <span class="n">protocols</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">useragent</span> <span class="o">=</span> <span class="n">useragent</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span> <span class="o">=</span> <span class="n">proxy</span>

</div>
<div class="viewcode-block" id="WebSocketClientFactory.resetProtocolOptions"><a class="viewcode-back" href="../../../websocketclient.html#autobahn.websocket.protocol.WebSocketClientFactory.resetProtocolOptions">[docs]</a>   <span class="k">def</span> <span class="nf">resetProtocolOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Reset all WebSocket protocol options to defaults.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">DEFAULT_SPEC_VERSION</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">allowHixie76</span> <span class="o">=</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">DEFAULT_ALLOW_HIXIE76</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncoming</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">acceptMaskedServerFrames</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">maskClientFrames</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">maxFramePayloadSize</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">autoFragmentSize</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">failByDrop</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">echoCloseCodeReason</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">serverConnectionDropTimeout</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeout</span> <span class="o">=</span> <span class="mi">5</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeout</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">tcpNoDelay</span> <span class="o">=</span> <span class="bp">True</span>

      <span class="c">## permessage-XXX extensions</span>
      <span class="c">##</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionOffers</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionAccept</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="WebSocketClientFactory.setProtocolOptions"><a class="viewcode-back" href="../../../websocketclient.html#autobahn.websocket.protocol.WebSocketClientFactory.setProtocolOptions">[docs]</a>   <span class="k">def</span> <span class="nf">setProtocolOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">version</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">allowHixie76</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">utf8validateIncoming</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">acceptMaskedServerFrames</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">maskClientFrames</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">applyMask</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">maxFramePayloadSize</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">maxMessagePayloadSize</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">autoFragmentSize</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">failByDrop</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">echoCloseCodeReason</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">serverConnectionDropTimeout</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">openHandshakeTimeout</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">closeHandshakeTimeout</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">tcpNoDelay</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">perMessageCompressionOffers</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">perMessageCompressionAccept</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Set WebSocket protocol options used as defaults for _new_ protocol instances.</span>

<span class="sd">      :param version: The WebSocket protocol spec (draft) version to be used (default: :func:`autobahn.websocket.protocol.WebSocketProtocol.SUPPORTED_PROTOCOL_VERSIONS`).</span>
<span class="sd">      :param utf8validateIncoming: Validate incoming UTF-8 in text message payloads (default: `True`).</span>
<span class="sd">      :type utf8validateIncoming: bool</span>
<span class="sd">      :param acceptMaskedServerFrames: Accept masked server-to-client frames (default: `False`).</span>
<span class="sd">      :type acceptMaskedServerFrames: bool</span>
<span class="sd">      :param maskClientFrames: Mask client-to-server frames (default: `True`).</span>
<span class="sd">      :type maskClientFrames: bool</span>
<span class="sd">      :param applyMask: Actually apply mask to payload when mask it present. Applies for outgoing and incoming frames (default: `True`).</span>
<span class="sd">      :type applyMask: bool</span>
<span class="sd">      :param maxFramePayloadSize: Maximum frame payload size that will be accepted when receiving or `0` for unlimited (default: `0`).</span>
<span class="sd">      :type maxFramePayloadSize: int</span>
<span class="sd">      :param maxMessagePayloadSize: Maximum message payload size (after reassembly of fragmented messages) that will be accepted when receiving or `0` for unlimited (default: `0`).</span>
<span class="sd">      :type maxMessagePayloadSize: int</span>
<span class="sd">      :param autoFragmentSize: Automatic fragmentation of outgoing data messages (when using the message-based API) into frames with payload length `&lt;=` this size or `0` for no auto-fragmentation (default: `0`).</span>
<span class="sd">      :type autoFragmentSize: int</span>
<span class="sd">      :param failByDrop: Fail connections by dropping the TCP connection without performing closing handshake (default: `True`).</span>
<span class="sd">      :type failbyDrop: bool</span>
<span class="sd">      :param echoCloseCodeReason: Iff true, when receiving a close, echo back close code/reason. Otherwise reply with `code == 1000, reason = &quot;&quot;` (default: `False`).</span>
<span class="sd">      :type echoCloseCodeReason: bool</span>
<span class="sd">      :param serverConnectionDropTimeout: When the client expects the server to drop the TCP, timeout in seconds (default: `1`).</span>
<span class="sd">      :type serverConnectionDropTimeout: float</span>
<span class="sd">      :param openHandshakeTimeout: Opening WebSocket handshake timeout, timeout in seconds or `0` to deactivate (default: `0`).</span>
<span class="sd">      :type openHandshakeTimeout: float</span>
<span class="sd">      :param closeHandshakeTimeout: When we expect to receive a closing handshake reply, timeout in seconds (default: `1`).</span>
<span class="sd">      :type closeHandshakeTimeout: float</span>
<span class="sd">      :param tcpNoDelay: TCP NODELAY (&quot;Nagle&quot;): bool socket option (default: `True`).</span>
<span class="sd">      :type tcpNoDelay: bool</span>
<span class="sd">      :param perMessageCompressionOffers: A list of offers to provide to the server for the permessage-compress WebSocket extension. Must be a list of instances of subclass of PerMessageCompressOffer.</span>
<span class="sd">      :type perMessageCompressionOffers: list of instance of subclass of PerMessageCompressOffer</span>
<span class="sd">      :param perMessageCompressionAccept: Acceptor function for responses.</span>
<span class="sd">      :type perMessageCompressionAccept: callable</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">allowHixie76</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">allowHixie76</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowHixie76</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">allowHixie76</span> <span class="o">=</span> <span class="n">allowHixie76</span>

      <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SUPPORTED_SPEC_VERSIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid WebSocket draft version </span><span class="si">%s</span><span class="s"> (allowed values: </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">WebSocketProtocol</span><span class="o">.</span><span class="n">SUPPORTED_SPEC_VERSIONS</span><span class="p">)))</span>
         <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowHixie76</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;use of Hixie-76 requires allowHixie76 == True&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>

      <span class="k">if</span> <span class="n">utf8validateIncoming</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">utf8validateIncoming</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncoming</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">utf8validateIncoming</span> <span class="o">=</span> <span class="n">utf8validateIncoming</span>

      <span class="k">if</span> <span class="n">acceptMaskedServerFrames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">acceptMaskedServerFrames</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptMaskedServerFrames</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">acceptMaskedServerFrames</span> <span class="o">=</span> <span class="n">acceptMaskedServerFrames</span>

      <span class="k">if</span> <span class="n">maskClientFrames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">maskClientFrames</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maskClientFrames</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">maskClientFrames</span> <span class="o">=</span> <span class="n">maskClientFrames</span>

      <span class="k">if</span> <span class="n">applyMask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">applyMask</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span> <span class="o">=</span> <span class="n">applyMask</span>

      <span class="k">if</span> <span class="n">maxFramePayloadSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">maxFramePayloadSize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxFramePayloadSize</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">maxFramePayloadSize</span> <span class="o">=</span> <span class="n">maxFramePayloadSize</span>

      <span class="k">if</span> <span class="n">maxMessagePayloadSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">maxMessagePayloadSize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">maxMessagePayloadSize</span> <span class="o">=</span> <span class="n">maxMessagePayloadSize</span>

      <span class="k">if</span> <span class="n">autoFragmentSize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">autoFragmentSize</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoFragmentSize</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">autoFragmentSize</span> <span class="o">=</span> <span class="n">autoFragmentSize</span>

      <span class="k">if</span> <span class="n">failByDrop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">failByDrop</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failByDrop</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">failByDrop</span> <span class="o">=</span> <span class="n">failByDrop</span>

      <span class="k">if</span> <span class="n">echoCloseCodeReason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">echoCloseCodeReason</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">echoCloseCodeReason</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">echoCloseCodeReason</span> <span class="o">=</span> <span class="n">echoCloseCodeReason</span>

      <span class="k">if</span> <span class="n">serverConnectionDropTimeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">serverConnectionDropTimeout</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverConnectionDropTimeout</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">serverConnectionDropTimeout</span> <span class="o">=</span> <span class="n">serverConnectionDropTimeout</span>

      <span class="k">if</span> <span class="n">openHandshakeTimeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">openHandshakeTimeout</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeout</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">openHandshakeTimeout</span> <span class="o">=</span> <span class="n">openHandshakeTimeout</span>

      <span class="k">if</span> <span class="n">closeHandshakeTimeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">closeHandshakeTimeout</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeout</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">closeHandshakeTimeout</span> <span class="o">=</span> <span class="n">closeHandshakeTimeout</span>

      <span class="k">if</span> <span class="n">tcpNoDelay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tcpNoDelay</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcpNoDelay</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">tcpNoDelay</span> <span class="o">=</span> <span class="n">tcpNoDelay</span>

      <span class="k">if</span> <span class="n">perMessageCompressionOffers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">perMessageCompressionOffers</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionOffers</span><span class="p">):</span>
         <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">perMessageCompressionOffers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="c">##</span>
            <span class="c">## FIXME: more rigorous verification of passed argument</span>
            <span class="c">##</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionOffers</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">perMessageCompressionOffers</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;invalid type </span><span class="si">%s</span><span class="s"> for perMessageCompressionOffers - expected list&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">perMessageCompressionOffers</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">perMessageCompressionAccept</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">perMessageCompressionAccept</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionAccept</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">perMessageCompressionAccept</span> <span class="o">=</span> <span class="n">perMessageCompressionAccept</span></div></div>
</pre></div>

          <footer>
  

  <hr/>

  <p>
      &copy; Copyright 2011-2014 Tavendo GmbH.
  </p>

  <a href="https://www.github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="http://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  

</body>
</html>